
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="د.محمد مدحت">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#10b981">
    <title>د.محمد مدحت - الروشتات الطبية v2.0</title>
    <!-- VERSION 2.0 - FIXED SETTINGS MENU NAMES -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        :root {
            --primary: #10b981;
            --primary-light: #6ee7b7;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --secondary-light: #93c5fd;
            --bg-main: #f0fdf4;
            --bg-card: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border: #d1fae5;
            --shadow: rgba(16, 185, 129, 0.1);
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body.dark-mode {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --secondary-light: #a78bfa;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --text-dark: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.5);
            --danger: #ef4444;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #0a0e1a 0%, #1e293b 100%);
        }
        
        body.modal-open {
            height: 100vh;
            overflow-y: scroll; /* Keep scrollbar visible */
            position: fixed; /* Prevent actual scrolling */
            width: 100%;
        }
        
        body.modal-open .main-content {
            /* Main content stays scrollable in modal */
        }

        /* Theme: Light (Default) */
        body.theme-light {
            --primary: #10b981;
            --primary-light: #6ee7b7;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --secondary-light: #93c5fd;
            --bg-main: #f0fdf4;
            --bg-card: #ffffff;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border: #d1fae5;
            --shadow: rgba(16, 185, 129, 0.1);
            --danger: #ef4444;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
        }

        /* Theme: Dark */
        body.theme-dark {
            --primary: #10b981;
            --primary-light: #34d399;
            --primary-dark: #059669;
            --secondary: #60a5fa;
            --secondary-light: #93c5fd;
            --bg-main: #111827;
            --bg-card: #1f2937;
            --text-dark: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
            --danger: #ef4444;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        /* Theme: Mint Fresh */
        body.theme-mint {
            --primary: #14b8a6;
            --primary-light: #5eead4;
            --primary-dark: #0d9488;
            --secondary: #06b6d4;
            --secondary-light: #67e8f9;
            --bg-main: #f0fdfa;
            --bg-card: #ccfbf1;
            --text-dark: #134e4a;
            --text-light: #6b7280;
            --border: #99f6e4;
            --shadow: rgba(20, 184, 166, 0.15);
            --danger: #ef4444;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
        }

        /* Theme: Rose Pink */
        body.theme-rose {
            --primary: #f43f5e;
            --primary-light: #fb7185;
            --primary-dark: #e11d48;
            --secondary: #ec4899;
            --secondary-light: #f9a8d4;
            --bg-main: #fff1f2;
            --bg-card: #ffe4e6;
            --text-dark: #881337;
            --text-light: #78716c;
            --border: #fecdd3;
            --shadow: rgba(244, 63, 94, 0.15);
            --danger: #dc2626;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%);
        }

        /* Theme: Sky Blue */
        body.theme-sky {
            --primary: #0ea5e9;
            --primary-light: #7dd3fc;
            --primary-dark: #0284c7;
            --secondary: #06b6d4;
            --secondary-light: #67e8f9;
            --bg-main: #f0f9ff;
            --bg-card: #e0f2fe;
            --text-dark: #0c4a6e;
            --text-light: #475569;
            --border: #bae6fd;
            --shadow: rgba(14, 165, 233, 0.15);
            --danger: #ef4444;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        /* Theme: Amber Gold */
        body.theme-amber {
            --primary: #f59e0b;
            --primary-light: #fbbf24;
            --primary-dark: #d97706;
            --secondary: #f97316;
            --secondary-light: #fb923c;
            --bg-main: #fffbeb;
            --bg-card: #fef3c7;
            --text-dark: #78350f;
            --text-light: #78716c;
            --border: #fde68a;
            --shadow: rgba(245, 158, 11, 0.15);
            --danger: #dc2626;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        /* Theme: Lavender Purple */
        body.theme-lavender {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #7c3aed;
            --secondary: #ec4899;
            --secondary-light: #f9a8d4;
            --bg-main: #faf5ff;
            --bg-card: #f3e8ff;
            --text-dark: #581c87;
            --text-light: #6b7280;
            --border: #e9d5ff;
            --shadow: rgba(139, 92, 246, 0.15);
            --danger: #ef4444;
            --warning: #f59e0b;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--bg-main) 0%, #ecfeff 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 20px;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 30px 40px;
            border-radius: 24px;
            margin-top: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        #settingsButtonContainer {
            right: 20px;
        }
        
        [dir="ltr"] #settingsButtonContainer {
            right: auto;
            left: 20px;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            border-radius: 50%;
        }

        header h1 {
            color: white;
            font-size: 3em;
            font-weight: 700;
            font-family: 'Cairo', sans-serif;
            margin-bottom: 10px;
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        header h1:hover {
            transform: translateX(-5px);
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
            font-family: 'Cairo', sans-serif;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        header p:hover {
            transform: translateX(-5px);
            text-shadow: 0 0 15px rgba(255,255,255,0.2);
        }

        .dark-mode-toggle {
            position: absolute;
            top: 30px;
            left: 40px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .dark-mode-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .theme-selector {
            position: absolute;
            top: 30px;
            left: 40px;
            z-index: 100;
        }

        .theme-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-button:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }
        
        .favorites-btn:hover {
            background: rgba(251, 191, 36, 0.3);
            transform: scale(1.1);
        }
        
        .favorites-btn:active {
            transform: scale(0.95);
        }

        .settings-toggle {
            position: absolute;
            top: 30px;
            left: 260px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .settings-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .theme-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .theme-card {
            padding: 25px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            text-align: center;
            position: relative;
        }
        
        .settings-menu-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--bg-main) 0%, white 100%);
            border: 2px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            text-align: right;
        }
        
        .settings-menu-btn:hover {
            transform: translateX(-5px);
            border-color: var(--primary);
            box-shadow: 0 5px 15px var(--shadow);
        }
        
        .settings-icon {
            font-size: 2em;
            min-width: 50px;
            text-align: center;
        }
        
        .settings-text {
            flex: 1;
            text-align: right;
        }
        
        .settings-text h3 {
            color: var(--text-dark);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .settings-text p {
            color: var(--text-light);
            font-size: 0.9em;
            margin: 0;
        }
        
        .settings-arrow {
            font-size: 1.5em;
            color: var(--primary);
        }

        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .theme-card.active {
            border: 3px solid var(--primary);
            box-shadow: 0 0 0 5px rgba(16, 185, 129, 0.3);
            transform: scale(1.05);
        }

        .theme-card .theme-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }

        .theme-card .theme-name {
            font-size: 1.1em;
            font-weight: 600;
            color: inherit;
        }

        .theme-card.theme-light {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);
            color: #1f2937;
        }

        .theme-card.theme-dark {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: #f9fafb;
        }

        .theme-card.theme-mint {
            background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);
            color: #134e4a;
        }

        .theme-card.theme-rose {
            background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            color: #881337;
        }

        .theme-card.theme-sky {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e3a8a;
        }

        .theme-card.theme-amber {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #78350f;
        }

        .theme-card.theme-lavender {
            background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
            color: #581c87;
        }

        .edit-app-button {
            position: absolute;
            top: 35px;
            right: 40px;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .edit-app-button:hover {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
            opacity: 1;
        }

        .custom-bg {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }

        .custom-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            opacity: 0.15;
            z-index: -1;
        }

        .background-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .bg-option {
            aspect-ratio: 16/9;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .bg-option:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .bg-option.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .bg-option-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
        }

        .upload-bg-container {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-main);
            border-radius: 12px;
            border: 2px dashed var(--border);
            text-align: center;
        }

        .upload-bg-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-bg-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .image-container {
            position: relative;
            margin: 20px 0;
            border: 2px dashed var(--border);
            border-radius: 12px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-main);
            overflow: hidden;
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            position: absolute;
            cursor: move;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .image-preview.resizing {
            cursor: nwse-resize;
        }

        .image-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .image-control-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s ease;
        }

        .image-control-btn:hover {
            background: rgba(0,0,0,0.9);
            transform: scale(1.1);
        }

        .add-image-btn {
            padding: 12px 24px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: 10px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px auto;
        }

        .add-image-btn:hover {
            background: var(--secondary-light);
            transform: translateY(-2px);
        }

        .image-in-card {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .main-content {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 30px;
            align-items: start;
        }

        .sidebar {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px var(--shadow);
            position: sticky;
            top: 20px;
        }

        .search-box {
            position: relative;
            margin-bottom: 25px;
        }

        .search-box input {
            width: 100%;
            padding: 15px 45px 15px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
            background: var(--bg-main);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 1.2em;
        }

        .category-section h3 {
            color: var(--text-dark);
            font-size: 1.1em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--bg-main);
            padding: 5px;
            border-radius: 12px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: transparent;
            color: var(--text-light);
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white !important;
        }

        .tab-button:hover:not(.active) {
            background: var(--border);
            color: var(--text-dark);
        }

        .section-content-wrapper {
            display: none;
        }

        .section-content-wrapper.active {
            display: block;
        }

        .add-category-btn, .add-prescription-btn {
            width: 100%;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white !important;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-category-btn:hover, .add-prescription-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .category-list {
            max-height: 800px;
            overflow-y: auto;
            padding-left: 5px;
        }

        /* Global Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Category List Scrollbar - smaller */
        .category-list::-webkit-scrollbar {
            width: 6px;
        }

        .category-list::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 10px;
        }

        .category-list::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
        }

        .app-color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .app-color-btn:hover {
            transform: scale(1.1);
        }

        .app-color-btn.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
        }

        .rx-color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .rx-color-btn:hover {
            transform: scale(1.1);
        }

        .rx-color-btn.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
        }

        .app-color-btn2 {
            width: 40px;
            height: 40px;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .app-color-btn2:hover {
            transform: scale(1.1);
        }

        .app-color-btn2.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
        }

        .size-option-btn {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: right;
        }

        .size-option-btn:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
        }

        .size-option-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--bg-card) 100%);
        }

        .size-option-btn h3 {
            color: var(--text-dark);
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .size-option-btn p {
            color: var(--text-light);
            font-size: 0.9em;
        }

        .color-btn.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px white, 0 0 0 4px var(--primary);
        }

        .format-btn {
            width: 30px;
            height: 30px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .format-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .quick-btn {
            width: 35px;
            height: 35px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: var(--text-dark);
        }

        .quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        #prescriptionRxEditor:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
        }

        #prescriptionRxEditor:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--border);
            border-radius: 5px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .category-item {
            padding: 14px 18px;
            margin-bottom: 8px;
            background: var(--bg-main);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 2px solid transparent;
            font-family: 'Cairo', sans-serif;
        }

        .category-item:hover {
            background: var(--primary-light);
            transform: translateX(-5px);
        }

        .category-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white !important;
            border-color: var(--primary-dark);
        }
        
        .category-item.active * {
            color: white !important;
        }

        .category-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .category-count {
            background: rgba(255,255,255,0.3);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .category-item.active .category-count {
            background: rgba(255,255,255,0.3);
            color: white !important;
        }

        .delete-category-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .category-item:hover .delete-category-btn {
            opacity: 1;
        }

        .category-item.active .delete-category-btn {
            color: white;
            opacity: 0.8;
        }

        .category-item.active .delete-category-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.2);
        }

        .delete-category-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .content-area {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 10px 40px var(--shadow);
            min-height: 500px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .content-header h2 {
            font-size: 1.8em;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .prescriptions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 20px;
            width: 100%;
            align-items: start;
            grid-auto-rows: auto;
        }

        .prescription-card {
            background: linear-gradient(135deg, var(--bg-main) 0%, white 100%);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            padding-top: 50px;
            cursor: pointer;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            display: block;
            width: 100%;
            height: auto;
            min-height: 250px;
            box-sizing: border-box;
            margin: 0;
            float: none;
            clear: both;
        }

        .prescription-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
            border-radius: 16px 0 0 16px;
        }

        .prescription-card:hover {
            box-shadow: 0 8px 25px var(--shadow);
            border-color: var(--primary);
        }

        .prescription-card:hover::before {
            transform: scaleY(1);
        }
        
        .prescription-card h3 {
            margin: 10px 0;
        }
        
        .prescription-preview {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-card {
            background: linear-gradient(135deg, #fef3c7 0%, white 100%);
            border: 2px solid #fde68a;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--warning) 0%, var(--primary) 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.2);
            border-color: var(--warning);
        }

        .note-card:hover::before {
            transform: scaleY(1);
        }

        .note-card h3 {
            color: var(--warning);
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .note-preview {
            color: var(--text-light);
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 12px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body.dark-mode .note-card {
            background: linear-gradient(135deg, #422006 0%, var(--bg-card) 100%);
            border-color: #78350f;
        }

        .prescription-card h3 {
            color: var(--primary-dark);
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prescription-preview {
            color: var(--text-light);
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 12px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .prescription-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .prescription-actions-mini {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 6px;
            z-index: 5;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 4px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-icon-edit {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-icon-edit:hover {
            background: var(--primary);
            filter: brightness(1.2);
        }
        
        .btn-icon-star {
            border-color: #fbbf24;
            color: #fbbf24;
            font-size: 1.2em;
        }
        
        .btn-icon-star:hover {
            background: #fbbf24;
            filter: brightness(1.2);
        }
        
        .btn-icon-delete {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .btn-icon-delete:hover {
            background: var(--danger);
            filter: brightness(1.2);
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-edit {
            background: var(--secondary-light);
            color: var(--secondary);
        }

        .btn-edit:hover {
            background: var(--secondary);
            color: white;
        }

        .btn-delete {
            background: #fee2e2;
            color: var(--danger);
        }

        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 900px;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 30px 80px rgba(0,0,0,0.3);
            animation: slideUp 0.4s ease;
        }
        
        body.dark-mode .modal-content {
            background: #1e293b;
            box-shadow: 0 30px 80px rgba(0,0,0,0.7);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 10px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.8em;
            color: var(--text-dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2em;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .close-modal:hover {
            background: var(--bg-main);
            color: var(--danger);
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-dark);
            font-weight: 600;
            font-size: 1.05em;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            transition: all 0.3s ease;
            background: var(--bg-main);
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            background: white;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            line-height: 1.8;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-primary {
            flex: 1;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            flex: 1;
            padding: 16px;
            background: var(--bg-main);
            color: var(--text-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--border);
            border-color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: var(--text-dark);
        }

        .empty-state p {
            font-size: 1.1em;
        }

        .view-prescription-modal .prescription-full {
            margin-top: 15px;
            position: relative;
            z-index: 1;
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 10px;
            flex: 1;
        }

        .view-prescription-modal .modal-content {
            position: relative;
            overflow: hidden;
            max-height: 88vh;
            max-width: 90vw;
            width: 900px;
            display: flex;
            flex-direction: column;
        }
        
        /* View Drug Modal - Same size as view prescription */
        .view-drug-modal .modal-content {
            position: relative;
            overflow-y: auto;
            max-height: 88vh;
            max-width: 90vw;
            width: 900px;
        }

        .view-prescription-modal .modal-content.has-category-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.03;
            z-index: 0;
            pointer-events: none;
        }
        
        .view-prescription-modal .modal-header h2 {
            font-size: 1.3em;
            margin: 0;
        }

        .view-prescription-modal .modal-content > * {
            position: relative;
            z-index: 1;
        }

        .view-prescription-modal .section {
            margin-bottom: 30px;
        }

        .view-prescription-modal .prescription-full::-webkit-scrollbar {
            width: 8px;
        }

        .view-prescription-modal .prescription-full::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 10px;
        }

        .view-prescription-modal .prescription-full::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .view-prescription-modal .prescription-full::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .view-prescription-modal .section h3 {
            color: var(--primary-dark);
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .view-prescription-modal .section-content {
            background: var(--bg-main);
            padding: 20px;
            border-radius: 12px;
            line-height: 1.8;
            white-space: pre-wrap;
            font-size: 1.05em;
            color: var(--text-dark);
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }

            header h1 {
                font-size: 1.8em;
            }

            .prescriptions-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Enhanced Mobile & Tablet Responsive Styles */
        @media screen and (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                max-width: 100%;
                height: auto;
                border-left: none;
                border-bottom: 2px solid var(--border);
                overflow-y: visible;
            }
            
            .content-area {
                width: 100%;
                padding: 15px;
            }
            
            .category-list {
                max-height: 200px;
            }
            
            .prescriptions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }
        
        @media screen and (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            header {
                padding: 15px;
            }
            
            header h1 {
                font-size: 1.3em !important;
            }
            
            .modal-content {
                width: 95%;
                max-width: 900px;
                padding: 20px;
                margin: 10px;
            }
            
            .form-group textarea {
                min-height: 120px;
            }
            
            .prescription-card {
                padding: 15px;
            }
            
            .text-toolbar {
                flex-direction: column;
                align-items: stretch !important;
            }
            
            .text-toolbar > * {
                width: 100%;
            }
            
            .text-toolbar select,
            .text-toolbar > div {
                width: 100% !important;
                justify-content: center;
            }
            
            .category-item {
                padding: 12px 15px;
            }
            
            .btn {
                padding: 10px 14px;
                font-size: 0.95em;
            }
            
            /* Fix delete buttons on mobile - CRITICAL */
            .delete-category-btn,
            .prescription-actions button,
            .btn-edit,
            .btn-delete {
                min-height: 48px !important;
                min-width: 48px !important;
                padding: 12px 16px !important;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(16, 185, 129, 0.2);
                cursor: pointer;
            }
            
            .category-item > div:last-child {
                display: flex;
                gap: 10px;
            }
            
            .prescription-actions {
                gap: 12px;
                margin-top: 20px;
            }
        }
        
        @media screen and (max-width: 480px) {
            .prescriptions-grid {
                padding: 0;
            }
            
            .content-area {
                padding: 10px;
            }
            
            .modal-content {
                width: 98%;
                padding: 15px;
            }
            
            .theme-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions button {
                width: 100%;
            }
            
            #prescriptionRxEditor {
                font-size: 14px;
            }
            
            .quick-btn {
                width: 48px;
                height: 48px;
            }
            
            .format-btn {
                width: 40px;
                height: 40px;
            }
        }
        
        /* Touch device optimizations - CRITICAL FOR MOBILE */
        @media (hover: none) and (pointer: coarse) {
            * {
                -webkit-tap-highlight-color: rgba(16, 185, 129, 0.15);
            }
            
            .btn,
            .category-item,
            .prescription-card,
            .note-card,
            .theme-card,
            button,
            .delete-category-btn {
                cursor: pointer;
                -webkit-user-select: none;
                user-select: none;
            }
            
            /* Larger touch targets for all buttons */
            button:not(.close-modal) {
                min-width: 44px;
                min-height: 44px;
            }
            
            /* Prevent zoom on input focus */
            input, textarea, select {
                font-size: 16px !important;
            }
            
            /* Better scrolling on iOS */
            .modal,
            .sidebar,
            .content-area {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* ===== DARK MODE OVERRIDES ===== */
        body.dark-mode .form-group input,
        body.dark-mode .form-group textarea,
        body.dark-mode .form-group select {
            background: #334155;
            color: #f1f5f9;
            border-color: #475569;
        }
        
        body.dark-mode .prescription-card,
        body.dark-mode .note-card,
        body.dark-mode .drug-card {
            background: #1e293b;
            border-color: #334155;
        }
        
        body.dark-mode .search-box input {
            background: #334155;
            color: #f1f5f9;
            border-color: #475569;
        }
        
        body.dark-mode .search-box input::placeholder {
            color: #94a3b8;
        }
        
        body.dark-mode .close-modal {
            background: #334155;
            color: #f1f5f9;
        }
        
        body.dark-mode .close-modal:hover {
            background: #475569;
        }
        
        body.dark-mode .btn-secondary {
            background: #334155;
            color: #f1f5f9;
        }
        
        body.dark-mode .btn-secondary:hover {
            background: #475569;
        }
        
        /* ===== AUTO DIRECTION FOR INPUTS ===== */
        input.ltr-input,
        textarea.ltr-input {
            direction: ltr;
            text-align: left;
        }
        
        input.rtl-input,
        textarea.rtl-input {
            direction: rtl;
            text-align: right;
        }
        
        /* Landscape orientation for phones */
        @media screen and (max-width: 896px) and (orientation: landscape) {
            .sidebar {
                max-height: 150px;
                overflow-y: auto;
            }
            
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }
        
        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            body {
                -webkit-user-select: none;
                -webkit-touch-callout: none;
            }
            
            input, textarea, [contenteditable] {
                -webkit-user-select: text;
            }
        }
    </style>
    <!-- Google Identity Services for Drive Sync -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="container">
        <header style="position: relative;">
            <div id="settingsButtonContainer" style="position: absolute; top: 50%; transform: translateY(-50%); display: flex; gap: 15px; z-index: 10;">
                <!-- Favorites Button -->
                <button class="theme-button favorites-btn" onclick="openFavoritesPopup()" style="min-width: auto; padding: 10px 14px; position: relative;" title="الروشتات المفضلة">
                    <span style="font-size: 1.5em;">⭐</span>
                    <span id="favoritesCount" style="position: absolute; top: -5px; right: -5px; background: #fbbf24; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold;">0</span>
                </button>
                
                <button class="theme-button" onclick="globalRefresh()" style="min-width: auto; padding: 10px 14px;" title="تحديث كل شيء">
                    <span style="font-size: 1.5em;">🔄</span>
                </button>
                
                <button class="theme-button" onclick="openFontSettingsModal()" style="min-width: auto; padding: 10px 14px;" title="تخصيص الخطوط">
                    <span style="font-size: 1.5em;">🔤</span>
                </button>
                <button class="theme-button" onclick="openSettingsMenu()" style="min-width: auto; padding: 10px 14px;" title="الإعدادات">
                    <span style="font-size: 1.5em;">⚙️</span>
                </button>
            </div>
            <h1 onclick="openEditAppModal()">💊 روشتاتي</h1>
            <p onclick="openEditAppModal()">نظام احترافي لإدارة وتنظيم الروشتات الطبية والأدوية</p>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <div class="tabs-container">
                    <button class="tab-button active" onclick="switchTab('prescriptions')">📋 الروشتات</button>
                    <button class="tab-button" onclick="switchTab('drugs')">💊 الأدوية</button>
                    <button class="tab-button" onclick="switchTab('trash')">🗑️</button>
                </div>

                <!-- Prescriptions Section -->
                <div class="section-content-wrapper active" id="prescriptionsSection">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="ابحث في الروشتات..." oninput="renderPrescriptions()">
                        <span class="search-icon">🔍</span>
                    </div>

                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3>📁 الفئات</h3>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="openNotesPopup()" class="quick-btn" style="padding: 6px 10px; font-size: 0.85em;" title="الملاحظات">
                                    📝
                                </button>
                                <button onclick="toggleCategorySort()" class="quick-btn" style="padding: 6px 10px; font-size: 0.85em;" title="تغيير الترتيب">
                                    <span id="sortIcon">🔤</span>
                                </button>
                            </div>
                        </div>
                        <button class="add-category-btn" id="addCategoryMainBtn" onclick="openAddCategoryModal()">
                            ➕ إضافة فئة جديدة
                        </button>
                        <div class="category-list" id="categoryList">
                            <div class="category-item active" data-category="all" onclick="selectCategory('all')">
                                <div class="category-item-content">
                                    <span>📋 كل الروشتات</span>
                                    <span class="category-count" id="allCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Favorites Section -->
                <div class="section-content-wrapper" id="favoritesSection">
                    <div class="search-box">
                        <input type="text" id="searchFavoritesInput" placeholder="ابحث في الروشتات المفضلة..." oninput="renderFavorites()">
                        <span class="search-icon">🔍</span>
                    </div>

                    <div class="category-section">
                        <h3 style="color: var(--text-dark); margin-bottom: 15px;">⭐ المفضلة</h3>
                        <div id="favoritesList" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Favorites list will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Drugs Section -->
                <div class="section-content-wrapper" id="drugsSection">
                    <div class="search-box">
                        <input type="text" id="searchDrugsInput" placeholder="ابحث في الأدوية..." oninput="renderDrugs()">
                        <span class="search-icon">🔍</span>
                    </div>

                    <div class="category-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3>💊 فئات الأدوية</h3>
                        </div>
                        <button class="add-category-btn" onclick="openAddDrugCategoryModal()">
                            ➕ إضافة فئة جديدة
                        </button>
                        <div class="category-list" id="drugCategoryList">
                            <div class="category-item active" data-drug-category="all" onclick="selectDrugCategory('all')">
                                <div class="category-item-content">
                                    <span>💊 كل الأدوية</span>
                                    <span class="category-count" id="allDrugsCount">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trash Section -->
                <div class="section-content-wrapper" id="trashSection">
                    <div class="category-section">
                        <h3 id="trashSectionTitle">🗑️ المحذوفات</h3>
                        <div style="text-align: center; padding: 20px; color: var(--text-light); font-size: 0.95em;">
                            <p><span id="trashPrescLabel">الروشتات المحذوفة:</span> <strong id="trashPrescriptionsCount">0</strong></p>
                            <p><span id="trashCatsLabel">الفئات المحذوفة:</span> <strong id="trashCategoriesCount">0</strong></p>
                            <p><span id="trashNotesLabel">الملاحظات المحذوفة:</span> <strong id="trashNotesCount">0</strong></p>
                        </div>
                        <button id="emptyTrashBtn" class="btn-delete" onclick="emptyTrash()" style="width: 100%; margin-top: 10px; padding: 12px;">
                            🗑️ إفراغ سلة المحذوفات نهائياً
                        </button>
                    </div>
                </div>
            </aside>

            <main class="content-area">
                <div class="content-header">
                    <h2 id="contentTitle">📋 كل الروشتات</h2>
                    <button class="add-prescription-btn" id="addPrescriptionMainBtn" onclick="openAddPrescriptionModal()">
                        ➕ إضافة روشتة جديدة
                    </button>
                    <button class="add-prescription-btn" id="addDrugMainBtn" onclick="openAddDrugModal()" style="display: none;">
                        ➕ إضافة دواء جديد
                    </button>
                </div>

                <div class="prescriptions-grid" id="prescriptionsGrid">
                    <!-- Will be filled by JavaScript -->
                </div>
            </main>
        </div>
    </div>

    <!-- Favorites Popup Modal -->
    <div class="modal" id="favoritesPopup">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>⭐ الروشتات المفضلة</h2>
                <button class="close-modal" onclick="closeFavoritesPopup()">×</button>
            </div>
            <div style="padding: 20px;">
                <div class="search-box" style="margin-bottom: 20px;">
                    <input type="text" id="searchFavoritesPopupInput" placeholder="ابحث في المفضلة..." oninput="renderFavoritesPopup()">
                    <span class="search-icon">🔍</span>
                </div>
                <div id="favoritesPopupGrid" class="prescriptions-grid"></div>
            </div>
        </div>
    </div>

    <!-- Drugs Popup Modal -->
    <div class="modal" id="drugsPopup">
        <div class="modal-content" style="max-width: 1200px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>💊 الأدوية</h2>
                <button class="close-modal" onclick="closeDrugsPopup()">×</button>
            </div>
            <div style="display: flex; gap: 20px; padding: 20px;">
                <!-- Sidebar -->
                <div style="width: 250px; flex-shrink: 0;">
                    <div class="search-box" style="margin-bottom: 15px;">
                        <input type="text" id="searchDrugsPopupInput" placeholder="ابحث..." oninput="renderDrugsPopup()">
                        <span class="search-icon">🔍</span>
                    </div>
                    <button class="add-category-btn" onclick="openAddDrugModal()" style="width: 100%; margin-bottom: 15px;">
                        ➕ إضافة دواء جديد
                    </button>
                    <div id="drugCategoriesPopupList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Categories will be rendered here -->
                    </div>
                </div>
                <!-- Main Grid -->
                <div style="flex: 1;">
                    <div id="drugsPopupGrid" class="prescriptions-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Popup Modal -->
    <div class="modal" id="notesPopup">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>📝 الملاحظات</h2>
                <button class="close-modal" onclick="closeNotesPopup()">×</button>
            </div>
            <div style="padding: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="search-box" style="flex: 1;">
                        <input type="text" id="searchNotesPopupInput" placeholder="ابحث في الملاحظات..." oninput="renderNotesPopup()">
                        <span class="search-icon">🔍</span>
                    </div>
                    <button class="btn-primary" onclick="openAddNoteModal()">
                        ➕ إضافة ملاحظة جديدة
                    </button>
                </div>
                <div id="notesPopupGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Drug Category Modal -->
    <div class="modal" id="drugCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="drugCategoryModalTitle">إضافة فئة أدوية جديدة</h2>
                <button class="close-modal" onclick="closeDrugCategoryModal()">×</button>
            </div>
            <form onsubmit="saveDrugCategory(event)">
                <div class="form-group">
                    <label id="drugCategoryNameLabel">اسم الفئة</label>
                    <input type="text" id="drugCategoryNameInput" placeholder="مثال: مضادات حيوية، مسكنات..." required>
                </div>
                <div class="form-group">
                    <label id="drugCategoryDescLabel">وصف الفئة (اختياري)</label>
                    <input type="text" id="drugCategoryDescInput" placeholder="وصف قصير للفئة">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">💾 حفظ الفئة</button>
                    <button type="button" class="btn-secondary" onclick="closeDrugCategoryModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Drug Modal -->
    <div class="modal" id="drugModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="drugModalTitle">💊 إضافة دواء جديد</h2>
                <button class="close-modal" onclick="closeDrugModal()">×</button>
            </div>
            <form onsubmit="saveDrug(event)">
                <div class="form-group">
                    <label>الاسم التجاري</label>
                    <input type="text" id="drugTradeNameInput" placeholder="مثال: Augmentin" required>
                </div>
                
                <div class="form-group">
                    <label>المادة العلمية</label>
                    <input type="text" id="drugScientificNameInput" placeholder="مثال: Amoxicillin + Clavulanic Acid" required>
                </div>
                
                <div class="form-group">
                    <label>فئة الدواء</label>
                    <select id="drugCategoryInput" required>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
                
                <!-- Image Upload Section -->
                <div class="form-group">
                    <label>صورة الدواء (اختياري)</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn-secondary" onclick="document.getElementById('drugImageInput').click()">
                            📷 رفع صورة
                        </button>
                        <button type="button" class="btn-secondary" onclick="removeDrugImage()" id="removeDrugImageBtn" style="display: none;">
                            🗑️ حذف الصورة
                        </button>
                    </div>
                    <input type="file" id="drugImageInput" accept="image/*" style="display: none;" onchange="handleDrugImageUpload(event)">
                    <div id="drugImagePreview" style="margin-top: 10px; position: relative; display: none;">
                        <img id="drugImagePreviewImg" style="max-width: 100%; border-radius: 8px; border: 2px solid var(--border);">
                        <!-- Image Controls -->
                        <div style="margin-top: 15px; padding: 15px; background: var(--bg-main); border-radius: 8px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;">🎨 تنسيق الصورة:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px;">الحجم: <span id="drugImageScaleValue">100%</span></label>
                                    <input type="range" id="drugImageScaleSlider" min="50" max="200" value="100" 
                                           oninput="updateDrugImageScale(this.value)" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px;">الموضع الأفقي: <span id="drugImageXValue">0</span></label>
                                    <input type="range" id="drugImageXSlider" min="-100" max="100" value="0" 
                                           oninput="updateDrugImagePosition()" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px;">الموضع العمودي: <span id="drugImageYValue">0</span></label>
                                    <input type="range" id="drugImageYSlider" min="-100" max="100" value="0" 
                                           oninput="updateDrugImagePosition()" style="width: 100%;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>جرعة الأطفال</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn-secondary" onclick="openDrugChildDoseTextEditor()" style="margin-bottom: 5px;">
                            ✏️ تنسيق متقدم
                        </button>
                    </div>
                    <div id="drugChildDoseEditor" contenteditable="true" 
                         style="min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-main);"
                         placeholder="مثال: 25-45 mg/kg/day مقسمة على جرعتين"></div>
                    <div id="drugChildDoseTextControls" style="display: none; margin-top: 10px; padding: 10px; background: var(--bg-main); border-radius: 8px;">
                        <!-- Font controls for child dose -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <select onchange="formatDrugChildDoseText('fontName', this.value)" style="padding: 5px;">
                                <option>الخط</option>
                                <option value="Arial">Arial</option>
                                <option value="Cairo">Cairo</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                            <select onchange="formatDrugChildDoseText('fontSize', this.value)" style="padding: 5px;">
                                <option>الحجم</option>
                                <option value="1">صغير</option>
                                <option value="3">متوسط</option>
                                <option value="5">كبير</option>
                                <option value="7">كبير جداً</option>
                            </select>
                            <button type="button" onclick="formatDrugChildDoseText('bold')" style="padding: 5px 10px; font-weight: bold;">B</button>
                            <button type="button" onclick="formatDrugChildDoseText('italic')" style="padding: 5px 10px; font-style: italic;">I</button>
                            <button type="button" onclick="formatDrugChildDoseText('underline')" style="padding: 5px 10px; text-decoration: underline;">U</button>
                            <input type="color" onchange="formatDrugChildDoseText('foreColor', this.value)" title="لون النص" style="width: 40px; height: 30px;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>جرعة الكبار</label>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn-secondary" onclick="openDrugAdultDoseTextEditor()" style="margin-bottom: 5px;">
                            ✏️ تنسيق متقدم
                        </button>
                    </div>
                    <div id="drugAdultDoseEditor" contenteditable="true" 
                         style="min-height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-main);"
                         placeholder="مثال: 500mg كل 8 ساعات أو 875mg كل 12 ساعة"></div>
                    <div id="drugAdultDoseTextControls" style="display: none; margin-top: 10px; padding: 10px; background: var(--bg-main); border-radius: 8px;">
                        <!-- Font controls for adult dose -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                            <select onchange="formatDrugAdultDoseText('fontName', this.value)" style="padding: 5px;">
                                <option>الخط</option>
                                <option value="Arial">Arial</option>
                                <option value="Cairo">Cairo</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Times New Roman">Times New Roman</option>
                            </select>
                            <select onchange="formatDrugAdultDoseText('fontSize', this.value)" style="padding: 5px;">
                                <option>الحجم</option>
                                <option value="1">صغير</option>
                                <option value="3">متوسط</option>
                                <option value="5">كبير</option>
                                <option value="7">كبير جداً</option>
                            </select>
                            <button type="button" onclick="formatDrugAdultDoseText('bold')" style="padding: 5px 10px; font-weight: bold;">B</button>
                            <button type="button" onclick="formatDrugAdultDoseText('italic')" style="padding: 5px 10px; font-style: italic;">I</button>
                            <button type="button" onclick="formatDrugAdultDoseText('underline')" style="padding: 5px 10px; text-decoration: underline;">U</button>
                            <input type="color" onchange="formatDrugAdultDoseText('foreColor', this.value)" title="لون النص" style="width: 40px; height: 30px;">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea id="drugNotesInput" placeholder="ملاحظات إضافية..." rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">💾 حفظ الدواء</button>
                    <button type="button" class="btn-secondary" onclick="closeDrugModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="categoryModalTitle">إضافة فئة جديدة</h2>
                <button class="close-modal" onclick="closeCategoryModal()">×</button>
            </div>
            <form onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label id="categoryNameLabel">اسم الفئة</label>
                    <input type="text" id="categoryNameInput" placeholder="مثال: أطفال، باطنة، جلدية..." required>
                </div>
                <div class="form-group">
                    <label id="categoryBgLabel">صورة خلفية للفئة (اختياري)</label>
                    <input type="file" id="categoryBgImageInput" accept="image/*" style="display: none;" onchange="handleCategoryBgImageUpload(event)">
                    <button type="button" class="add-image-btn" id="addCategoryBgBtn" onclick="document.getElementById('categoryBgImageInput').click()" style="background: var(--secondary);">
                        🖼️ إضافة خلفية للفئة
                    </button>
                    <div id="categoryBgPreview" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-main); border-radius: 12px; text-align: center;">
                        <img id="categoryBgPreviewImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; opacity: 0.3;">
                        <p style="color: var(--text-light); font-size: 0.9em; margin-top: 10px;">معاينة الخلفية (ستظهر باهتة في روشتات هذه الفئة)</p>
                        <button type="button" class="image-control-btn" onclick="removeCategoryBgImage()" style="margin-top: 10px;">🗑️ إزالة الخلفية</button>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="saveCategoryBtn">حفظ</button>
                    <button type="button" class="btn-secondary" id="cancelCategoryBtn" onclick="closeCategoryModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Prescription Modal -->
    <div class="modal" id="prescriptionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="prescriptionModalTitle">إضافة روشتة جديدة</h2>
                <button class="close-modal" onclick="closePrescriptionModal()">×</button>
            </div>
            <form onsubmit="savePrescription(event)">
                <div class="form-group">
                    <label id="prescNameLabel">اسم الروشتة</label>
                    <input type="text" id="prescriptionNameInput" placeholder="مثال: علاج نزلات البرد للأطفال" required>
                </div>
                <div class="form-group">
                    <label id="prescCategoryLabel">الفئة</label>
                    <select id="prescriptionCategoryInput" style="width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Cairo', sans-serif; font-size: 1em; background: var(--bg-main);" required>
                        <option value="" id="prescCategoryPlaceholder">اختر الفئة...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label id="prescRxLabel">Rx (محتوى الروشتة)</label>
                    <div class="text-toolbar" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; margin-bottom: 10px; padding: 12px; background: var(--bg-main); border-radius: 8px;">
                        
                        <!-- Row 1: Basic Formatting -->
                        <div style="display: flex; gap: 5px; align-items: center; padding: 5px; background: white; border-radius: 6px;">
                            <button type="button" class="quick-btn" onclick="execCmd('bold')" title="غامق"><strong>B</strong></button>
                            <button type="button" class="quick-btn" onclick="execCmd('italic')" title="مائل"><em>I</em></button>
                            <button type="button" class="quick-btn" onclick="execCmd('underline')" title="خط تحت"><u>U</u></button>
                            <button type="button" class="quick-btn" onclick="execCmd('strikeThrough')" title="يتوسطه خط"><s>S</s></button>
                        </div>
                        
                        <!-- Row 2: Font Controls -->
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="number" id="rxFontSizeInput" min="8" max="72" value="16" style="width: 60px; padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-family: 'Cairo', sans-serif; font-size: 0.85em;" placeholder="16" onchange="applyFontSizeByNumber(this.value)" title="حجم الخط">
                            <select id="rxFontFamily" onchange="applyFontFamily(this.value)" style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-family: 'Cairo', sans-serif; font-size: 0.85em;">
                                <option value="Cairo">Cairo</option>
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times</option>
                                <option value="Courier New">Courier</option>
                            </select>
                        </div>
                        
                        <!-- Row 3: Alignment -->
                        <div style="display: flex; gap: 5px; align-items: center; padding: 5px; background: white; border-radius: 6px;">
                            <button type="button" class="quick-btn" onclick="alignText('right')" title="يمين">⊣</button>
                            <button type="button" class="quick-btn" onclick="alignText('center')" title="وسط">≡</button>
                            <button type="button" class="quick-btn" onclick="alignText('left')" title="يسار">⊢</button>
                            <button type="button" class="quick-btn" onclick="setTextDirection('rtl')" title="RTL">←</button>
                            <button type="button" class="quick-btn" onclick="setTextDirection('ltr')" title="LTR">→</button>
                        </div>
                        
                        <!-- Row 4: Highlights (Markers) -->
                        <div style="display: flex; gap: 3px; align-items: center; padding: 5px; background: white; border-radius: 6px; flex-wrap: wrap;">
                            <span style="font-size: 0.75em; color: var(--text-light); margin-left: 3px;">🖍️</span>
                            <button type="button" class="format-btn" onclick="applyHighlight('#ffeb3b')" style="background: #ffeb3b; width: 24px; height: 24px;" title="أصفر"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#4caf50')" style="background: #4caf50; width: 24px; height: 24px;" title="أخضر"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#ff9800')" style="background: #ff9800; width: 24px; height: 24px;" title="برتقالي"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#e91e63')" style="background: #e91e63; width: 24px; height: 24px;" title="وردي"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#03a9f4')" style="background: #03a9f4; width: 24px; height: 24px;" title="أزرق"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#9c27b0')" style="background: #9c27b0; width: 24px; height: 24px;" title="بنفسجي"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#f44336')" style="background: #f44336; width: 24px; height: 24px;" title="أحمر"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#00bcd4')" style="background: #00bcd4; width: 24px; height: 24px;" title="سماوي"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#8bc34a')" style="background: #8bc34a; width: 24px; height: 24px;" title="أخضر فاتح"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('#ffc107')" style="background: #ffc107; width: 24px; height: 24px;" title="كهرماني"></button>
                            <button type="button" class="format-btn" onclick="applyHighlight('transparent')" style="background: white; border: 1px solid #ccc; width: 24px; height: 24px;" title="إزالة">✗</button>
                        </div>
                        
                        <!-- Row 5: Text Colors -->
                        <div style="display: flex; gap: 3px; align-items: center; padding: 5px; background: white; border-radius: 6px; flex-wrap: wrap;">
                            <span style="font-size: 0.75em; color: var(--text-light); margin-left: 3px;">A</span>
                            <button type="button" class="format-btn" onclick="applyRxColor('#000000')" style="background: #000000; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#dc2626')" style="background: #dc2626; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#ea580c')" style="background: #ea580c; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#d97706')" style="background: #d97706; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#65a30d')" style="background: #65a30d; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#0f766e')" style="background: #0f766e; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#0284c7')" style="background: #0284c7; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#1e40af')" style="background: #1e40af; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#7c3aed')" style="background: #7c3aed; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#c026d3')" style="background: #c026d3; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#ec4899')" style="background: #ec4899; width: 24px; height: 24px;"></button>
                            <button type="button" class="format-btn" onclick="applyRxColor('#06b6d4')" style="background: #06b6d4; width: 24px; height: 24px;"></button>
                        </div>
                        
                        <!-- Row 6: Insert Image & Clear -->
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="file" id="inlineImageInput" accept="image/*" style="display: none;" onchange="insertImageInText(event)">
                            <button type="button" class="btn-secondary" onclick="document.getElementById('inlineImageInput').click()" style="padding: 6px 12px; font-size: 0.85em; flex: 1;">📷 صورة</button>
                            <button type="button" class="btn-secondary" onclick="clearRxFormatting()" style="padding: 6px 12px; font-size: 0.85em; flex: 1;">🔄 مسح</button>
                        </div>
                        
                    </div>
                    <div id="prescriptionRxEditor" contenteditable="true" dir="rtl" style="min-height: 200px; max-height: 400px; overflow-y: auto; padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: white; font-family: 'Cairo', sans-serif; font-size: 16px; line-height: 1.8; color: #000; text-align: right;" placeholder="Rx

Tab. Paracetamol 500mg
1x3 daily after meals

Syrup Ambroxol 15mg/5ml
5ml x3 daily
..."></div>
                    <textarea id="prescriptionRxInput" style="display: none;"></textarea>
                </div>
                <div class="form-group">
                    <label>Notes (ملاحظات)</label>
                    <textarea id="prescriptionNotesInput" placeholder="ملاحظات إضافية، تحذيرات، أو تعليمات خاصة..."></textarea>
                </div>
                <div class="form-group">
                    <label id="prescImageLabel">إضافة صورة (اختياري)</label>
                    <input type="file" id="prescriptionImageInput" accept="image/*" style="display: none;" onchange="handlePrescriptionImageUpload(event)">
                    <button type="button" class="add-image-btn" id="addImageBtn" onclick="document.getElementById('prescriptionImageInput').click()">
                        📷 إضافة صورة
                    </button>
                    <div class="image-container" id="prescriptionImageContainer" style="display: none;">
                        <div class="image-controls">
                            <button type="button" class="image-control-btn" onclick="zoomPrescriptionImage(1.1)" title="تكبير">🔍+</button>
                            <button type="button" class="image-control-btn" onclick="zoomPrescriptionImage(0.9)" title="تصغير">🔍-</button>
                            <button type="button" class="image-control-btn" onclick="removePrescriptionImage()" title="حذف">🗑️</button>
                        </div>
                        <img id="prescriptionImagePreview" class="image-preview" draggable="false">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="savePrescBtn">حفظ الروشتة</button>
                    <button type="button" class="btn-secondary" id="cancelPrescBtn" onclick="closePrescriptionModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Prescription Modal -->
    <div class="modal view-prescription-modal" id="viewPrescriptionModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="viewPrescriptionTitle"></h2>
                <button class="close-modal" onclick="closeViewPrescriptionModal()">×</button>
            </div>
            <div class="prescription-full" style="max-height: calc(90vh - 200px); overflow-y: auto;">
                <div class="section">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 1.5em;">💊</span>
                        <h3 style="margin: 0;">Rx</h3>
                        <button onclick="takeScreenshot()" title="التقاط لقطة شاشة" style="background: transparent; border: 2px solid var(--primary); color: var(--primary); padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 1.3em; display: flex; align-items: center; transition: all 0.3s; margin-right: auto;" onmouseover="this.style.background='var(--primary)'; this.style.color='white'; this.style.transform='scale(1.1)';" onmouseout="this.style.background='transparent'; this.style.color='var(--primary)'; this.style.transform='scale(1)';">
                            📸
                        </button>
                    </div>
                    <div class="section-content" id="viewPrescriptionRx" style="font-size: 16px; line-height: 1.8; min-height: 200px;"></div>
                </div>
                <div class="section">
                    <h3>📝 Notes</h3>
                    <div class="section-content" id="viewPrescriptionNotes"></div>
                </div>
                <div class="section" id="viewPrescriptionImageSection" style="display: none;">
                    <h3>📷 الصورة</h3>
                    <img id="viewPrescriptionImage" style="max-width: 100%; border-radius: 12px; margin-top: 10px;">
                </div>
            </div>
            <div class="form-actions" style="gap: 8px;">
                <button class="btn-primary" id="exportPDFBtn" onclick="exportPrescriptionPDF()" style="padding: 8px 16px; font-size: 0.9em;">📄 PDF</button>
                <button class="btn-primary" id="editPrescViewBtn" onclick="editPrescriptionFromView()" style="padding: 8px 16px; font-size: 0.9em;">✏️ تعديل</button>
                <button class="btn-secondary" id="closePrescViewBtn" onclick="closeViewPrescriptionModal()" style="padding: 8px 16px; font-size: 0.9em;">✖️ إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Note Modal -->
    <div class="modal" id="noteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="noteModalTitle">إضافة ملاحظة جديدة</h2>
                <button class="close-modal" onclick="closeNoteModal()">×</button>
            </div>
            <form onsubmit="saveNote(event)">
                <div class="form-group">
                    <label>عنوان الملاحظة</label>
                    <input type="text" id="noteTitleInput" placeholder="مثال: أفكار مهمة، تذكير، ملاحظات سريعة..." required>
                </div>
                <div class="form-group">
                    <label>محتوى الملاحظة</label>
                    <textarea id="noteContentInput" placeholder="اكتب ملاحظتك هنا..." required style="min-height: 200px;"></textarea>
                </div>
                <div class="form-group">
                    <label>إضافة صورة (اختياري)</label>
                    <input type="file" id="noteImageInput" accept="image/*" style="display: none;" onchange="handleNoteImageUpload(event)">
                    <button type="button" class="add-image-btn" onclick="document.getElementById('noteImageInput').click()">
                        📷 إضافة صورة
                    </button>
                    <div class="image-container" id="noteImageContainer" style="display: none;">
                        <div class="image-controls">
                            <button type="button" class="image-control-btn" onclick="zoomNoteImage(1.1)" title="تكبير">🔍+</button>
                            <button type="button" class="image-control-btn" onclick="zoomNoteImage(0.9)" title="تصغير">🔍-</button>
                            <button type="button" class="image-control-btn" onclick="removeNoteImage()" title="حذف">🗑️</button>
                        </div>
                        <img id="noteImagePreview" class="image-preview" draggable="false">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">حفظ الملاحظة</button>
                    <button type="button" class="btn-secondary" onclick="closeNoteModal()">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Note Modal -->
    <div class="modal view-prescription-modal" id="viewNoteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewNoteTitle"></h2>
                <button class="close-modal" onclick="closeViewNoteModal()">×</button>
            </div>
            <div class="prescription-full">
                <div class="section">
                    <h3>📝 المحتوى</h3>
                    <div class="section-content" id="viewNoteContent"></div>
                </div>
                <div class="section" id="viewNoteImageSection" style="display: none;">
                    <h3>📷 الصورة</h3>
                    <img id="viewNoteImage" style="max-width: 100%; border-radius: 12px; margin-top: 10px;">
                </div>
                <div class="section" style="background: var(--bg-main); padding: 15px; border-radius: 12px; margin-top: 20px;">
                    <p style="color: var(--text-light); font-size: 0.9em;">
                        <strong>تاريخ الإنشاء:</strong> <span id="viewNoteDate"></span>
                    </p>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn-primary" onclick="editNoteFromView()">تعديل الملاحظة</button>
                <button class="btn-secondary" onclick="closeViewNoteModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ الإعدادات</h2>
                <button class="close-modal" onclick="closeSettingsModal()">×</button>
            </div>
            <div>
                <!-- App Name & Description Section -->
                <div style="margin-bottom: 40px; padding-bottom: 30px; border-bottom: 2px solid var(--border);">
                    <h3 style="color: var(--text-dark); margin-bottom: 15px; font-size: 1.2em;">✏️ تخصيص التطبيق</h3>
                    <div class="form-group">
                        <label>اسم التطبيق</label>
                        <input type="text" id="appNameInput" placeholder="د.محمد مدحت" style="width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Cairo', sans-serif; font-size: 1em; background: var(--bg-main);">
                    </div>
                    <div class="form-group">
                        <label>وصف التطبيق</label>
                        <input type="text" id="appDescInput" placeholder="نظام احترافي لإدارة وتنظيم الروشتات الطبية والملاحظات" style="width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Cairo', sans-serif; font-size: 1em; background: var(--bg-main);">
                    </div>
                    <button class="btn-primary" onclick="saveAppInfo()" style="width: 100%; margin-top: 10px;">
                        💾 حفظ التغييرات
                    </button>
                </div>

                <h3 style="color: var(--text-dark); margin-bottom: 15px; font-size: 1.2em;">🎨 تخصيص الخلفية</h3>
                <p style="color: var(--text-light); margin-bottom: 20px;">اختر خلفية للتطبيق من الخيارات التالية:</p>
                
                <div class="background-options">
                    <div class="bg-option active" onclick="changeBackground('default')" style="background: linear-gradient(135deg, #f0fdf4 0%, #ecfeff 100%);">
                        <div class="bg-option-label">الافتراضي</div>
                    </div>
                    <div class="bg-option" onclick="changeBackground('medical')" style="background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);">
                        <div class="bg-option-label">طبي أزرق</div>
                    </div>
                    <div class="bg-option" onclick="changeBackground('nature')" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);">
                        <div class="bg-option-label">طبيعي</div>
                    </div>
                    <div class="bg-option" onclick="changeBackground('warm')" style="background: linear-gradient(135deg, #fed7aa 0%, #fecaca 100%);">
                        <div class="bg-option-label">دافئ</div>
                    </div>
                    <div class="bg-option" onclick="changeBackground('purple')" style="background: linear-gradient(135deg, #e9d5ff 0%, #fae8ff 100%);">
                        <div class="bg-option-label">بنفسجي</div>
                    </div>
                    <div class="bg-option" onclick="changeBackground('elegant')" style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);">
                        <div class="bg-option-label">أنيق</div>
                    </div>
                </div>

                <div class="upload-bg-container">
                    <h4 style="color: var(--text-dark); margin-bottom: 10px;">أو ارفع صورة خاصة بك</h4>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">سيتم استخدام الصورة كخلفية للتطبيق</p>
                    <input type="file" id="customBgInput" accept="image/*" style="display: none;" onchange="uploadCustomBackground(event)">
                    <button class="upload-bg-btn" onclick="document.getElementById('customBgInput').click()">
                        📤 رفع صورة خلفية
                    </button>
                    <button class="upload-bg-btn" onclick="removeCustomBackground()" style="background: var(--danger); margin-right: 10px;">
                        🗑️ إزالة الخلفية المخصصة
                    </button>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="closeSettingsModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div class="modal" id="themeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎨 اختر الثيم</h2>
                <button class="close-modal" onclick="closeThemeModal()">×</button>
            </div>
            <div>
                <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.05em;">اختر الثيم المناسب لك من الخيارات التالية:</p>
                
                <div class="theme-options-grid">
                    <div class="theme-card theme-light" onclick="changeTheme('light')">
                        <span class="theme-icon">☀️</span>
                        <span class="theme-name">فاتح</span>
                    </div>
                    <div class="theme-card theme-dark" onclick="changeTheme('dark')">
                        <span class="theme-icon">🌙</span>
                        <span class="theme-name">داكن</span>
                    </div>
                    <div class="theme-card theme-mint" onclick="changeTheme('mint')">
                        <span class="theme-icon">🌿</span>
                        <span class="theme-name">نعناع</span>
                    </div>
                    <div class="theme-card theme-rose" onclick="changeTheme('rose')">
                        <span class="theme-icon">🌹</span>
                        <span class="theme-name">وردي</span>
                    </div>
                    <div class="theme-card theme-sky" onclick="changeTheme('sky')">
                        <span class="theme-icon">☁️</span>
                        <span class="theme-name">سماوي</span>
                    </div>
                    <div class="theme-card theme-amber" onclick="changeTheme('amber')">
                        <span class="theme-icon">🔶</span>
                        <span class="theme-name">عنبري</span>
                    </div>
                    <div class="theme-card theme-lavender" onclick="changeTheme('lavender')">
                        <span class="theme-icon">💜</span>
                        <span class="theme-name">لافندر</span>
                    </div>
                    <div class="theme-card" onclick="document.getElementById('customThemeImageInput').click()" style="background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); color: #374151; border: 2px dashed #9ca3af;">
                        <span class="theme-icon">📷</span>
                        <span class="theme-name">صورة مخصصة</span>
                    </div>
                </div>

                <input type="file" id="customThemeImageInput" accept="image/*" style="display: none;" onchange="uploadCustomThemeImage(event)">
                
                <div style="margin-top: 25px; padding: 20px; background: var(--bg-main); border-radius: 12px; border: 1px solid var(--border);">
                    <p style="color: var(--text-dark); font-weight: 600; margin-bottom: 10px;">💡 ملاحظة:</p>
                    <p style="color: var(--text-light); font-size: 0.95em; line-height: 1.6;">
                        عند اختيار صورة مخصصة، ستظهر الصورة كخلفية باهتة (علامة مائية) خلف المحتوى بحيث يبقى النص واضحاً وسهل القراءة.
                    </p>
                    <button class="btn-secondary" onclick="removeCustomThemeImage()" style="width: 100%; margin-top: 15px;">
                        🗑️ إزالة الصورة المخصصة
                    </button>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="closeThemeModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Settings Menu Modal -->
    <div class="modal" id="settingsMenuModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>⚙️ الإعدادات</h2>
                <button class="close-modal" onclick="closeSettingsMenu()">×</button>
            </div>
            <div style="padding: 10px 0;">
                <!-- Theme Selection -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); openThemeModal();">
                    <span class="settings-icon">🎨</span>
                    <div class="settings-text">
                        <h3 id="themeButtonTitle">اختيار الثيم</h3>
                        <p id="themeButtonDesc">غير ألوان وخلفية التطبيق</p>
                    </div>
                    <span class="settings-arrow">←</span>
                </button>
                
                <!-- Language Toggle -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); toggleLanguage();">
                    <span class="settings-icon">🌐</span>
                    <div class="settings-text">
                        <h3 id="langButtonTitle">تغيير اللغة</h3>
                        <p id="langButtonDesc">التبديل بين العربية والإنجليزية</p>
                    </div>
                    <span class="settings-arrow">←</span>
                </button>
                
                <!-- Export Data -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); exportAllData();">
                    <span class="settings-icon">💾</span>
                    <div class="settings-text">
                        <h3 id="exportButtonTitle">استخراج البيانات</h3>
                        <p id="exportButtonDesc">تحميل نسخة احتياطية من كل بياناتك</p>
                    </div>
                    <span class="settings-arrow">←</span>
                </button>
                
                <!-- Import Data -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); importAllData();">
                    <span class="settings-icon">📂</span>
                    <div class="settings-text">
                        <h3 id="importButtonTitle">إدخال البيانات</h3>
                        <p id="importButtonDesc">استرجع البيانات من ملف النسخة الاحتياطية</p>
                    </div>
                    <span class="settings-arrow">←</span>
                </button>
                
                <!-- Google Drive Sync (ACTIVE!) -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); openGoogleSync();" style="border: 2px solid #4285f4; background: rgba(66, 133, 244, 0.05); margin-top: 15px;">
                    <span class="settings-icon" style="color: #4285f4;">☁️</span>
                    <div class="settings-text">
                        <h3 style="color: #4285f4; font-weight: 600;">Google Drive Sync</h3>
                        <p style="color: #4285f4;">نسخ احتياطي واسترجاع من Google Drive</p>
                    </div>
                    <span class="settings-arrow" style="color: #4285f4;">←</span>
                </button>
                
                <!-- Format All Data (DANGER) -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); formatAllData();" style="border: 2px solid var(--danger); background: rgba(239, 68, 68, 0.05); margin-top: 20px;">
                    <span class="settings-icon" style="color: var(--danger);">⚠️</span>
                    <div class="settings-text">
                        <h3 id="formatButtonTitle" style="color: var(--danger); font-weight: 700;">Format - مسح كل البيانات</h3>
                        <p id="formatButtonDesc" style="color: var(--danger);">حذف نهائي لجميع البيانات (لا يمكن التراجع)</p>
                    </div>
                    <span class="settings-arrow" style="color: var(--danger);">←</span>
                </button>
                
                <!-- Login Settings (NEW #6) -->
                <button class="settings-menu-btn" onclick="closeSettingsMenu(); openLoginSettings();" style="margin-top: 15px;">
                    <span class="settings-icon">🔐</span>
                    <div class="settings-text">
                        <h3 id="loginButtonTitle">إعدادات تسجيل الدخول</h3>
                        <p id="loginButtonDesc">تفعيل/إلغاء حماية التطبيق بكلمة مرور</p>
                    </div>
                    <span class="settings-arrow">←</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Login Settings Modal -->
    <div class="modal" id="loginSettingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>🔐 إعدادات تسجيل الدخول</h2>
                <button class="close-modal" onclick="closeLoginSettings()">×</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 15px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 20px;">
                        <input type="checkbox" id="enableLoginCheckbox" onchange="toggleLoginEnabled()" style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-size: 1.1em; font-weight: 600;">تفعيل حماية التطبيق بكلمة مرور</span>
                    </label>
                </div>
                
                <div id="loginCredentialsSection" style="display: none;">
                    <div class="form-group">
                        <label>👤 اسم المستخدم</label>
                        <input type="text" id="loginUsernameInput" placeholder="أدخل اسم المستخدم" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label>🔑 كلمة المرور</label>
                        <input type="password" id="loginPasswordInput" placeholder="أدخل كلمة المرور" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em;">
                    </div>
                    
                    <div class="form-group">
                        <label>🔑 تأكيد كلمة المرور</label>
                        <input type="password" id="loginPasswordConfirmInput" placeholder="أعد إدخال كلمة المرور" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 1em;">
                    </div>
                    
                    <button class="btn-primary" onclick="saveLoginCredentials()" style="width: 100%; margin-top: 10px;">
                        💾 حفظ البيانات
                    </button>
                </div>
                
                <button class="btn-secondary" onclick="closeLoginSettings()" style="width: 100%; margin-top: 15px;">
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- Login Screen (Shown on startup if enabled) -->
    <div class="modal active" id="loginScreen" style="display: none; background: rgba(0, 0, 0, 0.95);">
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 4em; margin-bottom: 20px;">🔐</div>
                <h2 style="margin-bottom: 30px;">تسجيل الدخول</h2>
                
                <div class="form-group" style="text-align: right;">
                    <label>👤 اسم المستخدم</label>
                    <input type="text" id="loginScreenUsername" placeholder="اسم المستخدم" style="width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 1.1em;">
                </div>
                
                <div class="form-group" style="text-align: right;">
                    <label>🔑 كلمة المرور</label>
                    <input type="password" id="loginScreenPassword" placeholder="كلمة المرور" onkeypress="if(event.key==='Enter') attemptLogin()" style="width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 8px; font-size: 1.1em;">
                </div>
                
                <div id="loginErrorMessage" style="color: var(--danger); margin-top: 10px; display: none; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                    ❌ اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                
                <button class="btn-primary" onclick="attemptLogin()" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.1em;">
                    دخول
                </button>
            </div>
        </div>
    </div>

    <!-- Font Settings Modal (Separate) -->
    <div class="modal" id="fontSettingsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>🔤 إعدادات الخطوط</h2>
                <button class="close-modal" onclick="closeFontSettingsModal()">×</button>
            </div>
            <div>
                <!-- Section 1: Prescription Fonts -->
                <div style="background: var(--bg-main); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 2px solid var(--border);">
                    <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.3em;">📋 خطوط الروشتات</h3>
                    <p style="color: var(--text-light); margin-bottom: 20px;">اضبط حجم ولون الخط في عرض الروشتات:</p>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px;">📏 حجم الخط</label>
                        <input type="range" id="rxFontSizeSlider" min="12" max="24" value="16" style="width: 100%;" oninput="changeFontSize(this.value)">
                        <span id="rxFontSizeValue" style="display: block; text-align: center; color: var(--text-light); font-size: 0.9em; margin-top: 8px; font-weight: 600;">16px</span>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px;">🎨 لون الخط</label>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                            <button class="rx-color-btn active" onclick="changeFontColor('#000000')" style="background: #000000;" data-color="#000000" title="أسود"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#ffffff')" style="background: #ffffff; border: 2px solid #ccc;" data-color="#ffffff" title="أبيض"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#dc2626')" style="background: #dc2626;" data-color="#dc2626" title="أحمر"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#ea580c')" style="background: #ea580c;" data-color="#ea580c" title="برتقالي"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#f59e0b')" style="background: #f59e0b;" data-color="#f59e0b" title="ذهبي"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#65a30d')" style="background: #65a30d;" data-color="#65a30d" title="أخضر"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#0891b2')" style="background: #0891b2;" data-color="#0891b2" title="سماوي"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#0284c7')" style="background: #0284c7;" data-color="#0284c7" title="أزرق"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#7c3aed')" style="background: #7c3aed;" data-color="#7c3aed" title="بنفسجي"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#c026d3')" style="background: #c026d3;" data-color="#c026d3" title="وردي فاتح"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#db2777')" style="background: #db2777;" data-color="#db2777" title="وردي"></button>
                            <button class="rx-color-btn" onclick="changeFontColor('#84cc16')" style="background: #84cc16;" data-color="#84cc16" title="ليموني"></button>
                        </div>
                    </div>
                </div>
                
                <!-- Section 2: App Fonts -->
                <div style="background: var(--bg-main); padding: 25px; border-radius: 16px; border: 2px solid var(--border);">
                    <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.3em;">💻 خطوط البرنامج</h3>
                    <p style="color: var(--text-light); margin-bottom: 20px;">اضبط حجم ولون خط واجهة البرنامج:</p>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px;">📏 حجم الخط</label>
                        <input type="range" id="appFontSizeSlider2" min="12" max="20" value="16" style="width: 100%;" oninput="changeAppFontSize(this.value)">
                        <span id="appFontSizeValue2" style="display: block; text-align: center; color: var(--text-light); font-size: 0.9em; margin-top: 8px; font-weight: 600;">16px</span>
                    </div>
                    
                    <div>
                        <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px;">🎨 لون الخط</label>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                            <button class="app-color-btn2 active" onclick="changeAppFontColor('#1f2937')" style="background: #1f2937;" data-color="#1f2937" title="رمادي داكن"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#000000')" style="background: #000000;" data-color="#000000" title="أسود"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#ffffff')" style="background: #ffffff; border: 2px solid #ccc;" data-color="#ffffff" title="أبيض"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#dc2626')" style="background: #dc2626;" data-color="#dc2626" title="أحمر"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#f59e0b')" style="background: #f59e0b;" data-color="#f59e0b" title="ذهبي"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#0891b2')" style="background: #0891b2;" data-color="#0891b2" title="سماوي"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#0284c7')" style="background: #0284c7;" data-color="#0284c7" title="أزرق"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#7c3aed')" style="background: #7c3aed;" data-color="#7c3aed" title="بنفسجي"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#c026d3')" style="background: #c026d3;" data-color="#c026d3" title="وردي فاتح"></button>
                            <button class="app-color-btn2" onclick="changeAppFontColor('#65a30d')" style="background: #65a30d;" data-color="#65a30d" title="أخضر"></button>
                        </div>
                    </div>
                </div>
                
                <!-- Section 3: Button Size -->
                <div style="background: var(--bg-main); padding: 25px; border-radius: 16px; border: 2px solid var(--border); margin-top: 25px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px; font-size: 1.3em;">🔘 حجم الأزرار</h3>
                    <p style="color: var(--text-light); margin-bottom: 20px;">اختر حجم جميع أزرار البرنامج:</p>
                    
                    <div style="display: grid; gap: 12px;">
                        <button class="size-option-btn" onclick="changeButtonSize('xs')" data-size="xs" style="padding: 12px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s;">
                            <span style="font-size: 1em;">🔹</span>
                            <div style="text-align: right;">
                                <h4 style="color: var(--text-dark); font-size: 0.95em; margin: 0;">صغير جداً</h4>
                            </div>
                        </button>
                        
                        <button class="size-option-btn" onclick="changeButtonSize('sm')" data-size="sm" style="padding: 14px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s;">
                            <span style="font-size: 1.1em;">🔸</span>
                            <div style="text-align: right;">
                                <h4 style="color: var(--text-dark); font-size: 1em; margin: 0;">صغير</h4>
                            </div>
                        </button>
                        
                        <button class="size-option-btn active" onclick="changeButtonSize('md')" data-size="md" style="padding: 16px; background: var(--bg-card); border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s;">
                            <span style="font-size: 1.2em;">🔶</span>
                            <div style="text-align: right;">
                                <h4 style="color: var(--text-dark); font-size: 1.05em; margin: 0; font-weight: 600;">وسط (افتراضي)</h4>
                            </div>
                        </button>
                        
                        <button class="size-option-btn" onclick="changeButtonSize('lg')" data-size="lg" style="padding: 18px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s;">
                            <span style="font-size: 1.3em;">🟠</span>
                            <div style="text-align: right;">
                                <h4 style="color: var(--text-dark); font-size: 1.1em; margin: 0;">كبير</h4>
                            </div>
                        </button>
                        
                        <button class="size-option-btn" onclick="changeButtonSize('xl')" data-size="xl" style="padding: 20px; background: var(--bg-card); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.3s;">
                            <span style="font-size: 1.4em;">🟧</span>
                            <div style="text-align: right;">
                                <h4 style="color: var(--text-dark); font-size: 1.15em; margin: 0;">كبير جداً</h4>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="closeFontSettingsModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Font Settings Modal -->
    <div class="modal" id="fontModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔤 تخصيص خطوط الروشتات</h2>
                <button class="close-modal" onclick="closeFontModal()">×</button>
            </div>
            <div>
                <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.05em;">اضبط حجم ولون الخط لعرض الروشتات:</p>
                
                <div style="margin-bottom: 30px;">
                    <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px; font-size: 1.1em;">📏 حجم الخط</label>
                    <input type="range" id="fontSizeSlider" min="12" max="24" value="16" style="width: 100%;" oninput="changeFontSize(this.value)">
                    <span id="fontSizeValue" style="display: block; text-align: center; color: var(--text-light); font-size: 0.9em; margin-top: 8px; font-weight: 600;">16px</span>
                </div>
                
                <div>
                    <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px; font-size: 1.1em;">🎨 لون الخط</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                        <button class="color-btn active" onclick="changeFontColor('#000000')" style="background: #000000;" data-color="#000000" title="أسود"></button>
                        <button class="color-btn" onclick="changeFontColor('#dc2626')" style="background: #dc2626;" data-color="#dc2626" title="أحمر"></button>
                        <button class="color-btn" onclick="changeFontColor('#ea580c')" style="background: #ea580c;" data-color="#ea580c" title="برتقالي"></button>
                        <button class="color-btn" onclick="changeFontColor('#d97706')" style="background: #d97706;" data-color="#d97706" title="ذهبي"></button>
                        <button class="color-btn" onclick="changeFontColor('#65a30d')" style="background: #65a30d;" data-color="#65a30d" title="أخضر"></button>
                        <button class="color-btn" onclick="changeFontColor('#0f766e')" style="background: #0f766e;" data-color="#0f766e" title="تركواز"></button>
                        <button class="color-btn" onclick="changeFontColor('#0284c7')" style="background: #0284c7;" data-color="#0284c7" title="أزرق فاتح"></button>
                        <button class="color-btn" onclick="changeFontColor('#1e40af')" style="background: #1e40af;" data-color="#1e40af" title="أزرق غامق"></button>
                        <button class="color-btn" onclick="changeFontColor('#7c3aed')" style="background: #7c3aed;" data-color="#7c3aed" title="بنفسجي"></button>
                        <button class="color-btn" onclick="changeFontColor('#c026d3')" style="background: #c026d3;" data-color="#c026d3" title="وردي"></button>
                    </div>
                </div>
                
                <div style="margin-top: 25px; padding: 20px; background: var(--bg-main); border-radius: 12px; border: 1px solid var(--border);">
                    <p style="color: var(--text-dark); font-weight: 600; margin-bottom: 10px;">💡 ملاحظة:</p>
                    <p style="color: var(--text-light); font-size: 0.95em; line-height: 1.6;">
                        هذه الإعدادات تطبق على عرض الروشتات فقط. لتنسيق نصوص معينة أثناء الكتابة، استخدم أدوات التحرير داخل نموذج الروشتة.
                    </p>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="closeFontModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- App Font Settings Modal -->
    <div class="modal" id="appFontModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔠 تخصيص خطوط البرنامج</h2>
                <button class="close-modal" onclick="closeAppFontModal()">×</button>
            </div>
            <div>
                <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.05em;">اضبط حجم ولون الخط لكل عناصر البرنامج:</p>
                
                <div style="margin-bottom: 30px;">
                    <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px; font-size: 1.1em;">📏 حجم الخط</label>
                    <input type="range" id="appFontSizeSlider" min="12" max="20" value="16" style="width: 100%;" oninput="changeAppFontSize(this.value)">
                    <span id="appFontSizeValue" style="display: block; text-align: center; color: var(--text-light); font-size: 0.9em; margin-top: 8px; font-weight: 600;">16px</span>
                </div>
                
                <div>
                    <label style="display: block; color: var(--text-dark); font-weight: 600; margin-bottom: 12px; font-size: 1.1em;">🎨 لون الخط</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">
                        <button class="app-color-btn active" onclick="changeAppFontColor('#1f2937')" style="background: #1f2937;" data-color="#1f2937" title="رمادي غامق"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#000000')" style="background: #000000;" data-color="#000000" title="أسود"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#dc2626')" style="background: #dc2626;" data-color="#dc2626" title="أحمر"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#ea580c')" style="background: #ea580c;" data-color="#ea580c" title="برتقالي"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#0f766e')" style="background: #0f766e;" data-color="#0f766e" title="تركواز"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#0284c7')" style="background: #0284c7;" data-color="#0284c7" title="أزرق فاتح"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#1e40af')" style="background: #1e40af;" data-color="#1e40af" title="أزرق غامق"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#7c3aed')" style="background: #7c3aed;" data-color="#7c3aed" title="بنفسجي"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#c026d3')" style="background: #c026d3;" data-color="#c026d3" title="وردي"></button>
                        <button class="app-color-btn" onclick="changeAppFontColor('#65a30d')" style="background: #65a30d;" data-color="#65a30d" title="أخضر"></button>
                    </div>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="closeAppFontModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Button Size Settings Modal -->
    <div class="modal" id="buttonSizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔘 حجم الأزرار</h2>
                <button class="close-modal" onclick="closeButtonSizeModal()">×</button>
            </div>
            <div>
                <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.05em;">اختر حجم الأزرار في البرنامج:</p>
                
                <div style="display: grid; gap: 15px;">
                    <button class="size-option-btn" onclick="changeButtonSize('xs')" data-size="xs">
                        <span style="font-size: 1.2em;">🔹</span>
                        <div>
                            <h3>صغير جداً</h3>
                            <p>أزرار مضغوطة للشاشات الصغيرة</p>
                        </div>
                    </button>
                    
                    <button class="size-option-btn" onclick="changeButtonSize('sm')" data-size="sm">
                        <span style="font-size: 1.4em;">🔸</span>
                        <div>
                            <h3>صغير</h3>
                            <p>أزرار صغيرة ومريحة</p>
                        </div>
                    </button>
                    
                    <button class="size-option-btn active" onclick="changeButtonSize('md')" data-size="md">
                        <span style="font-size: 1.6em;">🔶</span>
                        <div>
                            <h3>وسط (افتراضي)</h3>
                            <p>الحجم القياسي للأزرار</p>
                        </div>
                    </button>
                    
                    <button class="size-option-btn" onclick="changeButtonSize('lg')" data-size="lg">
                        <span style="font-size: 1.8em;">🟠</span>
                        <div>
                            <h3>كبير</h3>
                            <p>أزرار كبيرة وسهلة الضغط</p>
                        </div>
                    </button>
                    
                    <button class="size-option-btn" onclick="changeButtonSize('xl')" data-size="xl">
                        <span style="font-size: 2em;">🟧</span>
                        <div>
                            <h3>كبير جداً</h3>
                            <p>أزرار كبيرة جداً للرؤية الواضحة</p>
                        </div>
                    </button>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-secondary" onclick="closeButtonSizeModal()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Edit App Name & Description Modal -->
    <div class="modal" id="editAppModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ تعديل الاسم والوصف</h2>
                <button class="close-modal" onclick="closeEditAppModal()">×</button>
            </div>
            <div>
                <div class="form-group">
                    <label style="font-size: 1.2em; color: var(--text-dark); margin-bottom: 10px;">اسم التطبيق</label>
                    <input type="text" id="editAppNameInput" placeholder="د.محمد مدحت" style="width: 100%; padding: 16px 20px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Cairo', sans-serif; font-size: 1.1em; background: var(--bg-main);">
                </div>
                <div class="form-group">
                    <label style="font-size: 1.2em; color: var(--text-dark); margin-bottom: 10px;">وصف التطبيق</label>
                    <textarea id="editAppDescInput" placeholder="نظام احترافي لإدارة وتنظيم الروشتات الطبية والملاحظات" style="width: 100%; padding: 16px 20px; border: 2px solid var(--border); border-radius: 12px; font-family: 'Cairo', sans-serif; font-size: 1.1em; background: var(--bg-main); min-height: 100px; resize: vertical;"></textarea>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 30px;">
                <button class="btn-primary" onclick="saveAppInfoFromEditModal()">💾 حفظ التغييرات</button>
                <button class="btn-secondary" onclick="closeEditAppModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        /*
        ═══════════════════════════════════════════════════════════════
        🔧 إعداد Google Drive (اختياري)
        ═══════════════════════════════════════════════════════════════
        
        لتفعيل المزامنة السحابية مع Google Drive:
        
        1. افتح: https://console.cloud.google.com/
        2. أنشئ مشروع جديد (New Project)
        3. فعّل Google Drive API:
           - APIs & Services → Enable APIs
           - ابحث عن "Google Drive API"
           - اضغط Enable
        
        4. أنشئ OAuth 2.0 Client ID:
           - APIs & Services → Credentials
           - Create Credentials → OAuth 2.0 Client ID
           - Application Type: Web Application
           - Authorized JavaScript origins: أضف النطاق الخاص بك
           - Authorized redirect URIs: أضف النطاق الخاص بك
        
        5. احصل على API Key:
           - Create Credentials → API Key
        
        6. انسخ CLIENT_ID و API_KEY
        7. ضعهم في السطر 3786 (ابحث عن YOUR_CLIENT_ID_HERE)
        
        ملاحظة: إذا لم تعد API keys، ستعمل ميزة Export/Import كبديل ممتاز!
        ═══════════════════════════════════════════════════════════════
        */
        
        // Data Storage
        let categories = JSON.parse(localStorage.getItem('categories')) || [];
        let prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let drugs = JSON.parse(localStorage.getItem('drugs')) || [];
        let drugCategories = JSON.parse(localStorage.getItem('drugCategories')) || [];
        let folders = JSON.parse(localStorage.getItem('folders')) || [];  // NEW: Folders for prescriptions
        let drugFolders = JSON.parse(localStorage.getItem('drugFolders')) || [];  // NEW: Folders for drugs
        let trashedPrescriptions = JSON.parse(localStorage.getItem('trashedPrescriptions')) || [];
        let trashedCategories = JSON.parse(localStorage.getItem('trashedCategories')) || [];
        let trashedNotes = JSON.parse(localStorage.getItem('trashedNotes')) || [];
        let currentCategory = 'all';
        let currentDrugCategory = 'all';
        let currentFolder = null;  // NEW: Current selected folder
        let currentDrugFolder = null;  // NEW: Current selected drug folder
        let editingCategoryId = null;
        let editingDrugCategoryId = null;
        let editingFolderId = null;  // NEW
        let editingDrugFolderId = null;  // NEW
        let editingPrescriptionId = null;
        let editingDrugId = null;
        let viewingPrescriptionId = null;
        let editingNoteId = null;
        let viewingNoteId = null;
        let currentTab = 'prescriptions';
        let currentTheme = localStorage.getItem('theme') || 'light';
        let appName = localStorage.getItem('appName') || 'روشتاتي';
        let appDescription = localStorage.getItem('appDescription') || 'نظام احترافي لإدارة وتنظيم الروشتات الطبية والأدوية';
        let prescriptionFontSize = localStorage.getItem('prescriptionFontSize') || '16';
        let prescriptionFontColor = localStorage.getItem('prescriptionFontColor') || '#1a1a1a';
        
        // Image handling variables
        let currentPrescriptionImage = null;
        let currentPrescriptionImageScale = 1;
        let currentPrescriptionImagePosition = {x: 0, y: 0};
        let currentCategoryBgImage = null;
        let currentNoteImage = null;
        let currentNoteImageScale = 1;
        let currentNoteImagePosition = {x: 0, y: 0};
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let categorySortMode = localStorage.getItem('categorySortMode') || 'manual'; // manual, alpha, recent


        // Helper function to disable scroll when opening modal
        function disableScroll() {
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            document.body.style.top = `-${scrollY}px`;
            document.body.classList.add('modal-open');
        }

        // Helper function to ensure scroll is enabled
        function ensureScrollEnabled() {
            // Check if any modal is still open
            const allModals = document.querySelectorAll('.modal');
            let anyModalOpen = false;
            
            allModals.forEach(modal => {
                if (modal.classList.contains('active')) {
                    anyModalOpen = true;
                }
            });
            
            // If no modal is open, restore scroll
            if (!anyModalOpen) {
                const scrollY = document.body.style.top;
                document.body.classList.remove('modal-open');
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.width = '';
                
                if (scrollY) {
                    window.scrollTo(0, parseInt(scrollY || '0') * -1);
                }
            }
        }


        // Theme System
        const themes = {
            'light': { icon: '☀️', name: 'فاتح' },
            'dark': { icon: '🌙', name: 'داكن' },
            'mint': { icon: '🌿', name: 'نعناع' },
            'rose': { icon: '🌹', name: 'وردي' },
            'sky': { icon: '☁️', name: 'سماوي' },
            'amber': { icon: '🔶', name: 'عنبري' },
            'lavender': { icon: '💜', name: 'لافندر' }
        };

        function loadTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            const customImage = localStorage.getItem('customThemeImage');
            
            if (theme === 'custom' && customImage) {
                currentTheme = 'custom';
                document.body.style.background = `url('${customImage}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
                document.body.classList.add('custom-bg');
                
                const themeIcon = document.getElementById('currentThemeIcon');
                const themeName = document.getElementById('currentThemeName');
                if (themeIcon) themeIcon.textContent = '📷';
                if (themeName) themeName.textContent = 'صورة مخصصة';
            } else {
                applyTheme(theme);
            }
            
            // Update active theme in modal
            setTimeout(() => {
                updateThemeModalActive();
            }, 100);
        }

        function applyTheme(theme) {
            // Remove all theme classes including custom-bg
            document.body.classList.remove('theme-light', 'theme-dark', 'theme-mint', 'theme-rose', 'theme-sky', 'theme-amber', 'theme-lavender', 'custom-bg');
            
            // Keep dark-mode class if theme is 'dark'
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Clear custom background styles if applying non-custom theme
            if (theme !== 'custom') {
                document.body.style.background = '';
                document.body.style.backgroundSize = '';
                document.body.style.backgroundPosition = '';
                document.body.style.backgroundAttachment = '';
            }
            
            // Add new theme class
            document.body.classList.add(`theme-${theme}`);
            
            // Update current theme display
            const themeInfo = themes[theme];
            if (themeInfo) {
                const themeIcon = document.getElementById('currentThemeIcon');
                const themeName = document.getElementById('currentThemeName');
                if (themeIcon) themeIcon.textContent = themeInfo.icon;
                if (themeName) themeName.textContent = themeInfo.name;
            }
            
            // Update active state in dropdown
            document.querySelectorAll('.theme-option').forEach((opt, index) => {
                opt.classList.remove('active');
                const themeKeys = Object.keys(themes);
                if (themeKeys[index] === theme) {
                    opt.classList.add('active');
                }
            });
            
            currentTheme = theme;
            localStorage.setItem('theme', theme);
        }

        function changeTheme(theme) {
            // Update active state FIRST - IMMEDIATELY
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('active');
                card.style.border = '2px solid var(--border)';
                card.style.transform = 'scale(1)';
            });
            
            const activeCard = document.querySelector(`.theme-card.theme-${theme}`);
            if (activeCard) {
                activeCard.classList.add('active');
                activeCard.style.border = '3px solid var(--primary)';
                activeCard.style.transform = 'scale(1.05)';
                activeCard.style.boxShadow = '0 0 0 5px rgba(16, 185, 129, 0.3)';
            }
            
            // Apply theme
            applyTheme(theme);
            
            // Close modal after you see the selection
            setTimeout(() => {
                closeThemeModal();
            }, 300);
            
            // Update background if needed based on theme
            const bgType = localStorage.getItem('backgroundType');
            if (bgType && bgType !== 'custom') {
                applyBackgroundGradient(bgType);
            }
        }

        function openThemeModal() {
            document.getElementById('themeModal').classList.add('active');
            updateThemeModalActive();
            disableScroll();
        }

        function closeThemeModal() {
            document.getElementById('themeModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function updateThemeModalActive() {
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('active');
                card.style.border = '2px solid var(--border)';
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '';
            });
            
            // Add active to the selected theme
            const activeCard = document.querySelector(`.theme-card.theme-${currentTheme}`);
            console.log('🎨 Looking for theme:', currentTheme);
            console.log('🎨 Found card:', activeCard);
            if (activeCard) {
                activeCard.classList.add('active');
                activeCard.style.border = '3px solid var(--primary)';
                activeCard.style.transform = 'scale(1.05)';
                activeCard.style.boxShadow = '0 0 0 5px rgba(16, 185, 129, 0.3)';
                console.log('✅ Added active class and styles to card');
            } else {
                console.log('❌ Card not found for theme:', currentTheme);
            }
            
            console.log('✅ Updated active theme to:', currentTheme);
        }

        function uploadCustomThemeImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    localStorage.setItem('customThemeImage', imageData);
                    localStorage.setItem('theme', 'custom');
                    currentTheme = 'custom';
                    
                    // Apply custom image as background with low opacity
                    document.body.classList.remove('theme-light', 'theme-dark', 'theme-ocean', 'theme-purple', 'theme-sunset');
                    document.body.style.background = `url('${imageData}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    document.body.style.backgroundAttachment = 'fixed';
                    document.body.classList.add('custom-bg');
                    
                    // Update theme button
                    document.getElementById('currentThemeIcon').textContent = '📷';
                    document.getElementById('currentThemeName').textContent = 'صورة مخصصة';
                    
                    closeThemeModal();
                };
                reader.readAsDataURL(file);
            }
        }

        function removeCustomThemeImage() {
            // Remove custom image from localStorage
            localStorage.removeItem('customThemeImage');
            localStorage.setItem('theme', 'light');
            currentTheme = 'light';
            
            // Remove custom background completely
            document.body.classList.remove('custom-bg');
            document.body.style.background = '';
            document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = '';
            document.body.style.backgroundAttachment = '';
            
            // Apply light theme
            applyTheme('light');
            
            // Update active state in modal
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('active');
                card.style.border = '2px solid var(--border)';
                card.style.transform = 'scale(1)';
                card.style.boxShadow = '';
            });
            
            const lightCard = document.querySelector('.theme-card.theme-light');
            if (lightCard) {
                lightCard.classList.add('active');
                lightCard.style.border = '3px solid var(--primary)';
                lightCard.style.transform = 'scale(1.05)';
                lightCard.style.boxShadow = '0 0 0 5px rgba(16, 185, 129, 0.3)';
            }
            
            // Clear file input
            const fileInput = document.getElementById('customThemeImageInput');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Show success message
            alert('✅ تم حذف الصورة المخصصة بنجاح!');
            
            closeThemeModal();
        }

        // Background Settings
        // App Name & Description Functions
        function loadAppInfo() {
            appName = localStorage.getItem('appName') || 'روشتاتي';
            appDescription = localStorage.getItem('appDescription') || 'نظام احترافي لإدارة وتنظيم الروشتات الطبية والأدوية';
            
            // Update header
            const h1 = document.querySelector('header h1');
            const p = document.querySelector('header p');
            h1.innerHTML = `💊 ${appName}`;
            h1.onclick = openEditAppModal;
            p.textContent = appDescription;
            p.onclick = openEditAppModal;
            
            // Update inputs in settings modal if exists
            if (document.getElementById('appNameInput')) {
                document.getElementById('appNameInput').value = appName;
                document.getElementById('appDescInput').value = appDescription;
            }
        }

        function openEditAppModal() {
            document.getElementById('editAppModal').classList.add('active');
            document.getElementById('editAppNameInput').value = appName;
            document.getElementById('editAppDescInput').value = appDescription;
        }

        function closeEditAppModal() {
            document.getElementById('editAppModal').classList.remove('active');
        }

        function saveAppInfoFromEditModal() {
            const newName = document.getElementById('editAppNameInput').value.trim() || 'د.محمد مدحت';
            const newDesc = document.getElementById('editAppDescInput').value.trim() || 'نظام احترافي لإدارة وتنظيم الروشتات الطبية والملاحظات';
            
            appName = newName;
            appDescription = newDesc;
            
            localStorage.setItem('appName', appName);
            localStorage.setItem('appDescription', appDescription);
            
            // Update header immediately
            const h1 = document.querySelector('header h1');
            const p = document.querySelector('header p');
            h1.innerHTML = `💊 ${appName}`;
            h1.onclick = openEditAppModal;
            p.textContent = appDescription;
            p.onclick = openEditAppModal;
            
            // Show success feedback
            const modal = document.getElementById('editAppModal');
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ تم الحفظ!';
            btn.style.background = 'var(--primary)';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                closeEditAppModal();
            }, 1500);
        }

        function saveAppInfo() {
            const newName = document.getElementById('appNameInput').value.trim() || 'د.محمد مدحت';
            const newDesc = document.getElementById('appDescInput').value.trim() || 'نظام احترافي لإدارة وتنظيم الروشتات الطبية والملاحظات';
            
            appName = newName;
            appDescription = newDesc;
            
            localStorage.setItem('appName', appName);
            localStorage.setItem('appDescription', appDescription);
            
            // Update header immediately
            document.querySelector('header h1').innerHTML = `💊 ${appName}`;
            document.querySelector('header p').textContent = appDescription;
            
            // Show success feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '✅ تم الحفظ!';
            btn.style.background = 'var(--primary)';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }

        // Tab Switching
        function switchTab(tab) {
            currentTab = tab;
            const t = translations[currentLanguage];
            
            // Close quick menu
            const quickMenu = document.getElementById('quickMenu');
            if (quickMenu) quickMenu.style.display = 'none';
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach((btn, index) => {
                btn.classList.remove('active');
                if ((tab === 'prescriptions' && index === 0) ||
                    (tab === 'drugs' && index === 1) ||
                    (tab === 'trash' && index === 2)) {
                    btn.classList.add('active');
                }
            });
            
            // Update sections
            document.querySelectorAll('.section-content-wrapper').forEach(section => {
                section.classList.remove('active');
            });
            
            if (tab === 'prescriptions') {
                document.getElementById('prescriptionsSection').classList.add('active');
                renderPrescriptions();
                document.getElementById('contentTitle').innerHTML = currentCategory === 'all' ? `📋 ${t.allPrescriptions}` : `📁 ${categories.find(c => c.id === currentCategory).name}`;
                const addPrescBtn = document.getElementById('addPrescriptionMainBtn');
                if (addPrescBtn) addPrescBtn.style.display = 'flex';
                const addDrugBtn = document.getElementById('addDrugMainBtn');
                if (addDrugBtn) addDrugBtn.style.display = 'none';
            } else if (tab === 'favorites') {
                document.getElementById('favoritesSection').classList.add('active');
                renderFavorites();
                document.getElementById('contentTitle').innerHTML = `⭐ الروشتات المفضلة`;
                const addPrescBtn = document.getElementById('addPrescriptionMainBtn');
                if (addPrescBtn) addPrescBtn.style.display = 'none';
                const addDrugBtn = document.getElementById('addDrugMainBtn');
                if (addDrugBtn) addDrugBtn.style.display = 'none';
            } else if (tab === 'drugs') {
                document.getElementById('drugsSection').classList.add('active');
                renderDrugs();
                renderDrugCategories();
                document.getElementById('contentTitle').innerHTML = `💊 الأدوية`;
                const addPrescBtn = document.getElementById('addPrescriptionMainBtn');
                if (addPrescBtn) addPrescBtn.style.display = 'none';
                const addDrugBtn = document.getElementById('addDrugMainBtn');
                if (addDrugBtn) addDrugBtn.style.display = 'flex';
            } else if (tab === 'trash') {
                document.getElementById('trashSection').classList.add('active');
                updateTrashCounts();
                renderTrash();
                document.getElementById('contentTitle').innerHTML = `🗑️ ${t.trash}`;
                const addPrescBtn = document.getElementById('addPrescriptionMainBtn');
                if (addPrescBtn) addPrescBtn.style.display = 'none';
                const addDrugBtn = document.getElementById('addDrugMainBtn');
                if (addDrugBtn) addDrugBtn.style.display = 'none';
            }
        }

        // Initialize
        function init() {
            // Reload all data from localStorage
            categories = JSON.parse(localStorage.getItem('categories')) || [];
            prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            notes = JSON.parse(localStorage.getItem('notes')) || [];
            drugs = JSON.parse(localStorage.getItem('drugs')) || [];
            drugCategories = JSON.parse(localStorage.getItem('drugCategories')) || [];
            trashedPrescriptions = JSON.parse(localStorage.getItem('trashedPrescriptions')) || [];
            trashedCategories = JSON.parse(localStorage.getItem('trashedCategories')) || [];
            trashedNotes = JSON.parse(localStorage.getItem('trashedNotes')) || [];
            
            console.log('🚀 APP INITIALIZED');
            console.log('📊 Loaded from localStorage:');
            console.log('  - Categories:', categories.length);
            console.log('  - Prescriptions:', prescriptions.length);
            console.log('  - Notes:', notes.length);
            console.log('  - Drugs:', drugs.length);
            console.log('  - Drug Categories:', drugCategories.length);
            
            // CRITICAL: Ensure currentCategory is 'all'
            currentCategory = 'all';
            currentDrugCategory = 'all';
            
            loadTheme();
            loadAppInfo();
            loadFontSettings();
            
            // 🔥 IMMEDIATE RENDER - NO DELAY
            console.log('🎯 FORCE RENDERING CATEGORIES - IMMEDIATE');
            renderCategories();
            renderPrescriptions();
            updateCategorySelect();
            updateNotesCount();
            updateTrashCounts();
            updateBadgeCounts();  // ✅ عشان النجمة تظهر فوراً
            
            // Apply translations AFTER rendering
            translateUI();
            
            setupImageDragging();
            setupSearchListeners();
            
            // 🔥 MEGA-FORCE REFRESH SEQUENCE
            setTimeout(() => {
                console.log('🔄 FORCE 1 (50ms)');
                renderCategories();
                renderPrescriptions();
                updateCategorySelect();
                updateBadgeCounts();
            }, 50);
            
            setTimeout(() => {
                console.log('🔄 FORCE 2 (150ms)');
                renderCategories();
                renderPrescriptions();
                translateUI();
                updateBadgeCounts();
            }, 150);
            
            setTimeout(() => {
                console.log('🔄 FORCE 3 (300ms) - REFRESH');
                refreshCategories();
                updateBadgeCounts();
            }, 300);
            
            setTimeout(() => {
                console.log('🔄 FORCE 4 (500ms) - FINAL');
                renderCategories();
                renderPrescriptions();
                updateCategorySelect();
                translateUI();
                updateBadgeCounts();
                console.log('✅ CATEGORIES SHOWN! Count:', categories.length);
            }, 500);
            
            setTimeout(() => {
                console.log('🔄 FORCE 5 (800ms) - ULTIMATE');
                renderCategories();
                updateCategorySelect();
                updateBadgeCounts();
            }, 800);
            
            // Apply saved settings
            applyAppFontSettings();
            applyButtonSize();
            
            // Update favorites count
            updateFavoritesCount();
            
            // Render drug categories
            renderDrugCategories();
            
            // Update badge counts
            updateBadgeCounts();
            
            // FORCE: Ensure prescriptions tab is active
            setTimeout(() => {
                switchTab('prescriptions');
            }, 100);
            
            // 🔥 FINAL FORCE UPDATE for badge counts
            setTimeout(() => {
                console.log('🔄 FINAL: Updating badge counts');
                updateBadgeCounts();
                console.log('✅ Favorites count updated:', 
                    prescriptions.filter(p => p.isFavorite).length,
                    '+',
                    drugs.filter(d => d.isFavorite).length);
            }, 1000);
        }
        
        // Setup search listeners
        function setupSearchListeners() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    renderPrescriptions();
                });
            }

            const searchNotesInput = document.getElementById('searchNotesInput');
            if (searchNotesInput) {
                searchNotesInput.addEventListener('input', function() {
                    renderNotes();
                });
            }
        }

        // Prescription Image Functions
        function handlePrescriptionImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentPrescriptionImage = e.target.result;
                    currentPrescriptionImageScale = 1;
                    currentPrescriptionImagePosition = {x: 0, y: 0};
                    
                    const container = document.getElementById('prescriptionImageContainer');
                    const preview = document.getElementById('prescriptionImagePreview');
                    
                    container.style.display = 'block';
                    preview.src = currentPrescriptionImage;
                    preview.style.transform = `translate(0px, 0px) scale(1)`;
                };
                reader.readAsDataURL(file);
            }
        }

        function zoomPrescriptionImage(factor) {
            currentPrescriptionImageScale *= factor;
            const preview = document.getElementById('prescriptionImagePreview');
            preview.style.transform = `translate(${currentPrescriptionImagePosition.x}px, ${currentPrescriptionImagePosition.y}px) scale(${currentPrescriptionImageScale})`;
        }

        function removePrescriptionImage() {
            currentPrescriptionImage = null;
            currentPrescriptionImageScale = 1;
            currentPrescriptionImagePosition = {x: 0, y: 0};
            document.getElementById('prescriptionImageContainer').style.display = 'none';
            document.getElementById('prescriptionImageInput').value = '';
        }

        // Note Image Functions
        function handleNoteImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentNoteImage = e.target.result;
                    currentNoteImageScale = 1;
                    currentNoteImagePosition = {x: 0, y: 0};
                    
                    const container = document.getElementById('noteImageContainer');
                    const preview = document.getElementById('noteImagePreview');
                    
                    container.style.display = 'block';
                    preview.src = currentNoteImage;
                    preview.style.transform = `translate(0px, 0px) scale(1)`;
                };
                reader.readAsDataURL(file);
            }
        }

        function zoomNoteImage(factor) {
            currentNoteImageScale *= factor;
            const preview = document.getElementById('noteImagePreview');
            preview.style.transform = `translate(${currentNoteImagePosition.x}px, ${currentNoteImagePosition.y}px) scale(${currentNoteImageScale})`;
        }

        function removeNoteImage() {
            currentNoteImage = null;
            currentNoteImageScale = 1;
            currentNoteImagePosition = {x: 0, y: 0};
            document.getElementById('noteImageContainer').style.display = 'none';
            document.getElementById('noteImageInput').value = '';
        }

        // Image Dragging Setup
        function setupImageDragging() {
            let currentDraggingImage = null;
            
            // Prescription image dragging
            const prescriptionPreview = document.getElementById('prescriptionImagePreview');
            if (prescriptionPreview) {
                prescriptionPreview.addEventListener('mousedown', function(e) {
                    currentDraggingImage = 'prescription';
                    isDragging = true;
                    dragStartX = e.clientX - currentPrescriptionImagePosition.x;
                    dragStartY = e.clientY - currentPrescriptionImagePosition.y;
                    prescriptionPreview.style.cursor = 'grabbing';
                    e.preventDefault();
                });
            }

            // Note image dragging
            const notePreview = document.getElementById('noteImagePreview');
            if (notePreview) {
                notePreview.addEventListener('mousedown', function(e) {
                    currentDraggingImage = 'note';
                    isDragging = true;
                    dragStartX = e.clientX - currentNoteImagePosition.x;
                    dragStartY = e.clientY - currentNoteImagePosition.y;
                    notePreview.style.cursor = 'grabbing';
                    e.preventDefault();
                });
            }

            // Global mouse move
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                if (currentDraggingImage === 'prescription' && prescriptionPreview && prescriptionPreview.src) {
                    currentPrescriptionImagePosition.x = e.clientX - dragStartX;
                    currentPrescriptionImagePosition.y = e.clientY - dragStartY;
                    prescriptionPreview.style.transform = `translate(${currentPrescriptionImagePosition.x}px, ${currentPrescriptionImagePosition.y}px) scale(${currentPrescriptionImageScale})`;
                } else if (currentDraggingImage === 'note' && notePreview && notePreview.src) {
                    currentNoteImagePosition.x = e.clientX - dragStartX;
                    currentNoteImagePosition.y = e.clientY - dragStartY;
                    notePreview.style.transform = `translate(${currentNoteImagePosition.x}px, ${currentNoteImagePosition.y}px) scale(${currentNoteImageScale})`;
                }
            });

            // Global mouse up
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    if (currentDraggingImage === 'prescription' && prescriptionPreview && prescriptionPreview.src) {
                        prescriptionPreview.style.cursor = 'move';
                    } else if (currentDraggingImage === 'note' && notePreview && notePreview.src) {
                        notePreview.style.cursor = 'move';
                    }
                    currentDraggingImage = null;
                }
            });
        }

        // Category Functions
        function openAddCategoryModal() {
            editingCategoryId = null;
            currentCategoryBgImage = null;
            
            const t = translations[currentLanguage];
            
            document.getElementById('categoryModal').classList.add('active');
            document.getElementById('categoryModalTitle').textContent = t.addCategory;
            document.getElementById('categoryNameInput').value = '';
            document.getElementById('categoryBgPreview').style.display = 'none';
            document.getElementById('categoryBgImageInput').value = '';
            disableScroll();
        }

        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (category) {
                editingCategoryId = categoryId;
                currentCategoryBgImage = category.bgImage || null;
                
                document.getElementById('categoryModal').classList.add('active');
                document.getElementById('categoryModalTitle').textContent = 'تعديل الفئة';
                document.getElementById('categoryNameInput').value = category.name;
                
                // Load background image if exists
                if (category.bgImage) {
                    document.getElementById('categoryBgPreview').style.display = 'block';
                    document.getElementById('categoryBgPreviewImg').src = category.bgImage;
                } else {
                    document.getElementById('categoryBgPreview').style.display = 'none';
                }
                
                disableScroll();
            }
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
            editingCategoryId = null;
            document.body.classList.remove('modal-open');
        }

        function handleCategoryBgImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentCategoryBgImage = e.target.result;
                    document.getElementById('categoryBgPreview').style.display = 'block';
                    document.getElementById('categoryBgPreviewImg').src = currentCategoryBgImage;
                };
                reader.readAsDataURL(file);
            }
        }

        function removeCategoryBgImage() {
            currentCategoryBgImage = null;
            document.getElementById('categoryBgPreview').style.display = 'none';
            document.getElementById('categoryBgImageInput').value = '';
        }

        function saveCategory(event) {
            if (event) event.preventDefault();
            
            try {
                const categoryName = document.getElementById('categoryNameInput').value.trim();
                
                if (!categoryName) {
                    alert('⚠️ الرجاء إدخال اسم الفئة');
                    return;
                }
                
                if (editingCategoryId) {
                    // Edit existing category
                    const index = categories.findIndex(c => c.id === editingCategoryId);
                    if (index !== -1) {
                        categories[index] = {
                            ...categories[index],
                            name: categoryName,
                            bgImage: currentCategoryBgImage || null
                        };
                        console.log('✏️ Updated category:', categories[index]);
                    }
                } else {
                    // Add new category
                    const newCategory = {
                        id: Date.now(),
                        name: categoryName,
                        bgImage: currentCategoryBgImage || null
                    };
                    categories.push(newCategory);
                    console.log('➕ Added new category:', newCategory);
                    console.log('📊 Total categories:', categories.length);
                }
                
                localStorage.setItem('categories', JSON.stringify(categories));
                
                // CRITICAL: Reload from localStorage
                categories = JSON.parse(localStorage.getItem('categories')) || [];
                console.log('💾 Saved category, reloaded:', categories.length, 'categories');
                
                renderCategories();
                updateCategorySelect();
                renderPrescriptions(); // Re-render prescriptions to update backgrounds
                closeCategoryModal();
                
                console.log('✅ Category saved successfully');
            } catch (error) {
                console.error('❌ Error saving category:', error);
                alert('حدث خطأ أثناء الحفظ. حاول مرة أخرى.');
            }
        }

        function deleteCategory(categoryId) {
            if (confirm('هل أنت متأكد من حذف هذه الفئة؟ سيتم حذفها مع جميع الروشتات بداخلها.')) {
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    const now = new Date().toISOString();
                    category.deletedAt = now;
                    
                    // Move all prescriptions in this category to trash
                    const categoryPrescriptions = prescriptions.filter(p => p.categoryId === categoryId);
                    categoryPrescriptions.forEach(presc => {
                        presc.deletedAt = now;
                        presc.deletedWithCategory = true;
                        trashedPrescriptions.push(presc);
                    });
                    
                    category.prescriptionsCount = categoryPrescriptions.length;
                    
                    // Move category to trash
                    trashedCategories.push(category);
                    
                    // Remove category AND its prescriptions
                    categories = categories.filter(c => c.id !== categoryId);
                    prescriptions = prescriptions.filter(p => p.categoryId !== categoryId);
                    
                    // Save to localStorage
                    localStorage.setItem('categories', JSON.stringify(categories));
                    localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                    localStorage.setItem('trashedCategories', JSON.stringify(trashedCategories));
                    localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                    
                    if (currentCategory === categoryId) {
                        currentCategory = 'all';
                    }
                    
                    renderCategories();
                    renderPrescriptions();
                    updateCategorySelect();
                    updateTrashCounts();
                }
            }
        }

        function selectCategory(categoryId) {
            currentCategory = categoryId;
            renderCategories();
            renderPrescriptions();
            
            if (categoryId === 'all') {
                document.getElementById('contentTitle').innerHTML = '📋 كل الروشتات';
            } else {
                const category = categories.find(c => c.id == categoryId); // Using == instead of ===
                document.getElementById('contentTitle').innerHTML = `📁 ${category ? category.name : 'غير معروف'}`;
            }
        }

        // Refresh categories - force re-render
        // Global Refresh Function
        function globalRefresh() {
            console.log('🔄 GLOBAL REFRESH - Reloading everything...');
            
            // 1. Reload ALL data from localStorage
            categories = JSON.parse(localStorage.getItem('categories')) || [];
            prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            notes = JSON.parse(localStorage.getItem('notes')) || [];
            drugs = JSON.parse(localStorage.getItem('drugs')) || [];
            drugCategories = JSON.parse(localStorage.getItem('drugCategories')) || [];
            trashedPrescriptions = JSON.parse(localStorage.getItem('trashedPrescriptions')) || [];
            trashedCategories = JSON.parse(localStorage.getItem('trashedCategories')) || [];
            trashedNotes = JSON.parse(localStorage.getItem('trashedNotes')) || [];
            
            console.log('📊 Reloaded data:', {
                categories: categories.length,
                prescriptions: prescriptions.length,
                notes: notes.length,
                drugs: drugs.length
            });
            
            // 2. Update ALL counts and badges
            updateBadgeCounts();
            updateFavoritesCount();
            updateNotesCount();
            updateTrashCounts();
            
            // 3. Render based on current tab
            console.log('📍 Current tab:', currentTab);
            
            if (currentTab === 'prescriptions') {
                console.log('🔄 Refreshing PRESCRIPTIONS...');
                renderCategories();
                renderPrescriptions();
                updateCategorySelect();
            } else if (currentTab === 'drugs') {
                console.log('🔄 Refreshing DRUGS...');
                renderDrugCategories();
                renderDrugs();
                updateDrugCategorySelect();
            } else if (currentTab === 'trash') {
                console.log('🔄 Refreshing TRASH...');
                renderTrash();
            }
            
            // 4. Update popups if open
            const notesPopup = document.getElementById('notesPopup');
            if (notesPopup && notesPopup.classList.contains('active')) {
                renderNotesPopup();
            }
            
            const favPopup = document.getElementById('favoritesPopup');
            if (favPopup && favPopup.classList.contains('active')) {
                renderFavoritesPopup();
            }
            
            console.log('✅ Global refresh complete!');
        }
        
        function refreshCategories() {
            console.log('🔄 Refreshing categories...');
            
            // Reload from localStorage
            categories = JSON.parse(localStorage.getItem('categories')) || [];
            prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            
            // Re-render everything
            renderCategories();
            renderPrescriptions();
            updateCategorySelect();
            
            console.log('✅ Categories refreshed:', categories.length);
        }

        function toggleCategorySort() {
            const modes = ['manual', 'alpha', 'recent'];
            const currentIndex = modes.indexOf(categorySortMode);
            categorySortMode = modes[(currentIndex + 1) % modes.length];
            localStorage.setItem('categorySortMode', categorySortMode);
            
            const icons = { manual: '📋', alpha: '🔤', recent: '🕒' };
            const names = { manual: 'يدوي', alpha: 'أبجدي', recent: 'الأحدث' };
            
            document.getElementById('sortIcon').textContent = icons[categorySortMode];
            document.getElementById('sortIcon').title = `الترتيب: ${names[categorySortMode]}`;
            
            renderCategories();
        }
        
        function renderCategories() {
            const categoryList = document.getElementById('categoryList');
            const allCount = prescriptions.length;
            const t = translations[currentLanguage];
            
            // Sort categories based on mode
            let sortedCategories = [...categories];
            if (categorySortMode === 'alpha') {
                sortedCategories.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
            } else if (categorySortMode === 'recent') {
                sortedCategories.sort((a, b) => b.id - a.id); // Newer first
            }
            // 'manual' keeps original order
            
            let html = `
                <div class="category-item ${currentCategory === 'all' ? 'active' : ''}" data-category="all" onclick="selectCategory('all')">
                    <div class="category-item-content">
                        <span>📋 ${t.allPrescriptions}</span>
                        <span class="category-count">${allCount}</span>
                    </div>
                </div>
            `;
            
            sortedCategories.forEach(category => {
                const count = prescriptions.filter(p => p.categoryId == category.id).length;
                html += `
                    <div class="category-item ${currentCategory == category.id ? 'active' : ''}" onclick="selectCategory(${category.id})">
                        <div class="category-item-content">
                            <span>📁 ${category.name}</span>
                            <span class="category-count">${count}</span>
                        </div>
                        <div style="display: flex; gap: 5px;" onclick="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                            <button class="delete-category-btn" onclick="showFoldersSoon()" ontouchend="showFoldersSoon()" style="background: #8b5cf6;" title="المجلدات (قريباً)">📂</button>
                            <button class="delete-category-btn" onclick="handleEditCategory(${category.id})" ontouchend="handleEditCategory(${category.id})" style="background: var(--primary);" title="${t.edit}">✏️</button>
                            <button class="delete-category-btn" onclick="handleDeleteCategory(${category.id})" ontouchend="handleDeleteCategory(${category.id})" title="${t.delete}">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            categoryList.innerHTML = html;
        }
        
        // Mobile-safe wrapper functions
        function handleEditCategory(categoryId) {
            event.stopPropagation();
            event.preventDefault();
            editCategory(categoryId);
        }
        
        function handleDeleteCategory(categoryId) {
            event.stopPropagation();
            event.preventDefault();
            deleteCategory(categoryId);
        }
        
        function handleEditPrescription(prescriptionId) {
            event.stopPropagation();
            event.preventDefault();
            editPrescription(prescriptionId);
        }
        
        function handleDeletePrescription(prescriptionId) {
            event.stopPropagation();
            event.preventDefault();
            deletePrescription(prescriptionId);
        }

        function updateCategorySelect() {
            const select = document.getElementById('prescriptionCategoryInput');
            const t = translations[currentLanguage];
            let html = `<option value="">${t.selectCategory}</option>`;
            
            categories.forEach(category => {
                html += `<option value="${category.id}">${category.name}</option>`;
            });
            
            select.innerHTML = html;
        }

        // Prescription Functions
        function openAddPrescriptionModal() {
            editingPrescriptionId = null;
            currentPrescriptionImage = null;
            currentPrescriptionImageScale = 1;
            currentPrescriptionImagePosition = {x: 0, y: 0};
            
            const t = translations[currentLanguage];
            
            document.getElementById('prescriptionModal').classList.add('active');
            document.getElementById('prescriptionModalTitle').textContent = t.addPrescription;
            document.getElementById('prescriptionNameInput').value = '';
            document.getElementById('prescriptionCategoryInput').value = currentCategory === 'all' ? '' : currentCategory;
            document.getElementById('prescriptionRxInput').value = 'Rx\n\n';
            document.getElementById('prescriptionNotesInput').value = '';
            document.getElementById('prescriptionImageContainer').style.display = 'none';
            document.getElementById('prescriptionImageInput').value = '';
            disableScroll(); // Prevent background scroll
        }

        function closePrescriptionModal() {
            document.getElementById('prescriptionModal').classList.remove('active');
            editingPrescriptionId = null;
            document.body.classList.remove('modal-open'); // Restore background scroll
        }

        function savePrescription(event) {
            event.preventDefault();
            
            // Sync editor content to hidden textarea
            syncRxEditorToInput();
            
            const name = document.getElementById('prescriptionNameInput').value.trim();
            const categoryIdInput = document.getElementById('prescriptionCategoryInput').value;
            const categoryId = categoryIdInput ? parseInt(categoryIdInput) : null;
            const rx = document.getElementById('prescriptionRxInput').value.trim();
            const notes = document.getElementById('prescriptionNotesInput').value.trim();
            
            if (!name) {
                alert('⚠️ الرجاء إدخال اسم الروشتة');
                return;
            }
            
            if (!rx) {
                alert('⚠️ الرجاء إدخال محتوى الروشتة (Rx)');
                return;
            }
            
            const imageData = currentPrescriptionImage ? {
                src: currentPrescriptionImage,
                scale: currentPrescriptionImageScale,
                position: currentPrescriptionImagePosition
            } : null;
            
            if (editingPrescriptionId) {
                // Edit existing prescription
                const index = prescriptions.findIndex(p => p.id === editingPrescriptionId);
                if (index !== -1) {
                    prescriptions[index] = {
                        ...prescriptions[index],
                        name,
                        categoryId,
                        rx,
                        notes,
                        image: imageData
                    };
                    console.log('✏️ Updated prescription:', prescriptions[index]);
                }
            } else {
                // Add new prescription
                const newPrescription = {
                    id: Date.now(),
                    name,
                    categoryId,
                    rx,
                    notes,
                    image: imageData,
                    createdAt: new Date().toISOString()
                };
                prescriptions.push(newPrescription);
                console.log('➕ Added new prescription:', newPrescription);
                console.log('📊 Total prescriptions:', prescriptions.length);
            }
            
            // Save to localStorage
            localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
            
            // CRITICAL: Reload from localStorage to ensure sync
            prescriptions = JSON.parse(localStorage.getItem('prescriptions')) || [];
            
            console.log('💾 Saved to localStorage');
            console.log('🔄 Reloaded from localStorage:', prescriptions.length, 'prescriptions');
            
            // Update UI
            renderPrescriptions();
            renderCategories();
            updateCategorySelect();
            
            // Close modal
            closePrescriptionModal();
            
            console.log('✅ Prescription saved successfully');
        }

        function editPrescription(prescriptionId) {
            const prescription = prescriptions.find(p => p.id === prescriptionId);
            if (prescription) {
                editingPrescriptionId = prescriptionId;
                document.getElementById('prescriptionModal').classList.add('active');
                document.getElementById('prescriptionModalTitle').textContent = 'تعديل الروشتة';
                document.getElementById('prescriptionNameInput').value = prescription.name;
                document.getElementById('prescriptionCategoryInput').value = prescription.categoryId;
                document.getElementById('prescriptionRxInput').value = prescription.rx;
                document.getElementById('prescriptionNotesInput').value = prescription.notes;
                
                // Load Rx content into editor
                syncRxInputToEditor();
                
                // Load image if exists
                if (prescription.image) {
                    currentPrescriptionImage = prescription.image.src;
                    currentPrescriptionImageScale = prescription.image.scale;
                    currentPrescriptionImagePosition = prescription.image.position;
                    
                    const container = document.getElementById('prescriptionImageContainer');
                    const preview = document.getElementById('prescriptionImagePreview');
                    
                    container.style.display = 'block';
                    preview.src = currentPrescriptionImage;
                    preview.style.transform = `translate(${currentPrescriptionImagePosition.x}px, ${currentPrescriptionImagePosition.y}px) scale(${currentPrescriptionImageScale})`;
                } else {
                    currentPrescriptionImage = null;
                    document.getElementById('prescriptionImageContainer').style.display = 'none';
                }
            }
        }

        function deletePrescription(prescriptionId) {
            if (confirm('هل أنت متأكد من حذف هذه الروشتة؟ سيتم نقلها إلى سلة المحذوفات.')) {
                const prescription = prescriptions.find(p => p.id === prescriptionId);
                if (prescription) {
                    prescription.deletedAt = new Date().toISOString();
                    trashedPrescriptions.push(prescription);
                    prescriptions = prescriptions.filter(p => p.id !== prescriptionId);
                    
                    localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                    localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                    
                    renderPrescriptions();
                    renderCategories();
                    updateTrashCounts();
                }
            }
        }

        function viewPrescription(prescriptionId) {
            // 🔥 CRITICAL: Close ALL open modals first to prevent stacking
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            ensureScrollEnabled();
            
            const prescription = prescriptions.find(p => p.id === prescriptionId);
            if (prescription) {
                viewingPrescriptionId = prescriptionId;
                
                const modal = document.getElementById('viewPrescriptionModal');
                const modalContent = modal.querySelector('.modal-content');
                
                modal.classList.add('active');
                document.getElementById('viewPrescriptionTitle').textContent = prescription.name;
                // Display HTML formatted content
                document.getElementById('viewPrescriptionRx').innerHTML = prescription.rx;
                document.getElementById('viewPrescriptionNotes').textContent = prescription.notes || 'لا توجد ملاحظات';
                
                // Add category background if exists
                const category = categories.find(c => c.id === prescription.categoryId);
                if (category && category.bgImage) {
                    modalContent.classList.add('has-category-bg');
                    modalContent.style.backgroundImage = `url('${category.bgImage}')`;
                } else {
                    modalContent.classList.remove('has-category-bg');
                    modalContent.style.backgroundImage = '';
                }
                
                // Show image if exists
                const imageSection = document.getElementById('viewPrescriptionImageSection');
                if (prescription.image) {
                    imageSection.style.display = 'block';
                    document.getElementById('viewPrescriptionImage').src = prescription.image.src;
                } else {
                    imageSection.style.display = 'none';
                }
                
                disableScroll(); // Prevent background scroll
            }
        }

        function closeViewPrescriptionModal() {
            const modal = document.getElementById('viewPrescriptionModal');
            const modalContent = modal.querySelector('.modal-content');
            
            modal.classList.remove('active');
            modalContent.classList.remove('has-category-bg');
            modalContent.style.backgroundImage = '';
            viewingPrescriptionId = null;
            document.body.classList.remove('modal-open'); // Restore background scroll
        }

        function editPrescriptionFromView() {
            const prescId = viewingPrescriptionId;
            console.log('✏️ Edit from view - Prescription ID:', prescId);
            
            // Close view modal
            closeViewPrescriptionModal();
            
            // Wait for modal to close, then open edit modal
            setTimeout(() => {
                console.log('🔄 Opening edit modal for prescription:', prescId);
                
                const prescription = prescriptions.find(p => p.id === prescId);
                if (!prescription) {
                    console.error('❌ Prescription not found:', prescId);
                    return;
                }
                
                // Set editing mode
                editingPrescriptionId = prescId;
                
                // Translate modal title
                const t = translations[currentLanguage];
                document.getElementById('prescriptionModalTitle').textContent = t.editPrescription;
                
                // Fill form fields
                document.getElementById('prescriptionNameInput').value = prescription.name;
                document.getElementById('prescriptionCategoryInput').value = prescription.categoryId;
                document.getElementById('prescriptionRxInput').value = prescription.rx || '';
                document.getElementById('prescriptionNotesInput').value = prescription.notes || '';
                
                // Load Rx content into editor
                syncRxInputToEditor();
                
                // Load image if exists
                if (prescription.image) {
                    currentPrescriptionImage = prescription.image.src;
                    currentPrescriptionImageScale = prescription.image.scale || 1;
                    currentPrescriptionImagePosition = prescription.image.position || {x: 0, y: 0};
                    
                    const container = document.getElementById('prescriptionImageContainer');
                    const preview = document.getElementById('prescriptionImagePreview');
                    
                    container.style.display = 'block';
                    preview.src = currentPrescriptionImage;
                    preview.style.transform = `translate(${currentPrescriptionImagePosition.x}px, ${currentPrescriptionImagePosition.y}px) scale(${currentPrescriptionImageScale})`;
                } else {
                    currentPrescriptionImage = null;
                    document.getElementById('prescriptionImageContainer').style.display = 'none';
                }
                
                // Show edit modal
                document.getElementById('prescriptionModal').classList.add('active');
                console.log('✅ Edit modal opened successfully!');
            }, 300);
        }

        function renderPrescriptions() {
            const grid = document.getElementById('prescriptionsGrid');
            if (!grid) {
                console.error('❌ prescriptionsGrid element not found!');
                return;
            }
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            console.log('═══════════════════════════════════');
            console.log('🔄 RENDERING PRESCRIPTIONS');
            console.log('📊 Total in array:', prescriptions.length);
            console.log('🎯 Current category:', currentCategory, typeof currentCategory);
            console.log('═══════════════════════════════════');
            
            // Get IDs of deleted categories
            const deletedCategoryIds = trashedCategories.map(c => c.id);
            console.log('🗑️ Deleted category IDs:', deletedCategoryIds);
            
            // Filter out prescriptions that belong to deleted categories
            let filteredPrescriptions = prescriptions.filter(p => {
                if (p.categoryId === null || p.categoryId === undefined) return true;
                return !deletedCategoryIds.includes(p.categoryId);
            });
            
            console.log('✅ After deleted filter:', filteredPrescriptions.length);
            
            // Filter by category
            if (currentCategory !== 'all') {
                console.log('🔍 Filtering by category...');
                const beforeFilter = filteredPrescriptions.length;
                filteredPrescriptions = filteredPrescriptions.filter(p => {
                    const match = p.categoryId == currentCategory; // loose equality
                    console.log(`  - ${p.name}: categoryId=${p.categoryId} (${typeof p.categoryId}), currentCategory=${currentCategory} (${typeof currentCategory}), match=${match}`);
                    return match;
                });
                console.log(`📉 Filtered from ${beforeFilter} to ${filteredPrescriptions.length}`);
            } else {
                console.log('📋 Showing ALL prescriptions (currentCategory="all")');
            }
            
            // Filter by search
            if (searchTerm) {
                filteredPrescriptions = filteredPrescriptions.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.rx && p.rx.toLowerCase().includes(searchTerm)) ||
                    (p.notes && p.notes.toLowerCase().includes(searchTerm))
                );
                console.log('🔎 After search filter:', filteredPrescriptions.length);
            }
            
            if (filteredPrescriptions.length === 0) {
                console.log('⚠️ No prescriptions to show');
                const t = translations[currentLanguage];
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <h3>${t.noPrescriptions}</h3>
                        <p>${t.startAdding}</p>
                    </div>
                `;
                return;
            }
            
            console.log('🎨 Building HTML for', filteredPrescriptions.length, 'cards...');
            let html = '';
            filteredPrescriptions.forEach((prescription, index) => {
                const category = categories.find(c => c.id == prescription.categoryId);
                const rxPreview = prescription.rx ? prescription.rx.substring(0, 100) + (prescription.rx.length > 100 ? '...' : '') : '';
                
                const imageHtml = prescription.image ? `<img src="${prescription.image.src}" class="image-in-card" alt="صورة الروشتة">` : '';
                
                html += `
                    <div class="prescription-card" onclick="viewPrescription(${prescription.id})" data-prescription-id="${prescription.id}">
                        ${imageHtml}
                        <h3>💊 ${prescription.name}</h3>
                        <p style="color: var(--primary); font-size: 0.9em; margin-bottom: 10px;">📁 ${category ? category.name : 'غير مصنف'}</p>
                        <div class="prescription-preview">${rxPreview}</div>
                        <div class="prescription-actions-mini" onclick="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                            <button class="btn-icon btn-icon-star" onclick="toggleFavorite(${prescription.id})" ontouchend="toggleFavorite(${prescription.id})" title="${prescription.isFavorite ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}">${prescription.isFavorite ? '⭐' : '☆'}</button>
                            <button class="btn-icon btn-icon-edit" onclick="handleEditPrescription(${prescription.id})" ontouchend="handleEditPrescription(${prescription.id})" title="تعديل">✏️</button>
                            <button class="btn-icon btn-icon-delete" onclick="handleDeletePrescription(${prescription.id})" ontouchend="handleDeletePrescription(${prescription.id})" title="حذف">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            console.log('✅ RENDERED', filteredPrescriptions.length, 'CARDS');
            console.log('═══════════════════════════════════\n');
        }

        // Favorites Functions
        function toggleFavorite(prescriptionId) {
            const prescription = prescriptions.find(p => p.id === prescriptionId);
            if (prescription) {
                prescription.isFavorite = !prescription.isFavorite;
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                
                // Re-render current view
                if (currentTab === 'prescriptions') {
                    renderPrescriptions();
                } else if (currentTab === 'favorites') {
                    renderFavorites();
                }
                
                // Update favorites count badge
                updateFavoritesCount();
            }
        }
        
        function updateFavoritesCount() {
            updateBadgeCounts();
        }

        function renderFavorites() {
            const grid = document.getElementById('prescriptionsGrid');  // Use main grid
            const list = document.getElementById('favoritesList');
            if (!grid || !list) return;
            
            const searchTerm = document.getElementById('searchFavoritesInput').value.toLowerCase();
            
            // Get favorite prescriptions
            let favoritePrescriptions = prescriptions.filter(p => p.isFavorite);
            
            // Filter by search
            if (searchTerm) {
                favoritePrescriptions = favoritePrescriptions.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.rx && p.rx.toLowerCase().includes(searchTerm)) ||
                    (p.notes && p.notes.toLowerCase().includes(searchTerm))
                );
            }
            
            // Render sidebar list
            if (favoritePrescriptions.length === 0) {
                list.innerHTML = `
                    <div style="padding: 15px; background: var(--bg-card); border-radius: 8px; text-align: center;">
                        <p style="color: var(--text-light); font-size: 0.9em;">لا توجد روشتات مفضلة</p>
                    </div>
                `;
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⭐</div>
                        <h3>لا توجد روشتات مفضلة</h3>
                        <p>اضغط على النجمة ☆ في أي روشتة لإضافتها للمفضلة</p>
                    </div>
                `;
                return;
            }
            
            // Render sidebar list - names only
            let listHtml = '';
            favoritePrescriptions.forEach(prescription => {
                listHtml += `
                    <div class="favorite-list-item" onclick="viewPrescription(${prescription.id})" style="padding: 10px 15px; background: var(--bg-card); border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.1em;">⭐</span>
                            <span style="color: var(--text-dark); font-size: 0.95em;">${prescription.name}</span>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = listHtml;
            
            // Add hover effect via CSS
            const style = document.createElement('style');
            style.textContent = `
                .favorite-list-item:hover {
                    background: var(--primary-light) !important;
                    border-color: var(--primary) !important;
                    transform: translateX(-5px);
                }
            `;
            if (!document.getElementById('favorites-list-style')) {
                style.id = 'favorites-list-style';
                document.head.appendChild(style);
            }
            
            // Render main grid - full cards
            let gridHtml = '';
            favoritePrescriptions.forEach(prescription => {
                const category = categories.find(c => c.id == prescription.categoryId);
                const rxPreview = prescription.rx ? prescription.rx.substring(0, 100) + (prescription.rx.length > 100 ? '...' : '') : '';
                const imageHtml = prescription.image ? `<img src="${prescription.image.src}" class="image-in-card" alt="صورة الروشتة">` : '';
                
                gridHtml += `
                    <div class="prescription-card" onclick="viewPrescription(${prescription.id})" data-prescription-id="${prescription.id}">
                        ${imageHtml}
                        <h3>💊 ${prescription.name}</h3>
                        <p style="color: var(--primary); font-size: 0.9em; margin-bottom: 10px;">📁 ${category ? category.name : 'غير مصنف'}</p>
                        <div class="prescription-preview">${rxPreview}</div>
                        <div class="prescription-actions-mini" onclick="event.stopPropagation();" ontouchstart="event.stopPropagation();">
                            <button class="btn-icon btn-icon-star" onclick="toggleFavorite(${prescription.id})" ontouchend="toggleFavorite(${prescription.id})" title="إزالة من المفضلة">⭐</button>
                            <button class="btn-icon btn-icon-edit" onclick="handleEditPrescription(${prescription.id})" ontouchend="handleEditPrescription(${prescription.id})" title="تعديل">✏️</button>
                            <button class="btn-icon btn-icon-delete" onclick="handleDeletePrescription(${prescription.id})" ontouchend="handleDeletePrescription(${prescription.id})" title="حذف">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = gridHtml;
        }

        // Notes Functions
        function updateNotesCount() {
            const notesCountEl = document.getElementById('notesCount');
            if (notesCountEl) {
                notesCountEl.textContent = notes.length;
            }
        }

        function openAddNoteModal() {
            editingNoteId = null;
            currentNoteImage = null;
            currentNoteImageScale = 1;
            currentNoteImagePosition = {x: 0, y: 0};
            
            document.getElementById('noteModal').classList.add('active');
            document.getElementById('noteModalTitle').textContent = 'إضافة ملاحظة جديدة';
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentInput').value = '';
            document.getElementById('noteImageContainer').style.display = 'none';
            document.getElementById('noteImageInput').value = '';
            disableScroll();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            editingNoteId = null;
            document.body.classList.remove('modal-open');
        }

        function saveNote(event) {
            event.preventDefault();
            
            const title = document.getElementById('noteTitleInput').value.trim();
            const content = document.getElementById('noteContentInput').value.trim();
            
            const imageData = currentNoteImage ? {
                src: currentNoteImage,
                scale: currentNoteImageScale,
                position: currentNoteImagePosition
            } : null;
            
            if (editingNoteId) {
                // Edit existing note
                const index = notes.findIndex(n => n.id === editingNoteId);
                notes[index] = {
                    ...notes[index],
                    title,
                    content,
                    image: imageData,
                    updatedAt: new Date().toISOString()
                };
            } else {
                // Add new note
                const newNote = {
                    id: Date.now(),
                    title,
                    content,
                    image: imageData,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                notes.push(newNote);
            }
            
            localStorage.setItem('notes', JSON.stringify(notes));
            closeNoteModal();
            
            // Update UI after closing modal
            setTimeout(() => {
                renderNotesPopup();
                updateNotesCount();
                updateBadgeCounts();
            }, 100);
        }

        function editNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                editingNoteId = noteId;
                document.getElementById('noteModal').classList.add('active');
                document.getElementById('noteModalTitle').textContent = 'تعديل الملاحظة';
                document.getElementById('noteTitleInput').value = note.title;
                document.getElementById('noteContentInput').value = note.content;
                
                // Load image if exists
                if (note.image) {
                    currentNoteImage = note.image.src;
                    currentNoteImageScale = note.image.scale;
                    currentNoteImagePosition = note.image.position;
                    
                    const container = document.getElementById('noteImageContainer');
                    const preview = document.getElementById('noteImagePreview');
                    
                    container.style.display = 'block';
                    preview.src = currentNoteImage;
                    preview.style.transform = `translate(${currentNoteImagePosition.x}px, ${currentNoteImagePosition.y}px) scale(${currentNoteImageScale})`;
                } else {
                    currentNoteImage = null;
                    document.getElementById('noteImageContainer').style.display = 'none';
                }
            }
        }

        function deleteNote(noteId) {
            if (confirm('هل أنت متأكد من حذف هذه الملاحظة؟ سيتم نقلها إلى سلة المحذوفات.')) {
                const noteIndex = notes.findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    const note = notes[noteIndex];
                    note.deletedAt = new Date().toISOString();
                    
                    // Remove from notes array
                    notes.splice(noteIndex, 1);
                    
                    // Add to trash
                    trashedNotes.push(note);
                    
                    // Save to localStorage
                    localStorage.setItem('notes', JSON.stringify(notes));
                    localStorage.setItem('trashedNotes', JSON.stringify(trashedNotes));
                    
                    // Update UI immediately
                    renderNotesPopup();
                    updateNotesCount();
                    updateTrashCounts();
                    updateBadgeCounts();
                }
            }
        }

        function viewNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                viewingNoteId = noteId;
                document.getElementById('viewNoteModal').classList.add('active');
                disableScroll();
                document.getElementById('viewNoteTitle').textContent = note.title;
                document.getElementById('viewNoteContent').textContent = note.content;
                const date = new Date(note.createdAt).toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('viewNoteDate').textContent = date;
                
                // Show image if exists
                const imageSection = document.getElementById('viewNoteImageSection');
                if (note.image) {
                    imageSection.style.display = 'block';
                    document.getElementById('viewNoteImage').src = note.image.src;
                } else {
                    imageSection.style.display = 'none';
                }
            }
        }

        function closeViewNoteModal() {
            document.getElementById('viewNoteModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            viewingNoteId = null;
        }

        function editNoteFromView() {
            closeViewNoteModal();
            editNote(viewingNoteId);
        }

        function renderNotes() {
            const grid = document.getElementById('prescriptionsGrid');
            const searchTerm = document.getElementById('searchNotesInput').value.toLowerCase();
            
            let filteredNotes = notes;
            
            // Filter by search
            if (searchTerm) {
                filteredNotes = filteredNotes.filter(n => 
                    n.title.toLowerCase().includes(searchTerm) ||
                    n.content.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredNotes.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <h3>${searchTerm ? 'لا توجد نتائج' : 'لا توجد ملاحظات بعد'}</h3>
                        <p>${searchTerm ? 'جرب البحث بكلمات أخرى' : 'ابدأ بإضافة ملاحظة جديدة'}</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            filteredNotes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            let html = '';
            filteredNotes.forEach(note => {
                const contentPreview = note.content.substring(0, 100) + (note.content.length > 100 ? '...' : '');
                const date = new Date(note.createdAt).toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const imageHtml = note.image ? `<img src="${note.image.src}" class="image-in-card" alt="صورة الملاحظة">` : '';
                
                html += `
                    <div class="note-card" onclick="viewNote(${note.id})">
                        ${imageHtml}
                        <h3>📝 ${note.title}</h3>
                        <p style="color: var(--warning); font-size: 0.85em; margin-bottom: 10px;">📅 ${date}</p>
                        <div class="note-preview">${contentPreview}</div>
                        <div class="prescription-actions">
                            <button class="btn btn-edit" onclick="event.stopPropagation(); editNote(${note.id})">✏️ تعديل</button>
                            <button class="btn btn-delete" onclick="event.stopPropagation(); deleteNote(${note.id})">🗑️ حذف</button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // Trash Functions
        function updateTrashCounts() {
            const trashPrescEl = document.getElementById('trashPrescriptionsCount');
            if (trashPrescEl) {
                trashPrescEl.textContent = trashedPrescriptions.length;
            }
            
            const trashCatsEl = document.getElementById('trashCategoriesCount');
            if (trashCatsEl) {
                trashCatsEl.textContent = trashedCategories.length;
            }
            
            const trashNotesEl = document.getElementById('trashNotesCount');
            if (trashNotesEl) {
                trashNotesEl.textContent = trashedNotes.length;
            }
        }

        function renderTrash() {
            const grid = document.getElementById('prescriptionsGrid');
            const t = translations[currentLanguage];
            
            if (trashedPrescriptions.length === 0 && trashedCategories.length === 0 && trashedNotes.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🗑️</div>
                        <h3>${t.trashEmpty}</h3>
                        <p>${t.noDeletedItems}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Render trashed categories
            trashedCategories.forEach(category => {
                const deletedDate = new Date(category.deletedAt).toLocaleDateString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US');
                const prescriptionsInCategory = prescriptions.filter(p => p.categoryId === category.id).length;
                
                html += `
                    <div class="prescription-card" style="border-color: var(--danger); opacity: 0.8;">
                        <h3>📁 ${category.name}</h3>
                        <p style="color: var(--danger); font-size: 0.85em; margin-bottom: 10px;">🗑️ ${t.deletedOn} ${deletedDate}</p>
                        <p style="color: var(--text-light); font-size: 0.9em;">${t.categoryContains} ${prescriptionsInCategory} ${t.prescriptionsCount}</p>
                        <div class="prescription-actions">
                            <button class="btn btn-edit" onclick="event.stopPropagation(); restoreCategory(${category.id})">↩️ ${t.restoreCategoryAndPrescriptions}</button>
                            <button class="btn btn-delete" onclick="event.stopPropagation(); deleteCategoryPermanently(${category.id})">🗑️ ${t.deletePermanently}</button>
                        </div>
                    </div>
                `;
            });
            
            // Render trashed prescriptions (only those NOT belonging to deleted categories)
            const deletedCategoryIds = trashedCategories.map(c => c.id);
            trashedPrescriptions.forEach(prescription => {
                // Skip if prescription belongs to a deleted category OR was deleted with category
                if (deletedCategoryIds.includes(prescription.categoryId) || prescription.deletedWithCategory) {
                    return;
                }
                
                const deletedDate = new Date(prescription.deletedAt).toLocaleDateString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US');
                
                html += `
                    <div class="prescription-card" style="border-color: var(--danger); opacity: 0.8;">
                        <h3>💊 ${prescription.name}</h3>
                        <p style="color: var(--danger); font-size: 0.85em; margin-bottom: 10px;">🗑️ ${t.deletedOn} ${deletedDate}</p>
                        <p style="color: var(--primary); font-size: 0.9em; margin-bottom: 10px;">📁 ${t.uncategorized}</p>
                        <div class="prescription-actions">
                            <button class="btn btn-edit" onclick="event.stopPropagation(); restorePrescription(${prescription.id})">↩️ ${t.restore}</button>
                            <button class="btn btn-delete" onclick="event.stopPropagation(); deletePrescriptionPermanently(${prescription.id})">🗑️ ${t.deletePermanently}</button>
                        </div>
                    </div>
                `;
            });
            
            // Render trashed notes
            trashedNotes.forEach(note => {
                const deletedDate = new Date(note.deletedAt).toLocaleDateString(currentLanguage === 'ar' ? 'ar-EG' : 'en-US');
                
                html += `
                    <div class="note-card" style="border-color: var(--danger); opacity: 0.8;">
                        <h3>📝 ${note.title}</h3>
                        <p style="color: var(--danger); font-size: 0.85em; margin-bottom: 10px;">🗑️ ${t.deletedOn} ${deletedDate}</p>
                        <div class="prescription-actions">
                            <button class="btn btn-edit" onclick="event.stopPropagation(); restoreNote(${note.id})">↩️ ${t.restore}</button>
                            <button class="btn btn-delete" onclick="event.stopPropagation(); deleteNotePermanently(${note.id})">🗑️ حذف نهائي</button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        function restoreCategory(categoryId) {
            const category = trashedCategories.find(c => c.id === categoryId);
            if (category) {
                delete category.deletedAt;
                delete category.prescriptionsCount;
                categories.push(category);
                trashedCategories = trashedCategories.filter(c => c.id !== categoryId);
                
                // Restore all prescriptions that were deleted with this category
                const categoryPrescriptions = trashedPrescriptions.filter(p => p.categoryId === categoryId && p.deletedWithCategory);
                categoryPrescriptions.forEach(presc => {
                    delete presc.deletedAt;
                    delete presc.deletedWithCategory;
                    prescriptions.push(presc);
                });
                trashedPrescriptions = trashedPrescriptions.filter(p => !(p.categoryId === categoryId && p.deletedWithCategory));
                
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('trashedCategories', JSON.stringify(trashedCategories));
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                
                renderCategories();
                updateCategorySelect();
                renderPrescriptions();
                renderTrash();
                updateTrashCounts();
            }
        }

        function restorePrescription(prescriptionId) {
            const prescription = trashedPrescriptions.find(p => p.id === prescriptionId);
            if (prescription) {
                delete prescription.deletedAt;
                prescriptions.push(prescription);
                trashedPrescriptions = trashedPrescriptions.filter(p => p.id !== prescriptionId);
                
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                
                renderTrash();
                updateTrashCounts();
            }
        }

        function restoreNote(noteId) {
            const note = trashedNotes.find(n => n.id === noteId);
            if (note) {
                delete note.deletedAt;
                notes.push(note);
                trashedNotes = trashedNotes.filter(n => n.id !== noteId);
                
                localStorage.setItem('notes', JSON.stringify(notes));
                localStorage.setItem('trashedNotes', JSON.stringify(trashedNotes));
                
                renderTrash();
                updateTrashCounts();
                updateNotesCount();
            }
        }

        function deleteCategoryPermanently(categoryId) {
            if (confirm('هل أنت متأكد من الحذف النهائي؟ سيتم حذف الفئة وجميع روشتاتها للأبد ولن تتمكن من استرجاعها.')) {
                // Delete the category
                trashedCategories = trashedCategories.filter(c => c.id !== categoryId);
                
                // Also delete all prescriptions in this category permanently
                prescriptions = prescriptions.filter(p => p.categoryId !== categoryId);
                
                localStorage.setItem('trashedCategories', JSON.stringify(trashedCategories));
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                
                renderTrash();
                updateTrashCounts();
            }
        }

        function deletePrescriptionPermanently(prescriptionId) {
            if (confirm('هل أنت متأكد من الحذف النهائي؟ لن تتمكن من استرجاع هذه الروشتة.')) {
                // Remove from trashed
                trashedPrescriptions = trashedPrescriptions.filter(p => p.id !== prescriptionId);
                // Also remove from main array if exists
                prescriptions = prescriptions.filter(p => p.id !== prescriptionId);
                
                localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                
                renderTrash();
                renderPrescriptions();
                updateTrashCounts();
            }
        }

        function deleteNotePermanently(noteId) {
            if (confirm('هل أنت متأكد من الحذف النهائي؟ لن تتمكن من استرجاع هذه الملاحظة.')) {
                trashedNotes = trashedNotes.filter(n => n.id !== noteId);
                localStorage.setItem('trashedNotes', JSON.stringify(trashedNotes));
                renderTrash();
                updateTrashCounts();
            }
        }

        function emptyTrash() {
            if (confirm('هل أنت متأكد من إفراغ سلة المحذوفات نهائياً؟ سيتم حذف كل العناصر للأبد.')) {
                trashedPrescriptions = [];
                trashedCategories = [];
                trashedNotes = [];
                
                localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                localStorage.setItem('trashedCategories', JSON.stringify(trashedCategories));
                localStorage.setItem('trashedNotes', JSON.stringify(trashedNotes));
                
                renderTrash();
                updateTrashCounts();
            }
        }
        
        function refreshTrash() {
            updateTrashCounts();
            renderTrash();
        }

        // Combined Font Modal
        function openFontSettingsModal() {
            document.getElementById('fontSettingsModal').classList.add('active');
            
            // Load prescription font settings - with null checks
            const rxSlider = document.getElementById('rxFontSizeSlider');
            const rxValue = document.getElementById('rxFontSizeValue');
            if (rxSlider) rxSlider.value = prescriptionFontSize;
            if (rxValue) rxValue.textContent = prescriptionFontSize + 'px';
            
            document.querySelectorAll('.rx-color-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-color') === prescriptionFontColor) {
                    btn.classList.add('active');
                }
            });
            
            // Load app font settings - with null checks
            const appSlider = document.getElementById('appFontSizeSlider2');
            const appValue = document.getElementById('appFontSizeValue2');
            if (appSlider) appSlider.value = appFontSize;
            if (appValue) appValue.textContent = appFontSize + 'px';
            
            document.querySelectorAll('.app-color-btn2').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-color') === appFontColor) {
                    btn.classList.add('active');
                }
            });
            
            // Load button size settings
            document.querySelectorAll('.size-option-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-size') === buttonSize) {
                    btn.classList.add('active');
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.background = 'linear-gradient(135deg, var(--primary-light) 0%, var(--bg-card) 100%)';
                } else {
                    btn.style.borderColor = 'var(--border)';
                    btn.style.background = 'var(--bg-card)';
                }
            });
            
            disableScroll();
        }

        function closeFontSettingsModal() {
            document.getElementById('fontSettingsModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            ensureScrollEnabled();
        }

        // Settings Menu Functions
        let savedScrollPosition = 0;
        
        function openSettingsMenu() {
            savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
            document.getElementById('settingsMenuModal').classList.add('active');
            disableScroll();
        }
        
        function closeSettingsMenu() {
            document.getElementById('settingsMenuModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            
            // Force scroll restoration with multiple attempts
            const scrollPos = savedScrollPosition;
            
            // Immediate restoration
            window.scrollTo(0, scrollPos);
            
            // Second attempt after 10ms
            setTimeout(() => {
                window.scrollTo(0, scrollPos);
            }, 10);
            
            // Third attempt after 50ms (ensure body overflow is restored)
            setTimeout(() => {
                window.scrollTo(0, scrollPos);
                document.documentElement.scrollTop = scrollPos;
            }, 50);
            
            // Final attempt after 100ms
            setTimeout(() => {
                window.scrollTo(0, scrollPos);
                ensureScrollEnabled();
            }, 100);
        }
        
        // Font Customization Functions
        function openFontModal() {
            document.getElementById('fontModal').classList.add('active');
            disableScroll();
        }

        function closeFontModal() {
            document.getElementById('fontModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function changeFontSize(size) {
            prescriptionFontSize = size;
            localStorage.setItem('prescriptionFontSize', size);
            
            const fontSizeValue = document.getElementById('fontSizeValue');
            const rxFontSizeValue = document.getElementById('rxFontSizeValue');
            
            if (fontSizeValue) fontSizeValue.textContent = size + 'px';
            if (rxFontSizeValue) rxFontSizeValue.textContent = size + 'px';
            
            applyFontSettings();
        }

        function changeFontColor(color) {
            prescriptionFontColor = color;
            localStorage.setItem('prescriptionFontColor', color);
            
            // Update active color button in both modals
            document.querySelectorAll('.color-btn, .rx-color-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-color') === color) {
                    btn.classList.add('active');
                }
            });
            
            applyFontSettings();
        }

        // App Font Settings
        let appFontSize = localStorage.getItem('appFontSize') || '16';
        let appFontColor = localStorage.getItem('appFontColor') || '#1f2937';
        let buttonSize = localStorage.getItem('buttonSize') || 'md';

        function openAppFontModal() {
            document.getElementById('appFontModal').classList.add('active');
            document.getElementById('appFontSizeSlider').value = appFontSize;
            document.getElementById('appFontSizeValue').textContent = appFontSize + 'px';
            
            // Update active color
            document.querySelectorAll('#appFontModal .app-color-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-color') === appFontColor) {
                    btn.classList.add('active');
                }
            });
            
            disableScroll();
        }

        function closeAppFontModal() {
            document.getElementById('appFontModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function changeAppFontSize(size) {
            appFontSize = size;
            localStorage.setItem('appFontSize', size);
            const elem1 = document.getElementById('appFontSizeValue');
            const elem2 = document.getElementById('appFontSizeValue2');
            if (elem1) elem1.textContent = size + 'px';
            if (elem2) elem2.textContent = size + 'px';
            applyAppFontSettings();
        }

        function changeAppFontColor(color) {
            appFontColor = color;
            localStorage.setItem('appFontColor', color);
            
            document.querySelectorAll('.app-color-btn, .app-color-btn2').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-color') === color) {
                    btn.classList.add('active');
                }
            });
            
            applyAppFontSettings();
        }

        function applyAppFontSettings() {
            const style = document.createElement('style');
            style.id = 'app-font-style';
            
            const oldStyle = document.getElementById('app-font-style');
            if (oldStyle) {
                oldStyle.remove();
            }
            
            style.textContent = `
                body, header h1, header p, .category-item, 
                .tab-button, .search-box input, button, .prescription-card h3, .prescription-card p,
                .note-card h3, .note-card p, .settings-menu-btn h3, .settings-menu-btn p {
                    font-size: ${appFontSize}px !important;
                    color: ${appFontColor} !important;
                }
                
                /* ✅ FORCE white text on colored backgrounds */
                .add-category-btn,
                .add-prescription-btn,
                .tab-button.active,
                .category-item.active,
                .category-item.active *,
                .category-item.active .category-count {
                    color: white !important;
                }
                
                header h1 {
                    font-size: calc(${appFontSize}px * 1.5) !important;
                    color: white !important;
                }
                
                header p {
                    font-size: calc(${appFontSize}px * 0.9) !important;
                    color: rgba(255,255,255,0.9) !important;
                }
            `;
            
            document.head.appendChild(style);
        }

        // Button Size Settings
        function openButtonSizeModal() {
            document.getElementById('buttonSizeModal').classList.add('active');
            
            document.querySelectorAll('.size-option-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-size') === buttonSize) {
                    btn.classList.add('active');
                }
            });
            
            disableScroll();
        }

        function closeButtonSizeModal() {
            document.getElementById('buttonSizeModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }

        function changeButtonSize(size) {
            buttonSize = size;
            localStorage.setItem('buttonSize', size);
            
            document.querySelectorAll('.size-option-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-size') === size) {
                    btn.classList.add('active');
                    btn.style.borderColor = 'var(--primary)';
                    btn.style.background = 'linear-gradient(135deg, var(--primary-light) 0%, var(--bg-card) 100%)';
                } else {
                    btn.style.borderColor = 'var(--border)';
                    btn.style.background = 'var(--bg-card)';
                }
            });
            
            applyButtonSize();
        }

        function applyButtonSize() {
            const sizes = {
                'xs': { padding: '8px 12px', fontSize: '0.75em' },
                'sm': { padding: '10px 16px', fontSize: '0.85em' },
                'md': { padding: '14px 20px', fontSize: '1em' },
                'lg': { padding: '18px 24px', fontSize: '1.1em' },
                'xl': { padding: '22px 30px', fontSize: '1.2em' }
            };
            
            const style = document.createElement('style');
            style.id = 'button-size-style';
            
            const oldStyle = document.getElementById('button-size-style');
            if (oldStyle) {
                oldStyle.remove();
            }
            
            const sizeConfig = sizes[buttonSize];
            
            style.textContent = `
                .add-category-btn, .add-prescription-btn, .tab-button, 
                .btn-primary, .btn-secondary, .btn, .quick-btn,
                .settings-menu-btn, .theme-card {
                    padding: ${sizeConfig.padding} !important;
                    font-size: ${sizeConfig.fontSize} !important;
                }
            `;
            
            document.head.appendChild(style);
        }

        function applyFontSettings() {
            // Apply to view prescription modal content
            const style = document.createElement('style');
            style.id = 'custom-font-style';
            
            // Remove old style if exists
            const oldStyle = document.getElementById('custom-font-style');
            if (oldStyle) {
                oldStyle.remove();
            }
            
            style.textContent = `
                .view-prescription-modal .section-content {
                    font-size: ${prescriptionFontSize}px !important;
                    color: ${prescriptionFontColor} !important;
                }
                .view-prescription-modal .section h3 {
                    color: ${prescriptionFontColor} !important;
                }
            `;
            
            document.head.appendChild(style);
        }

        function loadFontSettings() {
            // Set slider value
            if (document.getElementById('fontSizeSlider')) {
                document.getElementById('fontSizeSlider').value = prescriptionFontSize;
                document.getElementById('fontSizeValue').textContent = prescriptionFontSize + 'px';
            }
            
            // Set active color button
            document.querySelectorAll('#fontModal .color-btn').forEach(btn => {
                if (btn.getAttribute('data-color') === prescriptionFontColor) {
                    btn.classList.add('active');
                }
            });
            
            applyFontSettings();
        }

        // Rx Editor Functions
        // Current formatting state
        let currentFontSize = 16;
        let currentFontFamily = 'Cairo';
        let currentTextColor = '#000000';
        
        function makeTextBold() {
            document.execCommand('bold', false, null);
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        function applyFontSizeByNumber(size) {
            currentFontSize = size;
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString()) {
                document.execCommand('fontSize', false, '7');
                const fontElements = document.querySelectorAll('#prescriptionRxEditor font[size="7"]');
                fontElements.forEach(el => {
                    el.removeAttribute('size');
                    el.style.fontSize = size + 'px';
                });
                // Keep selection
                selection.collapseToEnd();
            }
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        function applyFontFamily(fontFamily) {
            currentFontFamily = fontFamily;
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString()) {
                document.execCommand('fontName', false, fontFamily);
                // Keep selection
                selection.collapseToEnd();
            }
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        function setTextDirection(direction) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString()) {
                const div = document.createElement('div');
                div.dir = direction;
                div.style.textAlign = direction === 'rtl' ? 'right' : 'left';
                try {
                    const range = selection.getRangeAt(0);
                    const contents = range.extractContents();
                    div.appendChild(contents);
                    range.insertNode(div);
                    // Keep selection at end
                    selection.collapseToEnd();
                } catch (e) {
                    console.error(e);
                }
            }
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        function alignText(alignment) {
            const commands = {
                'right': 'justifyRight',
                'center': 'justifyCenter',
                'left': 'justifyLeft'
            };
            document.execCommand(commands[alignment], false, null);
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        // Simple exec command wrapper
        function execCmd(command) {
            document.execCommand(command, false, null);
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        function applyHighlight(color) {
            document.execCommand('hiliteColor', false, color);
            document.getElementById('prescriptionRxEditor').focus();
        }
        
        function insertImageInText(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'max-width: 300px; height: auto; border: 2px solid #ddd; border-radius: 8px; margin: 10px; cursor: pointer; display: inline-block;';
                    img.contentEditable = false;
                    
                    // Click to resize
                    img.onclick = function() {
                        const newWidth = prompt('أدخل العرض (px):', '300');
                        if (newWidth && !isNaN(newWidth)) {
                            img.style.maxWidth = newWidth + 'px';
                        }
                    };
                    
                    const editor = document.getElementById('prescriptionRxEditor');
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        range.insertNode(img);
                        range.collapse(false);
                    } else {
                        editor.appendChild(img);
                    }
                    
                    event.target.value = '';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function resizeInlineImage(btn, direction) {
            const wrapper = btn.closest('div').parentElement;
            const img = wrapper.querySelector('img');
            const currentWidth = parseInt(img.style.width) || 300;
            
            if (direction === 'bigger') {
                img.style.width = Math.min(currentWidth + 50, 800) + 'px';
            } else {
                img.style.width = Math.max(currentWidth - 50, 100) + 'px';
            }
        }
        
        function cropInlineImage(btn) {
            const wrapper = btn.closest('div').parentElement;
            const img = wrapper.querySelector('img');
            
            const aspectRatio = prompt('اختر نسبة القص:\n1 = مربع\n2 = مستطيل أفقي\n0.5 = مستطيل رأسي\n\nأو اترك فارغ للإلغاء');
            
            if (aspectRatio) {
                const ratio = parseFloat(aspectRatio);
                const currentWidth = parseInt(img.style.width) || 300;
                img.style.height = (currentWidth / ratio) + 'px';
                img.style.objectFit = 'cover';
            }
        }
        
        function deleteInlineImage(btn) {
            const wrapper = btn.closest('div').parentElement;
            wrapper.remove();
        }
        
        function applyRxColor(color) {
            currentTextColor = color;
            document.execCommand('foreColor', false, color);
            document.getElementById('prescriptionRxEditor').focus();
        }

        function clearRxFormatting() {
            const editor = document.getElementById('prescriptionRxEditor');
            const text = editor.innerText;
            editor.innerHTML = text;
        }

        function syncRxEditorToInput() {
            const editor = document.getElementById('prescriptionRxEditor');
            const input = document.getElementById('prescriptionRxInput');
            input.value = editor.innerHTML;
        }

        function syncRxInputToEditor() {
            const editor = document.getElementById('prescriptionRxEditor');
            const input = document.getElementById('prescriptionRxInput');
            if (input.value) {
                editor.innerHTML = input.value;
            }
        }

        // Update openAddPrescriptionModal to sync editor
        const originalOpenAddPrescriptionModal = openAddPrescriptionModal;
        openAddPrescriptionModal = function() {
            originalOpenAddPrescriptionModal();
            document.getElementById('prescriptionRxEditor').innerHTML = '';
        };

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                    // ✅ تأكد إن الscroll يرجع
                    setTimeout(ensureScrollEnabled, 50);
                }
            });
        });

        // PDF Export Function
        async function takeScreenshot() {
            try {
                // Get the prescription content
                const prescriptionElement = document.querySelector('.prescription-full');
                
                if (!prescriptionElement) {
                    alert('❌ لم يتم العثور على محتوى الروشتة');
                    return;
                }
                
                // Show loading overlay
                const loadingOverlay = document.createElement('div');
                loadingOverlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                loadingOverlay.innerHTML = '<div style="background: white; padding: 30px 50px; border-radius: 16px; text-align: center;"><div style="font-size: 3em; margin-bottom: 10px;">📸</div><div style="font-size: 1.2em; color: var(--text-dark);">جارٍ التقاط الصورة...</div></div>';
                document.body.appendChild(loadingOverlay);
                
                // Wait for animations
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Capture screenshot using html2canvas
                const canvas = await html2canvas(prescriptionElement, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    allowTaint: true
                });
                
                // Remove loading
                document.body.removeChild(loadingOverlay);
                
                // Convert to blob and download
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const prescription = prescriptions.find(p => p.id === viewingPrescriptionId);
                    const fileName = `روشتة-${prescription ? prescription.name.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '-') : 'screenshot'}-${new Date().toISOString().slice(0,10)}.png`;
                    
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // Show success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--primary); color: white; padding: 20px 40px; border-radius: 12px; z-index: 10000; font-size: 1.1em; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
                    successMsg.innerHTML = '<div style="font-size: 2em; margin-bottom: 5px;">✅</div><div>تم حفظ لقطة الشاشة!</div>';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.style.transition = 'all 0.3s';
                        successMsg.style.opacity = '0';
                        successMsg.style.transform = 'translate(-50%, -50%) scale(0.8)';
                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                document.body.removeChild(successMsg);
                            }
                        }, 300);
                    }, 2000);
                }, 'image/png');
                
            } catch (error) {
                console.error('Screenshot error:', error);
                alert('❌ حدث خطأ أثناء التقاط الصورة\n\nالرجاء المحاولة مرة أخرى');
            }
        }
        
        async function exportPrescriptionPDF() {
            if (!viewingPrescriptionId) return;
            
            const prescription = prescriptions.find(p => p.id === viewingPrescriptionId);
            if (!prescription) return;
            
            const category = categories.find(c => c.id === prescription.categoryId);
            
            // Wait for libraries to load
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                alert('جاري تحميل المكتبة... حاول مرة أخرى بعد ثانية');
                return;
            }
            
            try {
                // Create a temporary container for PDF content
                const container = document.createElement('div');
                container.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 190mm; padding: 20px; background: white; font-family: Cairo, Arial; direction: rtl;';
                
                // Build HTML content with exact formatting
                let html = `
                    <div style="text-align: center; margin-bottom: 30px; direction: rtl;">
                        <h1 style="color: #10b981; font-size: 28px; margin-bottom: 10px; font-family: Cairo, Arial;">${prescription.name}</h1>
                        ${category ? `<p style="color: #666; font-size: 16px; font-family: Cairo, Arial;">الفئة: ${category.name}</p>` : ''}
                    </div>
                    
                    <div style="margin-bottom: 25px; direction: rtl;">
                        <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">💊 Rx</h2>
                        <div style="font-size: 16px; line-height: 1.8; text-align: right; direction: rtl; font-family: Cairo, Arial; padding: 10px; background: #f9f9f9; border-radius: 8px; white-space: pre-wrap;">${prescription.rx}</div>
                    </div>
                `;
                
                if (prescription.notes) {
                    html += `
                        <div style="margin-bottom: 25px; direction: rtl;">
                            <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">📝 Notes</h2>
                            <div style="font-size: 16px; line-height: 1.8; text-align: right; direction: rtl; font-family: Cairo, Arial; padding: 10px; background: #f9f9f9; border-radius: 8px; white-space: pre-wrap;">${prescription.notes}</div>
                        </div>
                    `;
                }
                
                if (prescription.image) {
                    html += `
                        <div style="margin-bottom: 25px; direction: rtl; page-break-inside: avoid;">
                            <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">📷 الصورة</h2>
                            <div style="text-align: center;">
                                <img src="${prescription.image.src}" style="max-width: 100%; max-height: 400px; border-radius: 8px; margin-top: 10px;">
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                document.body.appendChild(container);
                
                // Wait for images to load
                const images = container.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    });
                }));
                
                // Convert to canvas with high quality
                const canvas = await html2canvas(container, {
                    scale: 3,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    windowWidth: container.scrollWidth,
                    windowHeight: container.scrollHeight
                });
                
                // Remove temporary container
                document.body.removeChild(container);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 297; // A4 height in mm
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let heightLeft = imgHeight;
                let position = 0;
                
                // Add first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Save
                const filename = `${prescription.name.replace(/[^a-z0-9\u0600-\u06FF]/gi, '_')}.pdf`;
                pdf.save(filename);
                
                alert('✅ تم تصدير الروشتة بنجاح!');
            } catch (error) {
                console.error('PDF export error:', error);
                alert('❌ حدث خطأ أثناء التصدير');
            }
        }
        
        // Google Drive Sync Functions
        // Google Drive Integration with OAuth 2.0
        const CLIENT_ID = '724619403043-6qj47sh10f4n6m05e61mquvvasqkpf24.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyChNHTG-424ur9Y2aCxtxtZtu5MGadthdo';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        
        async function loadGoogleDriveAPI() {
            return new Promise((resolve, reject) => {
                if (gapiInitialized) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    window.gapi.load('client:auth2', async () => {
                        try {
                            await window.gapi.client.init({
                                apiKey: API_KEY,
                                clientId: CLIENT_ID,
                                discoveryDocs: DISCOVERY_DOCS,
                                scope: SCOPES
                            });
                            googleAuth = window.gapi.auth2.getAuthInstance();
                            gapiInitialized = true;
                            
                            // Check if already signed in
                            if (googleAuth.isSignedIn.get()) {
                                isGoogleDriveConnected = true;
                                updateGoogleDriveButton(true);
                            }
                            
                            resolve();
                        } catch (error) {
                            console.error('GAPI init error:', error);
                            reject(error);
                        }
                    });
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        async function handleGoogleDriveAuth() {
            // Check if API keys are configured
            if (CLIENT_ID.includes('YOUR_CLIENT_ID') || API_KEY.includes('YOUR_API_KEY')) {
                showGoogleDriveSetupGuide();
                return;
            }
            
            try {
                if (!gapiInitialized) {
                    await loadGoogleDriveAPI();
                }
                
                if (isGoogleDriveConnected) {
                    // Already connected, show menu
                    showGoogleDriveMenu();
                } else {
                    // Sign in
                    await googleAuth.signIn();
                    isGoogleDriveConnected = true;
                    updateGoogleDriveButton(true);
                    alert('✅ تم تسجيل الدخول بنجاح!');
                    // Auto sync after login
                    syncToGoogleDrive();
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('❌ خطأ في تسجيل الدخول');
            }
        }
        
        function updateGoogleDriveButton(connected) {
            const btn = document.getElementById('googleDriveBtn');
            if (connected) {
                btn.style.background = 'linear-gradient(135deg, #34a853 0%, #0f9d58 100%)';
                btn.style.color = 'white';
                btn.querySelector('span').textContent = '✓';
                btn.title = 'متصل - اضغط للمزامنة';
            } else {
                btn.style.background = '';
                btn.style.color = '';
                btn.querySelector('span').textContent = '☁️';
                btn.title = 'تسجيل الدخول بـ Google';
            }
        }
        
        function showGoogleDriveSetupGuide() {
            if (confirm('🔧 إعداد Google Drive\n\nلم يتم تكوين API keys بعد.\n\nهل تريد استخدام Export/Import بدلاً من ذلك؟\n\n✅ نعم - افتح قسم النسخ الاحتياطي\n❌ لا')) {
                // Scroll to trash section
                document.getElementById('trashTab').click();
                setTimeout(() => {
                    document.querySelector('.content-area').scrollTop = document.querySelector('.content-area').scrollHeight;
                }, 300);
            }
        }
        
        function showGoogleDriveMenu() {
            const choice = confirm('☁️ Google Drive - اختر عملية:\n\n✅ رفع البيانات (Backup)\n❌ تحميل البيانات (Restore)');
            if (choice) {
                syncToGoogleDrive();
            } else {
                downloadFromGoogleDrive();
            }
        }
        
        async function syncToGoogleDrive() {
            if (!isGoogleDriveConnected) {
                alert('الرجاء تسجيل الدخول أولاً');
                return;
            }
            
            try {
                const allData = {
                    categories,
                    prescriptions,
                    notes,
                    trashedPrescriptions,
                    trashedCategories,
                    trashedNotes,
                    appName,
                    appDescription,
                    theme: currentTheme,
                    prescriptionFontSize,
                    prescriptionFontColor,
                    lastSync: new Date().toISOString()
                };
                
                const fileContent = JSON.stringify(allData, null, 2);
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                
                const metadata = {
                    name: 'prescription-manager-backup.json',
                    mimeType: 'application/json'
                };
                
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    fileContent +
                    close_delim;
                
                const accessToken = window.gapi.auth.getToken().access_token;
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });
                
                if (response.ok) {
                    alert('✅ تم رفع البيانات بنجاح!');
                    localStorage.setItem('lastGoogleDriveSync', new Date().toISOString());
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Sync error:', error);
                alert('❌ خطأ في الرفع');
            }
        }
        
        async function downloadFromGoogleDrive() {
            if (!isGoogleDriveConnected) {
                alert('الرجاء تسجيل الدخول أولاً');
                return;
            }
            
            try {
                const response = await window.gapi.client.drive.files.list({
                    pageSize: 10,
                    fields: 'files(id, name, modifiedTime)',
                    q: "name='prescription-manager-backup.json'"
                });
                
                const files = response.result.files;
                if (!files || files.length === 0) {
                    alert('لم يتم العثور على نسخة احتياطية');
                    return;
                }
                
                const fileId = files[0].id;
                const fileResponse = await window.gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                const data = JSON.parse(fileResponse.body);
                
                // Restore all data
                categories = data.categories || [];
                prescriptions = data.prescriptions || [];
                notes = data.notes || [];
                trashedPrescriptions = data.trashedPrescriptions || [];
                trashedCategories = data.trashedCategories || [];
                trashedNotes = data.trashedNotes || [];
                
                // Save to localStorage
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                localStorage.setItem('notes', JSON.stringify(notes));
                localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                localStorage.setItem('trashedCategories', JSON.stringify(trashedCategories));
                localStorage.setItem('trashedNotes', JSON.stringify(trashedNotes));
                
                alert('✅ تم استرجاع البيانات بنجاح!');
                location.reload();
            } catch (error) {
                console.error('Download error:', error);
                alert('❌ خطأ في التحميل');
            }
        }
        
        // Self-contained data export/import
        function exportAllData() {
            try {
                const allData = {
                    version: '2.0',
                    categories: categories,
                    prescriptions: prescriptions,
                    notes: notes,
                    drugs: drugs,
                    drugCategories: drugCategories,
                    trashedPrescriptions: trashedPrescriptions,
                    trashedCategories: trashedCategories,
                    trashedNotes: trashedNotes,
                    appName: appName,
                    appDescription: appDescription,
                    theme: currentTheme,
                    prescriptionFontSize: prescriptionFontSize,
                    prescriptionFontColor: prescriptionFontColor,
                    exportDate: new Date().toISOString()
                };
                
                const fileName = `prescription-manager-backup-${Date.now()}.json`;
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                link.click();
                URL.revokeObjectURL(url);
                
                // Show success message with stats
                const stats = `
✅ تم استخراج البيانات بنجاح!

📊 الملف يحتوي على:
• ${categories.length} فئة روشتات
• ${prescriptions.length} روشتة
• ${drugCategories.length} فئة أدوية
• ${drugs.length} دواء
• ${notes.length} ملاحظة
• ${trashedPrescriptions.length + trashedCategories.length + trashedNotes.length} عنصر محذوف

💾 اسم الملف:
${fileName}

💡 احفظ هذا الملف في مكان آمن (Google Drive, Dropbox, إلخ)
لاستعادة البيانات على أي جهاز، اضغط 📂 واختر الملف
                `;
                alert(stats);
            } catch (error) {
                console.error('Export error:', error);
                alert('❌ حدث خطأ أثناء استخراج البيانات');
            }
        }
        
        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            // Validate data structure
                            if (!data.categories && !data.prescriptions && !data.notes) {
                                alert('❌ الملف غير صحيح أو تالف');
                                return;
                            }
                            
                            // Restore all data
                            categories = data.categories || [];
                            prescriptions = data.prescriptions || [];
                            notes = data.notes || [];
                            drugs = data.drugs || [];
                            drugCategories = data.drugCategories || [];
                            trashedPrescriptions = data.trashedPrescriptions || [];
                            trashedCategories = data.trashedCategories || [];
                            trashedNotes = data.trashedNotes || [];
                            appName = data.appName || 'د.محمد مدحت';
                            appDescription = data.appDescription || 'نظام احترافي لإدارة وتنظيم الروشتات الطبية والملاحظات';
                            currentTheme = data.theme || 'light';
                            prescriptionFontSize = data.prescriptionFontSize || '16';
                            prescriptionFontColor = data.prescriptionFontColor || '#000000';
                            
                            console.log('Imported data:', {
                                categories: categories.length,
                                prescriptions: prescriptions.length,
                                notes: notes.length,
                                drugs: drugs.length,
                                drugCategories: drugCategories.length
                            });
                            
                            // Save to localStorage
                            localStorage.setItem('categories', JSON.stringify(categories));
                            localStorage.setItem('prescriptions', JSON.stringify(prescriptions));
                            localStorage.setItem('notes', JSON.stringify(notes));
                            localStorage.setItem('drugs', JSON.stringify(drugs));
                            localStorage.setItem('drugCategories', JSON.stringify(drugCategories));
                            localStorage.setItem('trashedPrescriptions', JSON.stringify(trashedPrescriptions));
                            localStorage.setItem('trashedCategories', JSON.stringify(trashedCategories));
                            localStorage.setItem('trashedNotes', JSON.stringify(trashedNotes));
                            localStorage.setItem('appName', appName);
                            localStorage.setItem('appDescription', appDescription);
                            localStorage.setItem('theme', currentTheme);
                            localStorage.setItem('prescriptionFontSize', prescriptionFontSize);
                            localStorage.setItem('prescriptionFontColor', prescriptionFontColor);
                            
                            // Update UI immediately
                            updateCategorySelect();
                            renderCategories();
                            renderPrescriptions();
                            renderDrugCategories();
                            renderDrugs();
                            updateDrugCategorySelect();
                            updateNotesCount();
                            updateTrashCounts();
                            updateBadgeCounts();
                            
                            // Update header
                            document.querySelector('header h1').innerHTML = `💊 ${appName}`;
                            document.querySelector('header p').textContent = appDescription;
                            
                            // Show success message
                            const stats = `
✅ تم استيراد البيانات بنجاح!

📊 تم استعادة:
• ${categories.length} فئة روشتات
• ${prescriptions.length} روشتة
• ${drugCategories.length} فئة أدوية
• ${drugs.length} دواء
• ${notes.length} ملاحظة

⏰ تاريخ النسخة الاحتياطية:
${data.exportDate ? new Date(data.exportDate).toLocaleString('ar-EG') : 'غير متوفر'}
                            `;
                            alert(stats);
                        } catch (error) {
                            console.error('Import error:', error);
                            alert('❌ خطأ في قراءة الملف. تأكد من أنه ملف النسخ الاحتياطي الصحيح.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        // Language Toggle
        let currentLanguage = localStorage.getItem('appLanguage') || 'ar';
        
        const translations = {
            ar: {
                // Header
                settings: 'الإعدادات',
                
                // Tabs
                prescriptions: 'الروشتات',
                notes: 'الملاحظات',
                trash: 'المحذوفات',
                
                // Categories
                categories: 'الفئات',
                addCategory: 'إضافة فئة جديدة',
                editCategory: 'تعديل الفئة',
                categoryName: 'اسم الفئة',
                categoryBgImage: 'صورة خلفية للفئة (اختياري)',
                addCategoryBg: 'إضافة خلفية للفئة',
                allPrescriptions: 'كل الروشتات',
                categorySort: 'ترتيب الفئات',
                
                // Prescriptions
                addPrescription: 'إضافة روشتة جديدة',
                editPrescription: 'تعديل الروشتة',
                prescriptionName: 'اسم الروشتة',
                category: 'الفئة',
                selectCategory: 'اختر الفئة...',
                rxContent: 'Rx (محتوى الروشتة)',
                searchPrescriptions: 'ابحث في الروشتات...',
                noPrescriptions: 'لا توجد روشتات بعد',
                startAdding: 'ابدأ بإضافة روشتة جديدة',
                
                // Notes
                addNote: 'إضافة ملاحظة جديدة',
                searchNotes: 'ابحث في الملاحظات...',
                noNotes: 'لا توجد ملاحظات بعد',
                
                // Trash
                deletedPrescriptions: 'الروشتات المحذوفة',
                deletedCategories: 'الفئات المحذوفة',
                deletedNotes: 'الملاحظات المحذوفة',
                emptyTrash: 'إفراغ سلة المحذوفات',
                trashEmpty: 'سلة المحذوفات فارغة',
                noDeletedItems: 'لا توجد عناصر محذوفة',
                deletedOn: 'تم الحذف في:',
                categoryContains: 'فئة تحتوي على',
                prescriptionsCount: 'روشتة',
                restoreCategoryAndPrescriptions: 'استرجاع الفئة والروشتات',
                deletePermanently: 'حذف نهائي',
                uncategorized: 'غير مصنف',
                
                // Buttons
                save: 'حفظ',
                savePrescription: 'حفظ الروشتة',
                cancel: 'إلغاء',
                close: 'إغلاق',
                edit: 'تعديل',
                delete: 'حذف',
                restore: 'استرجاع',
                addImage: 'إضافة صورة',
                addImageOptional: 'إضافة صورة (اختياري)',
                
                // Settings Menu
                fontSettings: 'تخصيص الخطوط',
                fontSettingsDesc: 'حجم ولون الخط في الروشتات',
                themeSettings: 'اختيار الثيم',
                themeSettingsDesc: 'غير الألوان والخلفية',
                languageSettings: 'تغيير اللغة',
                languageSettingsDesc: 'التبديل بين العربية والإنجليزية',
                exportData: 'استخراج البيانات',
                exportDataDesc: 'احفظ نسخة احتياطية من جميع البيانات',
                importData: 'إدخال البيانات',
                importDataDesc: 'استرجع البيانات من ملف النسخة الاحتياطية',
                formatData: 'Format (مسح الكل)',
                formatDataDesc: 'حذف جميع البيانات نهائياً'
            },
            en: {
                // Header
                settings: 'Settings',
                
                // Tabs
                prescriptions: 'Prescriptions',
                notes: 'Notes',
                trash: 'Trash',
                
                // Categories
                categories: 'Categories',
                addCategory: 'Add New Category',
                editCategory: 'Edit Category',
                categoryName: 'Category Name',
                categoryBgImage: 'Category Background Image (Optional)',
                addCategoryBg: 'Add Category Background',
                allPrescriptions: 'All Prescriptions',
                categorySort: 'Sort Categories',
                
                // Prescriptions
                addPrescription: 'Add New Prescription',
                editPrescription: 'Edit Prescription',
                prescriptionName: 'Prescription Name',
                category: 'Category',
                selectCategory: 'Select category...',
                rxContent: 'Rx (Prescription Content)',
                searchPrescriptions: 'Search prescriptions...',
                noPrescriptions: 'No prescriptions yet',
                startAdding: 'Start by adding a new prescription',
                
                // Notes
                addNote: 'Add New Note',
                searchNotes: 'Search notes...',
                noNotes: 'No notes yet',
                
                // Trash
                deletedPrescriptions: 'Deleted Prescriptions',
                deletedCategories: 'Deleted Categories',
                deletedNotes: 'Deleted Notes',
                emptyTrash: 'Empty Trash',
                trashEmpty: 'Trash is empty',
                noDeletedItems: 'No deleted items',
                deletedOn: 'Deleted on:',
                categoryContains: 'Category contains',
                prescriptionsCount: 'prescriptions',
                restoreCategoryAndPrescriptions: 'Restore Category & Prescriptions',
                deletePermanently: 'Delete Permanently',
                uncategorized: 'Uncategorized',
                
                // Buttons
                save: 'Save',
                savePrescription: 'Save Prescription',
                cancel: 'Cancel',
                close: 'Close',
                edit: 'Edit',
                delete: 'Delete',
                restore: 'Restore',
                addImage: 'Add Image',
                addImageOptional: 'Add Image (Optional)',
                
                // Settings Menu
                fontSettings: 'Font Settings',
                fontSettingsDesc: 'Customize font size and color',
                themeSettings: 'Choose Theme',
                themeSettingsDesc: 'Change colors and background',
                languageSettings: 'Change Language',
                languageSettingsDesc: 'Switch between Arabic and English',
                exportData: 'Export Data',
                exportDataDesc: 'Save backup of all data',
                importData: 'Import Data',
                importDataDesc: 'Restore data from backup file',
                formatData: 'Format (Clear All)',
                formatDataDesc: 'Delete all data permanently'
            }
        };
        
        function translateUI() {
            try {
                const t = translations[currentLanguage];
                const isArabic = currentLanguage === 'ar';
                
                console.log('🌐 Translating UI to:', currentLanguage);
                
                // Translate tabs (FIXED SELECTOR)
                const tabButtons = document.querySelectorAll('.tab-button');
                if (tabButtons[0]) tabButtons[0].innerHTML = `📋 ${t.prescriptions}`;
                if (tabButtons[1]) tabButtons[1].innerHTML = `💊 الأدوية`;
                
                // Translate content title
                const contentTitle = document.getElementById('contentTitle');
                if (contentTitle) {
                    if (currentCategory === 'all') {
                        contentTitle.innerHTML = `📋 ${t.allPrescriptions}`;
                    }
                }
                
                // Translate "All Prescriptions" in category list
                const categoryItems = document.querySelectorAll('.category-item');
                categoryItems.forEach(item => {
                    const span = item.querySelector('span');
                    if (span) {
                        const text = span.textContent.trim();
                        if (text.includes('كل الروشتات') || text.includes('All Prescriptions') || text === '📋 كل الروشتات' || text === '📋 All Prescriptions') {
                            span.textContent = `📋 ${t.allPrescriptions}`;
                        }
                    }
                });
                
                // Translate categories section
                const categoriesTitle = document.querySelector('.category-section h3');
                if (categoriesTitle) categoriesTitle.textContent = `📁 ${t.categories}`;
                
                const addCategoryBtn = document.getElementById('addCategoryMainBtn');
                if (addCategoryBtn) addCategoryBtn.textContent = `➕ ${t.addCategory}`;
                
                // Translate search placeholder
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.placeholder = t.searchPrescriptions;
                
                const searchNotesInput = document.getElementById('searchNotesInput');
                if (searchNotesInput) searchNotesInput.placeholder = t.searchNotes;
                
                // Translate add prescription button
                const addPrescBtn = document.getElementById('addPrescriptionMainBtn');
                if (addPrescBtn) addPrescBtn.textContent = `➕ ${t.addPrescription}`;
                
                // Translate settings menu title
                const settingsModalTitle = document.querySelector('#settingsMenuModal .modal-header h2');
                if (settingsModalTitle) settingsModalTitle.textContent = `⚙️ ${t.settings}`;
                
                // Translate settings menu buttons using IDs
                const themeTitle = document.getElementById('themeButtonTitle');
                const themeDesc = document.getElementById('themeButtonDesc');
                if (themeTitle) themeTitle.textContent = t.themeSettings;
                if (themeDesc) themeDesc.textContent = t.themeSettingsDesc;
                
                const exportTitle = document.getElementById('exportButtonTitle');
                const exportDesc = document.getElementById('exportButtonDesc');
                if (exportTitle) exportTitle.textContent = t.exportData;
                if (exportDesc) exportDesc.textContent = t.exportDataDesc;
                
                const importTitle = document.getElementById('importButtonTitle');
                const importDesc = document.getElementById('importButtonDesc');
                if (importTitle) importTitle.textContent = t.importData;
                if (importDesc) importDesc.textContent = t.importDataDesc;
                
                const formatTitle = document.getElementById('formatButtonTitle');
            const formatDesc = document.getElementById('formatButtonDesc');
            if (formatTitle) formatTitle.textContent = t.formatData;
            if (formatDesc) formatDesc.textContent = t.formatDataDesc;
            
            // Translate trash section
            const trashSectionTitle = document.getElementById('trashSectionTitle');
            if (trashSectionTitle) trashSectionTitle.textContent = `🗑️ ${t.trash}`;
            
            const trashPrescLabel = document.getElementById('trashPrescLabel');
            if (trashPrescLabel) trashPrescLabel.textContent = t.deletedPrescriptions + ':';
            
            const trashCatsLabel = document.getElementById('trashCatsLabel');
            if (trashCatsLabel) trashCatsLabel.textContent = t.deletedCategories + ':';
            
            const trashNotesLabel = document.getElementById('trashNotesLabel');
            if (trashNotesLabel) trashNotesLabel.textContent = t.deletedNotes + ':';
            
            const emptyTrashBtn = document.getElementById('emptyTrashBtn');
            if (emptyTrashBtn) emptyTrashBtn.textContent = `🗑️ ${t.emptyTrash}`;
            
            // Translate prescription modal
            const prescNameLabel = document.getElementById('prescNameLabel');
            if (prescNameLabel) prescNameLabel.textContent = t.prescriptionName;
            
            const prescCategoryLabel = document.getElementById('prescCategoryLabel');
            if (prescCategoryLabel) prescCategoryLabel.textContent = t.category;
            
            const prescCategoryPlaceholder = document.getElementById('prescCategoryPlaceholder');
            if (prescCategoryPlaceholder) prescCategoryPlaceholder.textContent = t.selectCategory;
            
            const prescRxLabel = document.getElementById('prescRxLabel');
            if (prescRxLabel) prescRxLabel.textContent = t.rxContent;
            
            const prescImageLabel = document.getElementById('prescImageLabel');
            if (prescImageLabel) prescImageLabel.textContent = t.addImageOptional;
            
            const addImageBtn = document.getElementById('addImageBtn');
            if (addImageBtn) addImageBtn.innerHTML = `📷 ${t.addImage}`;
            
            const savePrescBtn = document.getElementById('savePrescBtn');
            if (savePrescBtn) savePrescBtn.textContent = t.savePrescription;
            
            const cancelPrescBtn = document.getElementById('cancelPrescBtn');
            if (cancelPrescBtn) cancelPrescBtn.textContent = t.cancel;
            
            // Translate category modal
            const categoryNameLabel = document.getElementById('categoryNameLabel');
            if (categoryNameLabel) categoryNameLabel.textContent = t.categoryName;
            
            const categoryBgLabel = document.getElementById('categoryBgLabel');
            if (categoryBgLabel) categoryBgLabel.textContent = t.categoryBgImage;
            
            const addCategoryBgBtn = document.getElementById('addCategoryBgBtn');
            if (addCategoryBgBtn) addCategoryBgBtn.innerHTML = `🖼️ ${t.addCategoryBg}`;
            
            const saveCategoryBtn = document.getElementById('saveCategoryBtn');
            if (saveCategoryBtn) saveCategoryBtn.textContent = t.save;
            
            const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');
            if (cancelCategoryBtn) cancelCategoryBtn.textContent = t.cancel;
            
            // Translate view prescription modal buttons
            const exportPDFBtn = document.getElementById('exportPDFBtn');
            if (exportPDFBtn) exportPDFBtn.textContent = '📄 PDF';
            
            const editPrescViewBtn = document.getElementById('editPrescViewBtn');
            if (editPrescViewBtn) editPrescViewBtn.textContent = `✏️ ${t.edit}`;
            
            const closePrescViewBtn = document.getElementById('closePrescViewBtn');
            if (closePrescViewBtn) closePrescViewBtn.textContent = `✖️ ${t.close}`;
            } catch (error) {
                console.warn('⚠️ Translation error (non-critical):', error.message);
            }
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
            localStorage.setItem('appLanguage', currentLanguage);
            
            alert(currentLanguage === 'ar' ? '✅ تم التبديل إلى العربية' : '✅ Switched to English');
            
            // Reload to apply all changes
            location.reload();
        }
        
        // Apply language on load
        function applyLanguage() {
            const isArabic = currentLanguage === 'ar';
            
            // Set document direction
            document.documentElement.setAttribute('dir', isArabic ? 'rtl' : 'ltr');
            document.documentElement.setAttribute('lang', isArabic ? 'ar' : 'en');
            document.body.setAttribute('dir', isArabic ? 'rtl' : 'ltr');
            
            // Move settings button based on language
            const settingsBtn = document.getElementById('settingsButtonContainer');
            if (settingsBtn) {
                if (isArabic) {
                    settingsBtn.style.left = '20px';
                    settingsBtn.style.right = 'auto';
                } else {
                    settingsBtn.style.left = 'auto';
                    settingsBtn.style.right = '20px';
                }
            }
            
            // Translate UI
            setTimeout(() => {
                translateUI();
            }, 100);
        }
        
        // Call applyLanguage on load
        applyLanguage();
        
        // Format (Clear All Data)
        function showFoldersSoon() {
            alert('📂 المجلدات (Folders)\n\nهذه الميزة قيد التطوير!\n\nستتمكن قريباً من:\n✅ إنشاء مجلدات داخل كل فئة\n✅ تنظيم الروشتات في مجلدات\n✅ تنظيم الأدوية في مجلدات\n✅ ترتيب أفضل وأسهل\n\nشكراً لتفهمكم 🙏');
        }
        
        // ============= GOOGLE DRIVE SYNC =============
        
        const GOOGLE_CLIENT_ID = '724619403043-6qj47sh10f4n6m05e61mquvvasqkpf24.apps.googleusercontent.com';
        let tokenClient;
        let accessToken = null;
        
        // Auto-initialize when Google API loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                    console.log('✅ Google API loaded - initializing...');
                    initGoogleSync();
                } else {
                    console.log('⚠️ Waiting for Google API...');
                }
            }, 1500);
        });
        
        function initGoogleSync() {
            if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                console.error('❌ Google API not loaded');
                return;
            }
            
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            accessToken = tokenResponse.access_token;
                            console.log('✅ Access token received');
                            
                            // حفظ الـ token
                            localStorage.setItem('driveAccessToken', accessToken);
                            localStorage.setItem('driveTokenExpiry', Date.now() + 3600000); // 1 hour
                            
                            // نسأل المستخدم: رفع أم استعادة؟
                            const shouldUpload = confirm("اضغط OK لرفع بياناتك الحالية إلى Google Drive\n\nاضغط Cancel لاستعادة بياناتك من Google Drive");
                            
                            if (shouldUpload) {
                                uploadData();
                            } else {
                                restoreData();
                            }
                        } else {
                            console.error('❌ No access token in response');
                        }
                    },
                    error_callback: (error) => {
                        console.error('❌ OAuth error:', error);
                        alert('❌ حدث خطأ في الاتصال بـ Google Drive');
                    }
                });
                
                console.log('✅ Token client initialized');
                
                // محاولة استعادة token من storage
                const storedToken = localStorage.getItem('driveAccessToken');
                const tokenExpiry = parseInt(localStorage.getItem('driveTokenExpiry') || '0');
                
                if (storedToken && Date.now() < tokenExpiry) {
                    accessToken = storedToken;
                    console.log('✅ Using stored access token');
                }
            } catch (error) {
                console.error('❌ Error initializing Google Sync:', error);
            }
        }
        
        // دالة الرفع
        async function uploadData() {
            try {
                // جمع كل البيانات
                const allData = {
                    categories: categories,
                    prescriptions: prescriptions,
                    notes: notes,
                    drugs: drugs,
                    drugCategories: drugCategories,
                    trashedPrescriptions: trashedPrescriptions,
                    trashedCategories: trashedCategories,
                    trashedNotes: trashedNotes,
                    appName: appName,
                    appDescription: appDescription,
                    backupDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonData = JSON.stringify(allData, null, 2);
                const metadata = { 
                    name: 'roshtaty_backup.json', 
                    mimeType: 'application/json' 
                };
                
                const file = new Blob([jsonData], { type: 'application/json' });
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                    body: formData,
                });
                
                if (response.ok) {
                    alert('✅ تم حفظ النسخة الاحتياطية على Google Drive بنجاح!\n\nالبيانات المحفوظة:\n• الفئات\n• الروشتات\n• الأدوية\n• الملاحظات');
                } else {
                    const error = await response.json();
                    alert('❌ حدث خطأ أثناء الرفع:\n\n' + (error.error?.message || 'خطأ غير معروف'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('❌ حدث خطأ أثناء الرفع:\n\n' + error.message);
            }
        }
        
        // دالة الاستعادة
        async function restoreData() {
            try {
                // 1. البحث عن الملف
                const searchRes = await fetch('https://www.googleapis.com/drive/v3/files?q=name="roshtaty_backup.json"&orderBy=modifiedTime desc', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                const searchData = await searchRes.json();
                
                if (searchData.files && searchData.files.length > 0) {
                    const fileId = searchData.files[0].id;
                    
                    // 2. تحميل محتوى الملف (تصليح الـ syntax error)
                    const fileRes = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                    
                    const content = await fileRes.text();
                    const restoredData = JSON.parse(content);
                    
                    // 3. استعادة البيانات
                    if (restoredData.categories) localStorage.setItem('categories', JSON.stringify(restoredData.categories));
                    if (restoredData.prescriptions) localStorage.setItem('prescriptions', JSON.stringify(restoredData.prescriptions));
                    if (restoredData.notes) localStorage.setItem('notes', JSON.stringify(restoredData.notes));
                    if (restoredData.drugs) localStorage.setItem('drugs', JSON.stringify(restoredData.drugs));
                    if (restoredData.drugCategories) localStorage.setItem('drugCategories', JSON.stringify(restoredData.drugCategories));
                    if (restoredData.trashedPrescriptions) localStorage.setItem('trashedPrescriptions', JSON.stringify(restoredData.trashedPrescriptions));
                    if (restoredData.trashedCategories) localStorage.setItem('trashedCategories', JSON.stringify(restoredData.trashedCategories));
                    if (restoredData.trashedNotes) localStorage.setItem('trashedNotes', JSON.stringify(restoredData.trashedNotes));
                    
                    alert('✅ تمت استعادة البيانات من Google Drive بنجاح!\n\nسيتم تحديث الصفحة الآن.');
                    location.reload();
                } else {
                    alert('❌ لم يتم العثور على نسخة احتياطية سابقة على Google Drive.\n\nالرجاء رفع نسخة احتياطية أولاً.');
                }
            } catch (error) {
                console.error('Restore error:', error);
                alert('❌ حدث خطأ أثناء الاستعادة:\n\n' + error.message);
            }
        }
        
        // دالة لفتح Google Sync من الإعدادات
        function openGoogleSync() {
            if (!tokenClient) {
                initGoogleSync();
            }
            
            // انتظر ثانية للتأكد من تحميل Google API
            setTimeout(() => {
                if (tokenClient) {
                    tokenClient.requestAccessToken();
                } else {
                    alert('⚠️ الرجاء الانتظار حتى يتم تحميل خدمات Google...');
                }
            }, 500);
        }
        
        // ============= END GOOGLE DRIVE SYNC =============
        
        // ============= AUTO-SYNC ENHANCEMENT =============
        
        let autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
        let syncInProgress = false;
        let lastSyncTime = 0;
        const SYNC_COOLDOWN = 5000; // 5 seconds
        
        // Override localStorage.setItem for auto-sync
        const originalSetItem = Storage.prototype.setItem;
        Storage.prototype.setItem = function(key, value) {
            // Call original first
            originalSetItem.apply(this, arguments);
            
            // Check if auto-sync enabled and key is important
            const importantKeys = ['categories', 'prescriptions', 'drugs', 'drugCategories', 'notes', 'folders', 'drugFolders'];
            if (autoSyncEnabled && importantKeys.includes(key) && accessToken) {
                // Debounced sync - wait 2 seconds after last change
                if (window.autoSyncTimeout) {
                    clearTimeout(window.autoSyncTimeout);
                }
                window.autoSyncTimeout = setTimeout(() => {
                    triggerAutoSync();
                }, 2000);
            }
        };
        
        function triggerAutoSync() {
            // Check cooldown
            const now = Date.now();
            if (now - lastSyncTime < SYNC_COOLDOWN) {
                console.log('⏳ Auto-sync cooldown active');
                return;
            }
            
            // Check if sync in progress
            if (syncInProgress) {
                console.log('⏳ Sync already in progress');
                return;
            }
            
            // Check if token exists
            if (!accessToken) {
                console.log('⚠️ No access token for auto-sync');
                return;
            }
            
            console.log('🔄 Auto-sync triggered');
            lastSyncTime = now;
            
            // Use existing uploadData function
            uploadDataSilent();
        }
        
        async function uploadDataSilent() {
            if (syncInProgress) return;
            
            syncInProgress = true;
            
            try {
                const allData = {
                    categories: categories,
                    prescriptions: prescriptions,
                    notes: notes,
                    drugs: drugs,
                    drugCategories: drugCategories,
                    folders: folders || [],
                    drugFolders: drugFolders || [],
                    trashedPrescriptions: trashedPrescriptions,
                    trashedCategories: trashedCategories,
                    trashedNotes: trashedNotes,
                    appName: appName,
                    appDescription: appDescription,
                    backupDate: new Date().toISOString(),
                    version: '2.0'
                };
                
                const jsonData = JSON.stringify(allData, null, 2);
                const metadata = { 
                    name: 'roshtaty_backup.json', 
                    mimeType: 'application/json' 
                };
                
                const file = new Blob([jsonData], { type: 'application/json' });
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + accessToken },
                    body: formData,
                });
                
                if (response.ok) {
                    console.log('✅ Auto-sync complete');
                    localStorage.setItem('lastSyncTime', new Date().toISOString());
                } else {
                    console.error('❌ Auto-sync failed:', await response.text());
                }
            } catch (error) {
                console.error('❌ Auto-sync error:', error);
            } finally {
                syncInProgress = false;
            }
        }
        
        function toggleAutoSync() {
            autoSyncEnabled = !autoSyncEnabled;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
            
            if (autoSyncEnabled) {
                if (!accessToken) {
                    alert('⚠️ الرجاء الاتصال بـ Google Drive أولاً من خلال:\nالإعدادات → Google Drive Sync');
                    autoSyncEnabled = false;
                    localStorage.setItem('autoSyncEnabled', 'false');
                } else {
                    alert('✅ تم تفعيل النسخ الاحتياطي التلقائي!\n\nسيتم حفظ بياناتك تلقائياً على Google Drive عند كل تعديل.');
                }
            } else {
                alert('⚠️ تم إيقاف النسخ الاحتياطي التلقائي\n\nيمكنك استخدام النسخ اليدوي من الإعدادات.');
            }
        }
        
        // Add toggle button info to openGoogleSync
        const originalOpenGoogleSync = openGoogleSync;
        openGoogleSync = function() {
            const lastSync = localStorage.getItem('lastSyncTime');
            const autoSyncStatus = autoSyncEnabled ? '🟢 مفعّل' : '🔴 متوقف';
            
            let message = '☁️ Google Drive Sync\n\n';
            
            if (accessToken) {
                message += '✅ متصل بـ Google Drive\n\n';
                if (lastSync) {
                    const syncDate = new Date(lastSync);
                    message += `آخر مزامنة: ${syncDate.toLocaleString('ar-EG')}\n\n`;
                }
                message += `النسخ التلقائي: ${autoSyncStatus}\n\n`;
                message += 'اختر:\n';
                message += '1️⃣ OK = نسخ احتياطي يدوي الآن\n';
                message += '2️⃣ Cancel = استرجاع من Drive\n\n';
                message += 'لتفعيل/إيقاف Auto-Sync:\n';
                message += 'افتح Console واكتب: toggleAutoSync()';
            } else {
                message += '⚠️ غير متصل\n\n';
                message += 'اضغط OK للاتصال';
            }
            
            const choice = confirm(message);
            
            if (accessToken) {
                if (choice) {
                    uploadData();
                } else {
                    restoreData();
                }
            } else {
                originalOpenGoogleSync();
            }
        };
        
        // Initialize auto-sync on load
        if (autoSyncEnabled && accessToken) {
            console.log('🔄 Auto-sync is enabled');
        }
        
        // ============= END AUTO-SYNC ENHANCEMENT =============
        
        function formatAllData() {
            const confirmed = confirm('⚠️ تحذير!\n\nهل أنت متأكد من مسح جميع البيانات؟\n\nسيتم حذف:\n• جميع الفئات\n• جميع الروشتات\n• جميع الملاحظات\n• سلة المحذوفات\n• جميع الإعدادات\n\nهذا الإجراء لا يمكن التراجع عنه!');
            
            if (confirmed) {
                const doubleCheck = prompt('للتأكيد، اكتب كلمة "مسح" بالعربي:');
                if (doubleCheck === 'مسح') {
                    // Clear all localStorage
                    localStorage.clear();
                    
                    alert('✅ تم مسح جميع البيانات بنجاح!\n\nسيتم إعادة تحميل التطبيق...');
                    
                    // Reload page
                    location.reload();
                } else {
                    alert('❌ تم إلغاء العملية\n\nلم يتم مسح أي بيانات.');
                }
            }
        }
        
        // ============= Login Management =============
        
        function openLoginSettings() {
            document.getElementById('loginSettingsModal').classList.add('active');
            disableScroll();
            
            // Load current settings
            const loginEnabled = localStorage.getItem('loginEnabled') === 'true';
            const savedUsername = localStorage.getItem('loginUsername') || '';
            const savedPassword = localStorage.getItem('loginPassword') || '';
            
            document.getElementById('enableLoginCheckbox').checked = loginEnabled;
            document.getElementById('loginUsernameInput').value = savedUsername;
            document.getElementById('loginPasswordInput').value = savedPassword;
            document.getElementById('loginPasswordConfirmInput').value = savedPassword;
            
            // Show/hide credentials section
            document.getElementById('loginCredentialsSection').style.display = loginEnabled ? 'block' : 'none';
        }
        
        function closeLoginSettings() {
            document.getElementById('loginSettingsModal').classList.remove('active');
            ensureScrollEnabled();
        }
        
        function toggleLoginEnabled() {
            const isEnabled = document.getElementById('enableLoginCheckbox').checked;
            document.getElementById('loginCredentialsSection').style.display = isEnabled ? 'block' : 'none';
            
            if (!isEnabled) {
                // Disable login
                localStorage.setItem('loginEnabled', 'false');
                alert('✅ تم إلغاء حماية التطبيق\n\nلن يُطلب منك تسجيل الدخول بعد الآن.');
            }
        }
        
        function saveLoginCredentials() {
            const username = document.getElementById('loginUsernameInput').value.trim();
            const password = document.getElementById('loginPasswordInput').value;
            const confirmPassword = document.getElementById('loginPasswordConfirmInput').value;
            
            if (!username) {
                alert('❌ الرجاء إدخال اسم المستخدم');
                return;
            }
            
            if (!password) {
                alert('❌ الرجاء إدخال كلمة المرور');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('❌ كلمة المرور وتأكيد كلمة المرور غير متطابقين');
                return;
            }
            
            if (password.length < 4) {
                alert('❌ كلمة المرور يجب أن تكون 4 أحرف على الأقل');
                return;
            }
            
            // Save credentials
            localStorage.setItem('loginEnabled', 'true');
            localStorage.setItem('loginUsername', username);
            localStorage.setItem('loginPassword', password);
            
            alert('✅ تم حفظ بيانات تسجيل الدخول بنجاح!\n\nسيُطلب منك تسجيل الدخول عند فتح التطبيق المرة القادمة.');
            closeLoginSettings();
        }
        
        function showLoginScreen() {
            const loginScreen = document.getElementById('loginScreen');
            loginScreen.style.display = 'flex';
            document.getElementById('loginScreenUsername').focus();
            
            // Prevent using app without login
            document.getElementById('app').style.display = 'none';
            document.body.style.overflow = 'hidden';
        }
        
        function attemptLogin() {
            const enteredUsername = document.getElementById('loginScreenUsername').value.trim();
            const enteredPassword = document.getElementById('loginScreenPassword').value;
            
            const savedUsername = localStorage.getItem('loginUsername');
            const savedPassword = localStorage.getItem('loginPassword');
            
            if (enteredUsername === savedUsername && enteredPassword === savedPassword) {
                // Login successful - just show the app (already initialized)
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.body.style.overflow = '';
                document.getElementById('loginErrorMessage').style.display = 'none';
                
                console.log('✅ Login successful - App already initialized');
            } else {
                // Login failed
                document.getElementById('loginErrorMessage').style.display = 'block';
                document.getElementById('loginScreenPassword').value = '';
                document.getElementById('loginScreenPassword').focus();
            }
        }
        
        // Check login on page load
        function checkLoginRequired() {
            const loginEnabled = localStorage.getItem('loginEnabled') === 'true';
            if (loginEnabled) {
                showLoginScreen();
            }
        }
        
        // ============= End Login Management =============
        
        // ============= AUTO DIRECTION DETECTION =============
        
        function detectLanguage(text) {
            if (!text || text.length === 0) return null;
            
            // Check first character
            const firstChar = text.charAt(0);
            const arabicRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;
            const englishRegex = /[a-zA-Z]/;
            
            if (arabicRegex.test(firstChar)) {
                return 'rtl';
            } else if (englishRegex.test(firstChar)) {
                return 'ltr';
            }
            
            // Check all text if first char is number/symbol
            const arabicCount = (text.match(arabicRegex) || []).length;
            const englishCount = (text.match(englishRegex) || []).length;
            
            if (arabicCount > englishCount) {
                return 'rtl';
            } else if (englishCount > arabicCount) {
                return 'ltr';
            }
            
            return null;
        }
        
        function updateInputDirection(input) {
            const text = input.value;
            const direction = detectLanguage(text);
            
            if (direction === 'ltr') {
                input.classList.remove('rtl-input');
                input.classList.add('ltr-input');
                input.style.direction = 'ltr';
                input.style.textAlign = 'left';
            } else if (direction === 'rtl') {
                input.classList.remove('ltr-input');
                input.classList.add('rtl-input');
                input.style.direction = 'rtl';
                input.style.textAlign = 'right';
            }
        }
        
        function setupAutoDirection() {
            // Find all inputs and textareas
            const inputs = document.querySelectorAll('input[type="text"], textarea');
            
            inputs.forEach(input => {
                // Update on input
                input.addEventListener('input', function() {
                    updateInputDirection(this);
                });
                
                // Update on keyup (for better responsiveness)
                input.addEventListener('keyup', function() {
                    updateInputDirection(this);
                });
                
                // Initial check if has value
                if (input.value) {
                    updateInputDirection(input);
                }
            });
        }
        
        // Setup on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupAutoDirection();
            
            // Re-setup when modals open (for dynamically added inputs)
            const observer = new MutationObserver(function(mutations) {
                setupAutoDirection();
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
        
        // ============= END AUTO DIRECTION DETECTION =============
        
        // Initialize app when DOM is fully loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // ✅ Always run init first to setup everything
                init();
                
                // Then check if login is required
                const loginEnabled = localStorage.getItem('loginEnabled') === 'true';
                if (loginEnabled) {
                    checkLoginRequired();
                }
            });
        } else {
            // DOM is already loaded
            // ✅ Always run init first to setup everything
            init();
            
            // Then check if login is required
            const loginEnabled = localStorage.getItem('loginEnabled') === 'true';
            if (loginEnabled) {
                checkLoginRequired();
            }
        }
        
        // Mobile-specific enhancements
        if ('ontouchstart' in window) {
            // Improve button responsiveness on mobile
            document.addEventListener('touchstart', function() {}, {passive: true});
            
            // Prevent double-tap zoom on buttons
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Add visual feedback for touch
            document.querySelectorAll('button, .category-item, .prescription-card').forEach(el => {
                el.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                });
                el.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
            });
        }
        
        // iOS Safari: Add to Home Screen prompt
        if (navigator.standalone === false && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
            // User is on iOS Safari and hasn't added to home screen
            console.log('💡 Tip: Add this app to your home screen for the best experience!');
        }
    </script>
</body>
</html>
    <script>
        // Popup Functions
        function updateBadgeCounts() {
            const favPrescriptionsCount = prescriptions.filter(p => p.isFavorite).length;
            const favDrugsCount = drugs.filter(d => d.isFavorite).length;
            const totalFavCount = favPrescriptionsCount + favDrugsCount;
            const drugsCount = drugs.length;
            const notesCount = notes.length;
            
            const favCountEl = document.getElementById('favoritesCount');
            if (favCountEl) {
                favCountEl.textContent = totalFavCount;
                favCountEl.style.display = totalFavCount > 0 ? 'flex' : 'none';
            }
            
            const drugsCountEl = document.getElementById('drugsCountBadge');
            if (drugsCountEl) {
                drugsCountEl.textContent = drugsCount;
                drugsCountEl.style.display = drugsCount > 0 ? 'flex' : 'none';
            }
            
            const notesCountEl = document.getElementById('notesCountBadge');
            if (notesCountEl) {
                notesCountEl.textContent = notesCount;
                notesCountEl.style.display = notesCount > 0 ? 'flex' : 'none';
            }
        }
        
        // Favorites Popup
        function openFavoritesPopup() {
            document.getElementById('favoritesPopup').classList.add('active');
            disableScroll();
            renderFavoritesPopup();
        }
        
        function closeFavoritesPopup() {
            document.getElementById('favoritesPopup').classList.remove('active');
            document.body.classList.remove('modal-open');
            ensureScrollEnabled();
        }
        
        function renderFavoritesPopup() {
            const grid = document.getElementById('favoritesPopupGrid');
            const searchTerm = document.getElementById('searchFavoritesPopupInput').value.toLowerCase();
            
            // Get favorite prescriptions
            let favPrescriptions = prescriptions.filter(p => p.isFavorite);
            if (searchTerm) {
                favPrescriptions = favPrescriptions.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    (p.rx && p.rx.toLowerCase().includes(searchTerm))
                );
            }
            
            // Get favorite drugs
            let favDrugs = drugs.filter(d => d.isFavorite);
            if (searchTerm) {
                favDrugs = favDrugs.filter(d =>
                    d.tradeName.toLowerCase().includes(searchTerm) ||
                    d.scientificName.toLowerCase().includes(searchTerm)
                );
            }
            
            // Check if empty
            if (favPrescriptions.length === 0 && favDrugs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⭐</div>
                        <h3>لا توجد عناصر مفضلة</h3>
                        <p>أضف روشتات أو أدوية للمفضلة لتظهر هنا</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Section 1: Favorite Prescriptions
            if (favPrescriptions.length > 0) {
                html += `
                    <div style="grid-column: 1 / -1; margin-bottom: 15px;">
                        <h2 style="color: var(--primary); font-size: 1.5em; border-bottom: 3px solid var(--primary); padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span>📋</span>
                            <span>الروشتات المفضلة</span>
                            <span style="background: var(--primary); color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.8em;">${favPrescriptions.length}</span>
                        </h2>
                    </div>
                `;
                
                favPrescriptions.forEach(p => {
                    const cat = categories.find(c => c.id == p.categoryId);
                    const rxPreview = p.rx ? p.rx.substring(0, 100) + '...' : '';
                    html += `
                        <div class="prescription-card" onclick="closeFavoritesPopup(); viewPrescription(${p.id})" style="cursor: pointer;">
                            <h3 style="color: var(--primary);">💊 ${p.name}</h3>
                            <p style="color: var(--secondary); font-size: 0.9em;">📁 ${cat ? cat.name : 'غير مصنف'}</p>
                            <div style="color: var(--text-light); font-size: 0.85em; margin-top: 10px; line-height: 1.5;">${rxPreview}</div>
                        </div>
                    `;
                });
            }
            
            // Section 2: Favorite Drugs
            if (favDrugs.length > 0) {
                html += `
                    <div style="grid-column: 1 / -1; margin: 30px 0 15px 0;">
                        <h2 style="color: var(--primary); font-size: 1.5em; border-bottom: 3px solid var(--primary); padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                            <span>💊</span>
                            <span>الأدوية المفضلة</span>
                            <span style="background: var(--primary); color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.8em;">${favDrugs.length}</span>
                        </h2>
                    </div>
                `;
                
                favDrugs.forEach(drug => {
                    const category = drugCategories.find(c => c.id === drug.categoryId);
                    html += `
                        <div class="prescription-card" onclick="closeFavoritesPopup(); viewDrug(${drug.id})" style="cursor: pointer;">
                            <h3 style="color: var(--primary);">💊 ${drug.tradeName}</h3>
                            <p style="color: var(--text-light); font-size: 0.9em; margin-bottom: 5px;">🧪 ${drug.scientificName}</p>
                            <p style="color: var(--secondary); font-size: 0.85em;">📁 ${category ? category.name : 'غير مصنف'}</p>
                            ${drug.childDose ? `
                                <div style="background: var(--bg-main); padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 0.85em;">
                                    <strong style="color: var(--text-dark);">👶 جرعة الأطفال:</strong>
                                    <div style="color: var(--text-light); margin-top: 3px;">${drug.childDose.substring(0, 50)}${drug.childDose.length > 50 ? '...' : ''}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            grid.innerHTML = html;
        }
        
        // Drugs Popup
        let currentDrugCategoryPopup = 'all';
        
        function openDrugsPopup() {
            document.getElementById('drugsPopup').classList.add('active');
            disableScroll();
            renderDrugCategoriesPopup();
            renderDrugsPopup();
        }
        
        function closeDrugsPopup() {
            document.getElementById('drugsPopup').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        function renderDrugCategoriesPopup() {
            const list = document.getElementById('drugCategoriesPopupList');
            const categoryNames = {
                'all': 'كل الأدوية',
                'antibiotics': 'مضاد حيوي',
                'analgesics': 'مسكن',
                'antipyretics': 'خافض حرارة',
                'antihistamines': 'مضاد حساسية',
                'gastro': 'جهاز هضمي',
                'respiratory': 'جهاز تنفسي',
                'cardiovascular': 'قلب وأوعية',
                'diabetes': 'سكري',
                'other': 'أخرى'
            };
            
            let html = '';
            for (let cat in categoryNames) {
                const count = cat === 'all' ? drugs.length : drugs.filter(d => d.category === cat).length;
                const isActive = cat === currentDrugCategoryPopup;
                html += `
                    <div onclick="selectDrugCategoryPopup('${cat}')" style="padding: 10px 15px; background: var(--bg-card); border-radius: 8px; cursor: pointer; border: 2px solid ${isActive ? 'var(--primary)' : 'var(--border)'}; transition: all 0.2s;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-dark);">${categoryNames[cat]}</span>
                            <span style="background: ${isActive ? 'var(--primary)' : 'var(--border)'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">${count}</span>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
        }
        
        function selectDrugCategoryPopup(cat) {
            currentDrugCategoryPopup = cat;
            renderDrugCategoriesPopup();
            renderDrugsPopup();
        }
        
        function renderDrugsPopup() {
            const grid = document.getElementById('drugsPopupGrid');
            const searchTerm = document.getElementById('searchDrugsPopupInput').value.toLowerCase();
            
            let filtered = drugs;
            
            if (currentDrugCategoryPopup !== 'all') {
                filtered = filtered.filter(d => d.category === currentDrugCategoryPopup);
            }
            
            if (searchTerm) {
                filtered = filtered.filter(d =>
                    d.tradeName.toLowerCase().includes(searchTerm) ||
                    d.scientificName.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">💊</div><h3>لا توجد أدوية</h3></div>';
                return;
            }
            
            const categoryNames = {
                'antibiotics': 'مضاد حيوي',
                'analgesics': 'مسكن',
                'antipyretics': 'خافض حرارة',
                'antihistamines': 'مضاد حساسية',
                'gastro': 'جهاز هضمي',
                'respiratory': 'جهاز تنفسي',
                'cardiovascular': 'قلب وأوعية',
                'diabetes': 'سكري',
                'other': 'أخرى'
            };
            
            let html = '';
            filtered.forEach(drug => {
                html += `
                    <div class="prescription-card">
                        <h3 style="color: var(--primary);">💊 ${drug.tradeName}</h3>
                        <p style="color: var(--text-light); font-size: 0.9em;">🧪 ${drug.scientificName}</p>
                        <p style="color: var(--secondary); font-size: 0.85em;">📁 ${categoryNames[drug.category]}</p>
                        ${drug.childDose ? `<div style="background: var(--bg-main); padding: 10px; border-radius: 8px; margin: 10px 0;"><strong>👶 جرعة الأطفال:</strong><p style="margin-top: 5px;">${drug.childDose}</p></div>` : ''}
                        ${drug.adultDose ? `<div style="background: var(--bg-main); padding: 10px; border-radius: 8px; margin: 10px 0;"><strong>👨 جرعة الكبار:</strong><p style="margin-top: 5px;">${drug.adultDose}</p></div>` : ''}
                        <div class="prescription-actions-mini" onclick="event.stopPropagation();">
                            <button class="btn-icon btn-icon-edit" onclick="editDrug(${drug.id})" title="تعديل">✏️</button>
                            <button class="btn-icon btn-icon-delete" onclick="deleteDrug(${drug.id})" title="حذف">🗑️</button>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }
        
        // Notes Popup
        function openNotesPopup() {
            document.getElementById('notesPopup').classList.add('active');
            disableScroll();
            renderNotesPopup();
        }
        
        function closeNotesPopup() {
            document.getElementById('notesPopup').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        function renderNotesPopup() {
            console.log('🔄 renderNotesPopup called, notes count:', notes.length);
            const grid = document.getElementById('notesPopupGrid');
            
            if (!grid) {
                console.log('❌ notesPopupGrid not found!');
                return;
            }
            
            const searchInput = document.getElementById('searchNotesPopupInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            let filtered = notes;
            
            if (searchTerm) {
                filtered = filtered.filter(n =>
                    n.title.toLowerCase().includes(searchTerm) ||
                    n.content.toLowerCase().includes(searchTerm)
                );
            }
            
            console.log('📝 Filtered notes:', filtered.length);
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📝</div><h3>لا توجد ملاحظات</h3></div>';
                return;
            }
            
            let html = '';
            filtered.forEach(note => {
                const date = new Date(note.createdAt).toLocaleDateString('ar-EG');
                html += `
                    <div class="prescription-card" style="cursor: pointer;">
                        <h3 style="color: var(--primary);">📝 ${note.title}</h3>
                        <p style="color: var(--text-light); font-size: 0.9em; margin: 10px 0;">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</p>
                        <p style="color: var(--text-light); font-size: 0.8em; margin-bottom: 10px;">📅 ${date}</p>
                        <div class="prescription-actions-mini" onclick="event.stopPropagation();">
                            <button class="btn-icon btn-icon-edit" onclick="closeNotesPopup(); editNote(${note.id})" title="تعديل">✏️</button>
                            <button class="btn-icon btn-icon-delete" onclick="deleteNote(${note.id})" title="حذف">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            console.log('✅ Notes popup rendered successfully');
        }
        
        // Drug Functions
        function deleteDrug(drugId) {
            if (confirm('هل تريد حذف هذا الدواء؟')) {
                drugs = drugs.filter(d => d.id !== drugId);
                localStorage.setItem('drugs', JSON.stringify(drugs));
                renderDrugs();
                updateBadgeCounts();
                renderDrugCategories();
            }
        }
        

        // Drug Image Management
        let currentDrugImage = null;
        let currentDrugImageScale = 1;
        let currentDrugImagePosition = {x: 0, y: 0};
        
        function handleDrugImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentDrugImage = {
                        src: e.target.result,
                        scale: 1,
                        position: {x: 0, y: 0}
                    };
                    currentDrugImageScale = 1;
                    currentDrugImagePosition = {x: 0, y: 0};
                    
                    document.getElementById('drugImagePreview').style.display = 'block';
                    document.getElementById('drugImagePreviewImg').src = e.target.result;
                    document.getElementById('removeDrugImageBtn').style.display = 'inline-block';
                    
                    document.getElementById('drugImageScaleSlider').value = 100;
                    document.getElementById('drugImageXSlider').value = 0;
                    document.getElementById('drugImageYSlider').value = 0;
                    updateDrugImagePreview();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removeDrugImage() {
            currentDrugImage = null;
            document.getElementById('drugImagePreview').style.display = 'none';
            document.getElementById('drugImageInput').value = '';
            document.getElementById('removeDrugImageBtn').style.display = 'none';
        }
        
        function updateDrugImageScale(value) {
            currentDrugImageScale = value / 100;
            document.getElementById('drugImageScaleValue').textContent = value + '%';
            updateDrugImagePreview();
        }
        
        function updateDrugImagePosition() {
            const x = document.getElementById('drugImageXSlider').value;
            const y = document.getElementById('drugImageYSlider').value;
            currentDrugImagePosition = {x: parseInt(x), y: parseInt(y)};
            document.getElementById('drugImageXValue').textContent = x;
            document.getElementById('drugImageYValue').textContent = y;
            updateDrugImagePreview();
        }
        
        function updateDrugImagePreview() {
            const img = document.getElementById('drugImagePreviewImg');
            if (img && currentDrugImage) {
                currentDrugImage.scale = currentDrugImageScale;
                currentDrugImage.position = currentDrugImagePosition;
                img.style.transform = `scale(${currentDrugImageScale}) translate(${currentDrugImagePosition.x}px, ${currentDrugImagePosition.y}px)`;
            }
        }
        
        // Text Formatting
        function openDrugChildDoseTextEditor() {
            const controls = document.getElementById('drugChildDoseTextControls');
            controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
        }
        
        function openDrugAdultDoseTextEditor() {
            const controls = document.getElementById('drugAdultDoseTextControls');
            controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
        }
        
        function formatDrugChildDoseText(command, value = null) {
            document.getElementById('drugChildDoseEditor').focus();
            document.execCommand(command, false, value);
        }
        
        function formatDrugAdultDoseText(command, value = null) {
            document.getElementById('drugAdultDoseEditor').focus();
            document.execCommand(command, false, value);
        }
        
        // Drug CRUD
        function openAddDrugModal() {
            editingDrugId = null;
            currentDrugImage = null;
            currentDrugImageScale = 1;
            currentDrugImagePosition = {x: 0, y: 0};
            
            document.getElementById('drugModal').classList.add('active');
            disableScroll();
            
            document.getElementById('drugTradeNameInput').value = '';
            document.getElementById('drugScientificNameInput').value = '';
            document.getElementById('drugChildDoseEditor').innerHTML = '';
            document.getElementById('drugAdultDoseEditor').innerHTML = '';
            document.getElementById('drugNotesInput').value = '';
            document.getElementById('drugModalTitle').textContent = '💊 إضافة دواء جديد';
            
            document.getElementById('drugImagePreview').style.display = 'none';
            document.getElementById('removeDrugImageBtn').style.display = 'none';
            document.getElementById('drugChildDoseTextControls').style.display = 'none';
            document.getElementById('drugAdultDoseTextControls').style.display = 'none';
            
            // ✅ Update select options first
            updateDrugCategorySelect();
            
            // ✅ Then set the current category (if not 'all')
            if (currentDrugCategory && currentDrugCategory !== 'all') {
                document.getElementById('drugCategoryInput').value = currentDrugCategory;
            } else {
                document.getElementById('drugCategoryInput').value = '';
            }
        }
        
        function closeDrugModal() {
            document.getElementById('drugModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        function saveDrug(event) {
            event.preventDefault();
            
            const childDose = document.getElementById('drugChildDoseEditor').innerHTML;
            const adultDose = document.getElementById('drugAdultDoseEditor').innerHTML;
            
            const drug = {
                id: editingDrugId || Date.now(),
                tradeName: document.getElementById('drugTradeNameInput').value,
                scientificName: document.getElementById('drugScientificNameInput').value,
                categoryId: parseInt(document.getElementById('drugCategoryInput').value),
                childDose: childDose,
                adultDose: adultDose,
                notes: document.getElementById('drugNotesInput').value,
                image: currentDrugImage,
                createdAt: editingDrugId ? drugs.find(d => d.id === editingDrugId).createdAt : new Date().toISOString()
            };
            
            if (editingDrugId) {
                const index = drugs.findIndex(d => d.id === editingDrugId);
                drugs[index] = drug;
            } else {
                drugs.push(drug);
            }
            
            localStorage.setItem('drugs', JSON.stringify(drugs));
            closeDrugModal();
            renderDrugs();
            renderDrugCategories();
            updateBadgeCounts();
        }
        
        function editDrug(drugId) {
            const drug = drugs.find(d => d.id === drugId);
            if (!drug) return;
            
            editingDrugId = drugId;
            currentDrugImage = drug.image;
            currentDrugImageScale = drug.image ? drug.image.scale : 1;
            currentDrugImagePosition = drug.image ? drug.image.position : {x: 0, y: 0};
            
            document.getElementById('drugModal').classList.add('active');
            disableScroll();
            
            document.getElementById('drugTradeNameInput').value = drug.tradeName;
            document.getElementById('drugScientificNameInput').value = drug.scientificName;
            document.getElementById('drugChildDoseEditor').innerHTML = drug.childDose || '';
            document.getElementById('drugAdultDoseEditor').innerHTML = drug.adultDose || '';
            document.getElementById('drugNotesInput').value = drug.notes || '';
            document.getElementById('drugModalTitle').textContent = '✏️ تعديل دواء';
            
            if (drug.image) {
                document.getElementById('drugImagePreview').style.display = 'block';
                document.getElementById('drugImagePreviewImg').src = drug.image.src;
                document.getElementById('removeDrugImageBtn').style.display = 'inline-block';
                document.getElementById('drugImageScaleSlider').value = (drug.image.scale || 1) * 100;
                document.getElementById('drugImageXSlider').value = drug.image.position.x || 0;
                document.getElementById('drugImageYSlider').value = drug.image.position.y || 0;
                updateDrugImagePreview();
            } else {
                document.getElementById('drugImagePreview').style.display = 'none';
                document.getElementById('removeDrugImageBtn').style.display = 'none';
            }
            
            // ✅ Update select options FIRST
            updateDrugCategorySelect();
            
            // ✅ THEN set the value with a small delay to ensure DOM is ready
            setTimeout(() => {
                document.getElementById('drugCategoryInput').value = drug.categoryId;
            }, 50);
        }
        
        function renderDrugs() {
            const grid = document.getElementById('prescriptionsGrid');
            if (!grid) return;
            
            const searchTerm = document.getElementById('searchDrugsInput').value.toLowerCase();
            
            let filteredDrugs = drugs;
            
            if (currentDrugCategory !== 'all') {
                filteredDrugs = filteredDrugs.filter(d => d.categoryId === currentDrugCategory);
            }
            
            if (searchTerm) {
                filteredDrugs = filteredDrugs.filter(d =>
                    d.tradeName.toLowerCase().includes(searchTerm) ||
                    d.scientificName.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredDrugs.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💊</div>
                        <h3>لا توجد أدوية</h3>
                        <p>ابدأ بإضافة دواء جديد</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredDrugs.forEach(drug => {
                const category = drugCategories.find(c => c.id === drug.categoryId);
                const imageHtml = drug.image ? `
                    <img src="${drug.image.src}" 
                         style="max-width: 100%; border-radius: 8px; margin-bottom: 15px; transform: scale(${drug.image.scale || 1}) translate(${drug.image.position.x || 0}px, ${drug.image.position.y || 0}px);" 
                         alt="صورة الدواء">
                ` : '';
                
                const favoriteIcon = drug.isFavorite ? '⭐' : '☆';
                
                // Create preview text (max 80 characters)
                let previewText = '';
                if (drug.childDose) {
                    previewText = drug.childDose.substring(0, 80) + (drug.childDose.length > 80 ? '...' : '');
                } else if (drug.adultDose) {
                    previewText = drug.adultDose.substring(0, 80) + (drug.adultDose.length > 80 ? '...' : '');
                } else if (drug.notes) {
                    previewText = drug.notes.substring(0, 80) + (drug.notes.length > 80 ? '...' : '');
                }
                
                html += `
                    <div class="prescription-card" onclick="viewDrug(${drug.id})" style="cursor: pointer;">
                        ${imageHtml}
                        <h3 style="color: var(--primary);">💊 ${drug.tradeName}</h3>
                        <p style="color: var(--text-light); font-size: 0.9em; margin-bottom: 5px;">🧪 ${drug.scientificName}</p>
                        <p style="color: var(--secondary); font-size: 0.85em; margin-bottom: 10px;">📁 ${category ? category.name : 'غير مصنف'}</p>
                        
                        ${previewText ? `
                            <div class="prescription-preview" style="color: var(--text-light); font-size: 0.85em; line-height: 1.5; margin-top: 10px; padding: 8px; background: var(--bg-main); border-radius: 6px;">
                                ${previewText}
                            </div>
                        ` : ''}
                        
                        <div class="prescription-actions-mini" onclick="event.stopPropagation();">
                            <button class="btn-icon ${drug.isFavorite ? 'btn-icon-favorite' : ''}" onclick="toggleDrugFavorite(${drug.id})" title="${drug.isFavorite ? 'إزالة من المفضلة' : 'إضافة للمفضلة'}">${favoriteIcon}</button>
                            <button class="btn-icon btn-icon-edit" onclick="editDrug(${drug.id})" title="تعديل">✏️</button>
                            <button class="btn-icon btn-icon-delete" onclick="deleteDrug(${drug.id})" title="حذف">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function deleteDrug(drugId) {
            if (confirm('هل تريد حذف هذا الدواء؟')) {
                drugs = drugs.filter(d => d.id !== drugId);
                localStorage.setItem('drugs', JSON.stringify(drugs));
                renderDrugs();
                updateBadgeCounts();
                renderDrugCategories();
            }
        }
        
        function viewDrug(drugId) {
            // 🔥 CRITICAL: Remove old drug modals FIRST to prevent stacking
            const oldDrugModal = document.getElementById('viewDrugModal');
            if (oldDrugModal) {
                oldDrugModal.remove();
            }
            
            // Close ALL other open modals
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            ensureScrollEnabled();
            
            const drug = drugs.find(d => d.id === drugId);
            if (!drug) return;
            
            const category = drugCategories.find(c => c.id === drug.categoryId);
            
            const imageHtml = drug.image ? `
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="${drug.image.src}" 
                         style="max-width: 100%; border-radius: 12px; transform: scale(${drug.image.scale || 1}) translate(${drug.image.position.x || 0}px, ${drug.image.position.y || 0}px);" 
                         alt="صورة الدواء">
                </div>
            ` : '';
            
            const childDoseHtml = drug.childDose ? `
                <div style="background: var(--bg-main); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">👶 جرعة الأطفال:</h4>
                    <div style="color: var(--text-dark); line-height: 1.6; white-space: pre-wrap;">${drug.childDose}</div>
                </div>
            ` : '';
            
            const adultDoseHtml = drug.adultDose ? `
                <div style="background: var(--bg-main); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">👨 جرعة الكبار:</h4>
                    <div style="color: var(--text-dark); line-height: 1.6; white-space: pre-wrap;">${drug.adultDose}</div>
                </div>
            ` : '';
            
            const notesHtml = drug.notes ? `
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">📝 ملاحظات:</h4>
                    <div style="color: var(--text-dark); line-height: 1.6; white-space: pre-wrap;">${drug.notes}</div>
                </div>
            ` : '';
            
            const modalContent = `
                <div class="modal active view-drug-modal" id="viewDrugModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>💊 ${drug.tradeName}</h2>
                            <button class="close-modal" onclick="closeViewDrugModal()">×</button>
                        </div>
                        <div style="padding: 20px;">
                            ${imageHtml}
                            
                            <div style="margin-bottom: 20px;">
                                <p style="color: var(--text-light); font-size: 1.1em; margin-bottom: 10px;">
                                    <strong>🧪 الاسم العلمي:</strong> ${drug.scientificName}
                                </p>
                                <p style="color: var(--secondary); font-size: 1em;">
                                    <strong>📁 الفئة:</strong> ${category ? category.name : 'غير مصنف'}
                                </p>
                            </div>
                            
                            ${childDoseHtml}
                            ${adultDoseHtml}
                            ${notesHtml}
                            
                            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                                <button class="btn-primary" onclick="exportDrugPDF(${drug.id})">
                                    📄 استخراج PDF
                                </button>
                                <button class="btn-primary" onclick="closeViewDrugModal(); editDrug(${drug.id})">
                                    ✏️ تعديل
                                </button>
                                <button class="btn-secondary" onclick="closeViewDrugModal()">
                                    إغلاق
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add new modal (old one already removed at start)
            document.body.insertAdjacentHTML('beforeend', modalContent);
            disableScroll();
        }
        
        function closeViewDrugModal() {
            const modal = document.getElementById('viewDrugModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
            ensureScrollEnabled();
        }
        
        function toggleDrugFavorite(drugId) {
            const drug = drugs.find(d => d.id === drugId);
            if (drug) {
                drug.isFavorite = !drug.isFavorite;
                localStorage.setItem('drugs', JSON.stringify(drugs));
                renderDrugs();
                updateBadgeCounts();
            }
        }
        
        async function exportDrugPDF(drugId) {
            const drug = drugs.find(d => d.id === drugId);
            if (!drug) return;
            
            const category = drugCategories.find(c => c.id === drug.categoryId);
            
            // Wait for libraries to load
            if (typeof window.jspdf === 'undefined' || typeof html2canvas === 'undefined') {
                alert('جاري تحميل المكتبة... حاول مرة أخرى بعد ثانية');
                return;
            }
            
            try {
                // Create a temporary container for PDF content
                const container = document.createElement('div');
                container.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 190mm; padding: 20px; background: white; font-family: Cairo, Arial; direction: rtl;';
                
                // Build HTML content with exact formatting
                let html = `
                    <div style="text-align: center; margin-bottom: 30px; direction: rtl;">
                        <h1 style="color: #10b981; font-size: 28px; margin-bottom: 10px; font-family: Cairo, Arial;">💊 ${drug.tradeName}</h1>
                        <p style="color: #666; font-size: 18px; font-family: Cairo, Arial; margin-bottom: 5px;">🧪 ${drug.scientificName}</p>
                        ${category ? `<p style="color: #999; font-size: 16px; font-family: Cairo, Arial;">📁 الفئة: ${category.name}</p>` : ''}
                    </div>
                `;
                
                // Add image if exists
                if (drug.image) {
                    html += `
                        <div style="margin-bottom: 25px; direction: rtl; text-align: center;">
                            <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">📷 صورة الدواء</h2>
                            <img src="${drug.image.src}" style="max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px; transform: scale(${drug.image.scale || 1}) translate(${drug.image.position.x || 0}px, ${drug.image.position.y || 0}px);">
                        </div>
                    `;
                }
                
                // Child dose
                if (drug.childDose) {
                    html += `
                        <div style="margin-bottom: 25px; direction: rtl;">
                            <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">👶 جرعة الأطفال</h2>
                            <div style="font-size: 16px; line-height: 1.8; text-align: right; direction: rtl; font-family: Cairo, Arial; padding: 10px; background: #f9f9f9; border-radius: 8px; white-space: pre-wrap;">${drug.childDose}</div>
                        </div>
                    `;
                }
                
                // Adult dose
                if (drug.adultDose) {
                    html += `
                        <div style="margin-bottom: 25px; direction: rtl;">
                            <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">👨 جرعة الكبار</h2>
                            <div style="font-size: 16px; line-height: 1.8; text-align: right; direction: rtl; font-family: Cairo, Arial; padding: 10px; background: #f9f9f9; border-radius: 8px; white-space: pre-wrap;">${drug.adultDose}</div>
                        </div>
                    `;
                }
                
                // Notes
                if (drug.notes) {
                    html += `
                        <div style="margin-bottom: 25px; direction: rtl;">
                            <h2 style="color: #10b981; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #10b981; padding-bottom: 8px; font-family: Cairo, Arial; text-align: right;">📝 ملاحظات</h2>
                            <div style="font-size: 16px; line-height: 1.8; text-align: right; direction: rtl; font-family: Cairo, Arial; padding: 10px; background: #f9f9f9; border-radius: 8px; white-space: pre-wrap;">${drug.notes}</div>
                        </div>
                    `;
                }
                
                // Footer
                const date = new Date().toLocaleDateString('ar-EG');
                html += `
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0; text-align: center; direction: rtl;">
                        <p style="color: #999; font-size: 14px; font-family: Cairo, Arial;">تاريخ الطباعة: ${date}</p>
                        <p style="color: #10b981; font-size: 16px; font-family: Cairo, Arial; margin-top: 10px;">${appName}</p>
                    </div>
                `;
                
                container.innerHTML = html;
                document.body.appendChild(container);
                
                // Wait for images to load
                const images = container.querySelectorAll('img');
                await Promise.all(Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    });
                }));
                
                // Convert to canvas with high quality
                const canvas = await html2canvas(container, {
                    scale: 3,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    windowWidth: container.scrollWidth,
                    windowHeight: container.scrollHeight
                });
                
                // Remove temporary container
                document.body.removeChild(container);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png');
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const pageHeight = 297; // A4 height in mm
                
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let heightLeft = imgHeight;
                let position = 0;
                
                // Add first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                // Add additional pages if needed
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Save
                pdf.save(`drug-${drug.tradeName}-${Date.now()}.pdf`);
            } catch (error) {
                console.error('PDF export error:', error);
                alert('حدث خطأ أثناء تصدير PDF. تأكد من اتصالك بالإنترنت.');
            }
        }
        
        // Drug Category Management Functions
        function openAddDrugCategoryModal() {
            editingDrugCategoryId = null;
            document.getElementById('drugCategoryModal').classList.add('active');
            disableScroll();
            document.getElementById('drugCategoryNameInput').value = '';
            document.getElementById('drugCategoryDescInput').value = '';
            document.getElementById('drugCategoryModalTitle').textContent = 'إضافة فئة أدوية جديدة';
        }
        
        function closeDrugCategoryModal() {
            document.getElementById('drugCategoryModal').classList.remove('active');
            document.body.classList.remove('modal-open');
        }
        
        function saveDrugCategory(event) {
            event.preventDefault();
            
            const category = {
                id: editingDrugCategoryId || Date.now(),
                name: document.getElementById('drugCategoryNameInput').value,
                description: document.getElementById('drugCategoryDescInput').value || '',
                createdAt: editingDrugCategoryId ? drugCategories.find(c => c.id === editingDrugCategoryId).createdAt : new Date().toISOString()
            };
            
            if (editingDrugCategoryId) {
                const index = drugCategories.findIndex(c => c.id === editingDrugCategoryId);
                drugCategories[index] = category;
            } else {
                drugCategories.push(category);
            }
            
            localStorage.setItem('drugCategories', JSON.stringify(drugCategories));
            closeDrugCategoryModal();
            renderDrugCategories();
            updateDrugCategorySelect();
        }
        
        function renderDrugCategories() {
            const list = document.getElementById('drugCategoryList');
            if (!list) return;
            
            const categoryCounts = {};
            drugCategories.forEach(cat => {
                categoryCounts[cat.id] = drugs.filter(d => d.categoryId === cat.id).length;
            });
            
            let html = `
                <div class="category-item ${currentDrugCategory === 'all' ? 'active' : ''}" data-drug-category="all" onclick="selectDrugCategory('all')">
                    <div class="category-item-content">
                        <span>💊 كل الأدوية</span>
                        <span class="category-count">${drugs.length}</span>
                    </div>
                </div>
            `;
            
            drugCategories.forEach(cat => {
                const isActive = currentDrugCategory === cat.id;
                html += `
                    <div class="category-item ${isActive ? 'active' : ''}" data-drug-category="${cat.id}" onclick="selectDrugCategory(${cat.id})">
                        <div class="category-item-content">
                            <span>💊 ${cat.name}</span>
                            <span class="category-count">${categoryCounts[cat.id] || 0}</span>
                        </div>
                        <div class="category-actions" onclick="event.stopPropagation();">
                            <button onclick="showFoldersSoon()" title="المجلدات (قريباً)" style="background: #8b5cf6;">📂</button>
                            <button onclick="editDrugCategory(${cat.id})" title="تعديل">✏️</button>
                            <button onclick="deleteDrugCategory(${cat.id})" title="حذف">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        function selectDrugCategory(categoryId) {
            currentDrugCategory = categoryId;
            renderDrugCategories();
            renderDrugs();
        }
        
        function editDrugCategory(categoryId) {
            const category = drugCategories.find(c => c.id === categoryId);
            if (!category) return;
            
            editingDrugCategoryId = categoryId;
            document.getElementById('drugCategoryNameInput').value = category.name;
            document.getElementById('drugCategoryDescInput').value = category.description || '';
            document.getElementById('drugCategoryModalTitle').textContent = 'تعديل فئة الأدوية';
            
            document.getElementById('drugCategoryModal').classList.add('active');
            disableScroll();
        }
        
        function deleteDrugCategory(categoryId) {
            const drugsInCategory = drugs.filter(d => d.categoryId === categoryId);
            if (drugsInCategory.length > 0) {
                alert(`لا يمكن حذف الفئة لأنها تحتوي على ${drugsInCategory.length} دواء`);
                return;
            }
            
            if (confirm('هل تريد حذف هذه الفئة؟')) {
                drugCategories = drugCategories.filter(c => c.id !== categoryId);
                localStorage.setItem('drugCategories', JSON.stringify(drugCategories));
                if (currentDrugCategory === categoryId) {
                    currentDrugCategory = 'all';
                }
                renderDrugCategories();
                updateDrugCategorySelect();
            }
        }
        
        function refreshDrugCategories() {
            renderDrugCategories();
            renderDrugs();
        }
        
        function updateDrugCategorySelect() {
            const select = document.getElementById('drugCategoryInput');
            if (!select) return;
            
            select.innerHTML = '<option value="">اختر الفئة...</option>';
            drugCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
    </script>
</body>
</html>
